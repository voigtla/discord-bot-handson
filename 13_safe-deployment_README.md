# 第13回：deploy.sh を安全に叩く順番を作る

「修正したから deploy.sh を叩く」
── それで事故が起きていないのは、**たまたま**です。

この回では、**deploy.sh を“作り直す”のではなく**、
**「どの順番で何をやると安全か」を体で理解**します。

---

## 📌 この回の目標

* deploy.sh が何をしているか説明できる
* **危険な順番**と**安全な順番**を見分けられる
* 失敗しても戻れるデプロイ手順を持つ

**💡 この回の約束**

* 新しいツールは入れない
* CI/CD はやらない
* 「完璧な自動化」は目指さない

👉 **人間が判断できるデプロイ**を作る回です。

---

## 🎯 完成イメージ

```
【ダメなデプロイ】
ssh
git pull
pm2 restart
祈る

【この回のゴール】
ssh
状況確認
バックアップ
git pull
ビルド/依存確認
起動テスト
pm2 reload
ログ確認
```

**ポイント：**

* 「再起動」が最後
* 「確認」が途中に何度も入る
* 途中で止めても壊れない

---

## 第1章：deploy.sh が怖くなる理由（10分）

### 1-1. よくある deploy.sh（実例）

```bash
#!/bin/bash
git pull
npm install
pm2 restart discord-bot
```

**一見、問題なさそうに見えます。**

でも実際には：

* git pull で **壊れたコード**が来るかもしれない
* npm install で **依存関係が変わる**かもしれない
* pm2 restart で **一瞬止まる**

👉 しかも **途中で失敗すると状態が中途半端**。

---

### 1-2. 「deploy.sh が悪い」のではない

重要なのはここです。

> deploy.sh が危険なのではない
> **中身を理解せずに叩くのが危険**

この回では：

* 自動化をやめる ❌
* 手動に戻る ❌

ではなく、

> **「どこが危険か分かったうえで使う」**

を目指します。

---

## 第2章：デプロイの流れを分解する（15分）

### 2-1. デプロイは4つのフェーズに分かれる

```text
① 状況確認フェーズ
② 変更取得フェーズ
③ 動作確認フェーズ
④ 反映フェーズ
```

deploy.sh は、この4つをごちゃ混ぜにしていることが多いです。

---

### 2-2. 各フェーズで「やるべきこと」

#### ① 状況確認フェーズ（いきなり何もしない）

```bash
pwd
git status
pm2 status
```

**ここで見ること**

* 想定のディレクトリにいるか
* 未コミットの変更がないか
* Bot は今どう動いているか

👉 **ここで違和感があったら止める**

---

#### ② 変更取得フェーズ（まだ再起動しない）

```bash
git pull
npm install
```

**ポイント**

* ここでは Bot を止めない
* 失敗しても「まだ現状は生きている」

---

#### ③ 動作確認フェーズ（いきなり本番に反映しない）

```bash
node index.js
```

**やること**

* エラーが出ないか確認
* 環境変数が足りているか確認
* 起動ログを見る

👉 **ここで Ctrl+C で止めてOK**

---

#### ④ 反映フェーズ（最後に pm2）

```bash
pm2 reload discord-bot
pm2 logs discord-bot
```

**ポイント**

* restart ではなく reload（可能なら）
* すぐログを見る

---

## 第3章：deploy.sh を「安全な順番」に書き換える（20分）

### 3-1. 今ある deploy.sh を開く

```bash
nano deploy.sh
```

または VS Code で開いても OK。

---

### 3-2. 危険な例（やらない）

```bash
git pull
npm install
pm2 restart discord-bot
```

**なぜダメ？**

* 途中で失敗すると戻れない
* 状況確認がない
* 失敗箇所が分からない

---

### 3-3. この回で作る deploy.sh（例）

```bash
#!/bin/bash
set -e

echo "=== デプロイ開始 ==="

echo "【1】現在位置確認"
pwd

echo "【2】Git状態確認"
git status

echo "【3】変更取得"
git pull

echo "【4】依存関係確認"
npm install

echo "【5】起動テスト（本番反映前）"
node index.js &
sleep 5
kill $!

echo "【6】PM2 reload"
pm2 reload discord-bot

echo "【7】ログ確認"
pm2 logs discord-bot --lines 20
```

---

### 3-4. この deploy.sh のポイント

* `set -e`
  → 途中で失敗したら **即停止**
* node index.js で **事前起動チェック**
* pm2 reload は **最後**

👉 **「壊す前に止まれる」構成**

---

## 第4章：失敗するデプロイをわざとやる（15分）

### 4-1. わざとエラーを仕込む

例：

* index.js に構文エラーを入れる
* 環境変数を1つ消す

---

### 4-2. deploy.sh を実行

```bash
./deploy.sh
```

**観察ポイント**

* どこで止まったか
* Bot は生きているか
* 本番に影響が出たか

👉 **「止まってくれてありがとう」状態が理想**

---

## 第5章：この回で持ち帰る判断基準（10分）

### 5-1. デプロイ前に自問する3つ

* これは **今** 本番に出す必要がある？
* 失敗したら **戻せる？**
* 今回の変更点を **説明できる？**

---

### 5-2. この回の結論

> **deploy.sh は魔法のボタンではない**
> **人間の判断を補助する道具**

---

## ✅ この回のチェックリスト

* [ ] deploy.sh の中身を説明できる
* [ ] 危険な順番が分かる
* [ ] pm2 を最後に触る理由が分かる
* [ ] 途中で止められる deploy.sh を作った
* [ ] 失敗しても Bot が生きている状態を作れた

---

## 🎓 この回で得たもの

* 本番を触る怖さが「制御可能な怖さ」になる
* deploy.sh を叩く前に考える癖
* 「直す」より「止める」判断

---

## 📝 次回予告

**第14回：本番で何か起きたとき、最初に見る場所を決める**

次は、
「Bot が動かない」「重い」「変な挙動」
そのとき **どこを見るか**をハンズオンで決めます。

ログを読めないと、判断はできません。
