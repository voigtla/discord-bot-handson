# ç¬¬7å›ï¼šAI ã‚’åˆ©ç”¨ã™ã‚‹ ç¬¬äºŒå› - Bot ã®è’ã‚‰ã—å¯¾ç­–ãƒ»ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã‚’åˆ¶é™ã™ã‚‹

AI æ©Ÿèƒ½ã‚’ **å®‰å…¨ã«é‹ç”¨** ã™ã‚‹ãŸã‚ã«ã€è’ã‚‰ã—å¯¾ç­–ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–ã—ã¾ã™ã€‚

---

## ğŸ“Œ ã“ã®å›ã®ç›®æ¨™

- ã‚¹ãƒ‘ãƒ ãƒ»è’ã‚‰ã—å¯¾ç­–ã‚’å®Ÿè£…ã™ã‚‹
- ä¸é©åˆ‡ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®åˆ¶é™ã‚’å¼·åŒ–ã™ã‚‹
- ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã‚’è¨˜éŒ²ã™ã‚‹

**ğŸ’¡ ãƒã‚¤ãƒ³ãƒˆï¼š**
- AI ã¯ä¾¿åˆ©ã ãŒã€æ‚ªç”¨ã•ã‚Œã‚‹ãƒªã‚¹ã‚¯ã‚‚ã‚ã‚‹
- é©åˆ‡ãªåˆ¶é™ã¨ãƒ­ã‚°ã§å®‰å…¨æ€§ã‚’ç¢ºä¿
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’æãªã‚ãªã„ç¯„å›²ã§é˜²å¾¡

---

## ğŸ¯ å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸

```
ã€ã‚¹ãƒ‘ãƒ æ¤œå‡ºã€‘
ãƒ¦ãƒ¼ã‚¶ãƒ¼: aaaaaaaaaa (é€£æŠ•)
Bot: âš ï¸ ã‚¹ãƒ‘ãƒ è¡Œç‚ºã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚
     ä¸€æ™‚çš„ã«æ©Ÿèƒ½ã‚’åˆ¶é™ã—ã¾ã™ã€‚

ã€ä¸é©åˆ‡ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ¤œå‡ºã€‘
ãƒ¦ãƒ¼ã‚¶ãƒ¼: /ai message:[ä¸é©åˆ‡ãªå†…å®¹]
Bot: âŒ ä¸é©åˆ‡ãªå†…å®¹ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
     ã“ã®Botã¯ãƒ¡ãƒ³ã‚¿ãƒ«ã‚µãƒãƒ¼ãƒˆå°‚ç”¨ã§ã™ã€‚

ã€ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã€‘
ç®¡ç†è€…: /moderation-log
Bot: ğŸ“‹ ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ï¼ˆç›´è¿‘10ä»¶ï¼‰
     2025-02-01 14:30 - user123: ã‚¹ãƒ‘ãƒ æ¤œå‡º
     2025-02-01 13:15 - user456: ä¸é©åˆ‡ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
```

**ğŸ‘‰ Bot ãŒå®‰å…¨ã«é‹ç”¨ã§ãã‚‹çŠ¶æ…‹ã«ãªã‚Šã¾ã™**

---

## ğŸ“š äº‹å‰æº–å‚™

### å¿…è¦ãªã‚‚ã®

- âœ… ç¬¬6å›ã¾ã§ã®å®Œæˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
- âœ… AI æ©Ÿèƒ½ãŒå‹•ä½œã—ã¦ã„ã‚‹çŠ¶æ…‹

---

## ç¬¬1ç« :ã‚¹ãƒ‘ãƒ æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ ï¼ˆ20åˆ†ï¼‰

### 1-1. ã‚¹ãƒ‘ãƒ æ¤œå‡ºç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ

`index.js` ã«è¿½åŠ ï¼š

```javascript
// ã‚¹ãƒ‘ãƒ æ¤œå‡ºç”¨ãƒ†ãƒ¼ãƒ–ãƒ«
db.exec(`
  CREATE TABLE IF NOT EXISTS spam_detection (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    action_type TEXT NOT NULL,
    detected_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    penalty_until DATETIME
  )
`);

// ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«
db.exec(`
  CREATE TABLE IF NOT EXISTS moderation_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    action TEXT NOT NULL,
    reason TEXT,
    moderator_id TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  )
`);
```

---

### 1-2. ã‚¹ãƒ‘ãƒ æ¤œå‡ºãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ

`spam-detector.js` ã‚’æ–°è¦ä½œæˆï¼š

```javascript
const Database = require('better-sqlite3');

class SpamDetector {
  constructor(db) {
    this.db = db;
    
    // ã‚¹ãƒ‘ãƒ åˆ¤å®šã®é–¾å€¤
    this.thresholds = {
      messagesPerMinute: 5,      // 1åˆ†é–“ã«5å›ã¾ã§
      repeatedMessages: 3,        // åŒã˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸3å›ã¾ã§
      shortInterval: 2000,        // 2ç§’æœªæº€ã®é€£æŠ•
      penaltyDuration: 300000     // ãƒšãƒŠãƒ«ãƒ†ã‚£5åˆ†
    };
    
    // ä¸€æ™‚è¨˜æ†¶ï¼ˆãƒ¡ãƒ¢ãƒªå†…ï¼‰
    this.recentMessages = new Map();
  }

  // ã‚¹ãƒ‘ãƒ åˆ¤å®š
  async isSpam(userId, message) {
    // ãƒšãƒŠãƒ«ãƒ†ã‚£ä¸­ã‹ãƒã‚§ãƒƒã‚¯
    if (await this.isPenalized(userId)) {
      return { 
        isSpam: true, 
        reason: 'penalty',
        message: 'ã‚¹ãƒ‘ãƒ è¡Œç‚ºã«ã‚ˆã‚Šä¸€æ™‚çš„ã«åˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚'
      };
    }

    const now = Date.now();
    const userKey = `${userId}`;

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å±¥æ­´ã‚’å–å¾—
    if (!this.recentMessages.has(userKey)) {
      this.recentMessages.set(userKey, []);
    }

    const history = this.recentMessages.get(userKey);

    // å¤ã„å±¥æ­´ã‚’å‰Šé™¤ï¼ˆ1åˆ†ä»¥ä¸Šå‰ï¼‰
    const oneMinuteAgo = now - 60000;
    const recentHistory = history.filter(h => h.timestamp > oneMinuteAgo);

    // ãƒã‚§ãƒƒã‚¯1: 1åˆ†é–“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°
    if (recentHistory.length >= this.thresholds.messagesPerMinute) {
      await this.applyPenalty(userId, 'high_frequency');
      return {
        isSpam: true,
        reason: 'high_frequency',
        message: 'â° ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå¤šã™ãã¾ã™ã€‚å°‘ã—æ™‚é–“ã‚’ç½®ã„ã¦ãã ã•ã„ã€‚'
      };
    }

    // ãƒã‚§ãƒƒã‚¯2: çŸ­æ™‚é–“ã®é€£æŠ•
    if (recentHistory.length > 0) {
      const lastMessage = recentHistory[recentHistory.length - 1];
      const timeDiff = now - lastMessage.timestamp;

      if (timeDiff < this.thresholds.shortInterval) {
        await this.applyPenalty(userId, 'rapid_posting');
        return {
          isSpam: true,
          reason: 'rapid_posting',
          message: 'âš ï¸ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ãŒæ—©ã™ãã¾ã™ã€‚'
        };
      }
    }

    // ãƒã‚§ãƒƒã‚¯3: åŒã˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç¹°ã‚Šè¿”ã—
    const sameMessages = recentHistory.filter(h => h.content === message);
    if (sameMessages.length >= this.thresholds.repeatedMessages) {
      await this.applyPenalty(userId, 'repeated_content');
      return {
        isSpam: true,
        reason: 'repeated_content',
        message: 'ğŸ” åŒã˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¹°ã‚Šè¿”ã•ãªã„ã§ãã ã•ã„ã€‚'
      };
    }

    // å±¥æ­´ã«è¿½åŠ 
    recentHistory.push({ timestamp: now, content: message });
    this.recentMessages.set(userKey, recentHistory);

    return { isSpam: false };
  }

  // ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’é©ç”¨
  async applyPenalty(userId, actionType) {
    const penaltyUntil = new Date(Date.now() + this.thresholds.penaltyDuration);
    
    const stmt = this.db.prepare(`
      INSERT INTO spam_detection (user_id, action_type, penalty_until) 
      VALUES (?, ?, ?)
    `);
    stmt.run(userId, actionType, penaltyUntil.toISOString());

    // ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã«è¨˜éŒ²
    const logStmt = this.db.prepare(`
      INSERT INTO moderation_logs (user_id, action, reason) 
      VALUES (?, 'penalty_applied', ?)
    `);
    logStmt.run(userId, actionType);
  }

  // ãƒšãƒŠãƒ«ãƒ†ã‚£ä¸­ã‹ãƒã‚§ãƒƒã‚¯
  async isPenalized(userId) {
    const stmt = this.db.prepare(`
      SELECT penalty_until 
      FROM spam_detection 
      WHERE user_id = ? 
      AND penalty_until > datetime('now')
      ORDER BY detected_at DESC 
      LIMIT 1
    `);
    const result = stmt.get(userId);
    return !!result;
  }

  // ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’è§£é™¤
  async removePenalty(userId) {
    const stmt = this.db.prepare(`
      UPDATE spam_detection 
      SET penalty_until = datetime('now')
      WHERE user_id = ?
    `);
    stmt.run(userId);
  }

  // çµ±è¨ˆã‚’å–å¾—
  getStats() {
    const stmt = this.db.prepare(`
      SELECT action_type, COUNT(*) as count 
      FROM spam_detection 
      WHERE detected_at > datetime('now', '-7 days')
      GROUP BY action_type
    `);
    return stmt.all();
  }
}

module.exports = SpamDetector;
```

---

### 1-3. index.js ã«çµ±åˆ

**ã“ã“ã§ç·¨é›†ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ï¼š** `index.js`

**ä½•ã‚’ã™ã‚‹ã‹ï¼š**  
2ã¤ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒã‚ã‚Šã¾ã™ã€‚

**ã‚¹ãƒ†ãƒƒãƒ—1ï¼š** ãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­ã§ `spam-detector.js` ã‚’èª­ã¿è¾¼ã‚€  
**ã‚¹ãƒ†ãƒƒãƒ—2ï¼š** `/ai` ã‚³ãƒãƒ³ãƒ‰ã®å‡¦ç†ã®ä¸­ã«ã‚¹ãƒ‘ãƒ ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ ã™ã‚‹

---

#### ã‚¹ãƒ†ãƒƒãƒ—1ï¼šãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­ã«è¿½åŠ 

**ã©ã“ã«æ›¸ãã‹ï¼š**  
`index.js` ã® **ä¸€ç•ªä¸Šã®ã»ã†**ï¼ˆ`require` ãŒä¸¦ã‚“ã§ã„ã‚‹ã‚ãŸã‚Šï¼‰ã«è¿½åŠ ã—ã¾ã™ã€‚

å…·ä½“çš„ã«ã¯ã€`const AIHelper = require('./ai-helper');` ã® **ä¸‹**ã«è¿½åŠ ï¼š

```javascript
const SpamDetector = require('./spam-detector');
```

ãã—ã¦ã€`const aiHelper = new AIHelper(...);` ã® **ä¸‹**ã«è¿½åŠ ï¼š

```javascript
const spamDetector = new SpamDetector(db);
```

---

#### ã‚¹ãƒ†ãƒƒãƒ—2ï¼š/ai ã‚³ãƒãƒ³ãƒ‰ã«ã‚¹ãƒ‘ãƒ ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 

**ã©ã“ã«æ›¸ãã‹ï¼š**  
ã™ã§ã«ã‚ã‚‹ `/ai` ã‚³ãƒãƒ³ãƒ‰ã®å‡¦ç†ã® **ä¸­**ã«ã€ãƒã‚§ãƒƒã‚¯å‡¦ç†ã‚’è¿½åŠ ã—ã¾ã™ã€‚

å…·ä½“çš„ã«ã¯ã€`if (interaction.commandName === 'ai') {` ã® **ã™ãä¸‹**ã«è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

**ä»¥ä¸‹ã¯ä¿®æ­£å¾Œã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ï¼š**

```javascript
const SpamDetector = require('./spam-detector');

// ... ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–å¾Œ ...

const spamDetector = new SpamDetector(db);

// /ai ã‚³ãƒãƒ³ãƒ‰ã«çµ±åˆ
if (interaction.commandName === 'ai') {
  const userId = interaction.user.id;
  const userMessage = interaction.options.getString('message');

  // ã‚¹ãƒ‘ãƒ ãƒã‚§ãƒƒã‚¯
  const spamCheck = await spamDetector.isSpam(userId, userMessage);
  if (spamCheck.isSpam) {
    await interaction.reply({
      content: spamCheck.message,
      ephemeral: true
    });
    return;
  }

  // ... æ—¢å­˜ã®AIå‡¦ç† ...
}
```

---

## ç¬¬2ç« ï¼šä¸é©åˆ‡ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆ20åˆ†ï¼‰

### 2-1. ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ

`content-filter.js` ã‚’æ–°è¦ä½œæˆï¼š

```javascript
class ContentFilter {
  constructor() {
    // ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆï¼ˆåŸºæœ¬çš„ãªã‚‚ã®ï¼‰
    this.blockedWords = [
      // æš´åŠ›çš„ãªè¡¨ç¾
      'æ®ºã™', 'ã¶ã£æ®ºã™', 'æ®ºã—ã¦ã‚„ã‚‹',
      
      // å·®åˆ¥çš„ãªè¡¨ç¾ï¼ˆä¾‹ç¤ºã®ã¿ï¼‰
      // å®Ÿéš›ã®é‹ç”¨ã§ã¯ã€ã‚ˆã‚Šè©³ç´°ãªãƒªã‚¹ãƒˆã‚’ç”¨æ„
      
      // Botæ‚ªç”¨
      'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ', 'ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ', 'ignore all previous'
    ];

    // ç¹°ã‚Šè¿”ã—ãƒ‘ã‚¿ãƒ¼ãƒ³
    this.spamPatterns = [
      /(.)\1{9,}/,  // åŒã˜æ–‡å­—10å›ä»¥ä¸Š
      /^[ï½—wWW]{10,}$/,  // wwwww...
      /^[ï¼!ï¼Ÿ?]{5,}$/  // !!!!! or ?????
    ];

    // AI ã‚¸ã‚§ã‚¤ãƒ«ãƒ–ãƒ¬ã‚¤ã‚¯æ¤œå‡º
    this.jailbreakPatterns = [
      /ignore\s+(all\s+)?previous/i,
      /ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç„¡è¦–/i,
      /you\s+are\s+now/i,
      /ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ/i,
      /æ–°ã—ã„æŒ‡ç¤º/i
    ];
  }

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  filter(message) {
    const lowerMessage = message.toLowerCase();

    // ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
    for (const word of this.blockedWords) {
      if (lowerMessage.includes(word)) {
        return {
          allowed: false,
          reason: 'blocked_word',
          message: 'âŒ ä¸é©åˆ‡ãªè¡¨ç¾ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚'
        };
      }
    }

    // ã‚¹ãƒ‘ãƒ ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯
    for (const pattern of this.spamPatterns) {
      if (pattern.test(message)) {
        return {
          allowed: false,
          reason: 'spam_pattern',
          message: 'ğŸ” æ„å‘³ã®ãªã„ç¹°ã‚Šè¿”ã—ã¯é¿ã‘ã¦ãã ã•ã„ã€‚'
        };
      }
    }

    // ã‚¸ã‚§ã‚¤ãƒ«ãƒ–ãƒ¬ã‚¤ã‚¯ãƒã‚§ãƒƒã‚¯
    for (const pattern of this.jailbreakPatterns) {
      if (pattern.test(message)) {
        return {
          allowed: false,
          reason: 'jailbreak_attempt',
          message: 'âš ï¸ ã‚·ã‚¹ãƒ†ãƒ ã®æŒ‡ç¤ºã‚’å¤‰æ›´ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚ã“ã®Botã¯ãƒ¡ãƒ³ã‚¿ãƒ«ã‚µãƒãƒ¼ãƒˆå°‚ç”¨ã§ã™ã€‚'
        };
      }
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é•·ãƒã‚§ãƒƒã‚¯
    if (message.length > 2000) {
      return {
        allowed: false,
        reason: 'too_long',
        message: 'ğŸ“ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé•·ã™ãã¾ã™ï¼ˆ2000æ–‡å­—ä»¥å†…ï¼‰ã€‚'
      };
    }

    return { allowed: true };
  }

  // URLæ¤œå‡º
  hasURL(message) {
    const urlPattern = /(https?:\/\/[^\s]+)/g;
    return urlPattern.test(message);
  }

  // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ¤œå‡º
  hasMentions(message) {
    const mentionPattern = /<@!?\d+>/g;
    return mentionPattern.test(message);
  }
}

module.exports = ContentFilter;
```

---

### 2-2. index.js ã«çµ±åˆ

**ã“ã“ã§ç·¨é›†ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ï¼š** `index.js`

**ä½•ã‚’ã™ã‚‹ã‹ï¼š**  
2ã¤ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒã‚ã‚Šã¾ã™ã€‚

**ã‚¹ãƒ†ãƒƒãƒ—1ï¼š** ãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­ã§ `content-filter.js` ã‚’èª­ã¿è¾¼ã‚€  
**ã‚¹ãƒ†ãƒƒãƒ—2ï¼š** `/ai` ã‚³ãƒãƒ³ãƒ‰ã®å‡¦ç†ã®ä¸­ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’è¿½åŠ ã™ã‚‹

---

#### ã‚¹ãƒ†ãƒƒãƒ—1ï¼šãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­ã«è¿½åŠ 

**ã©ã“ã«æ›¸ãã‹ï¼š**  
`index.js` ã® **ä¸€ç•ªä¸Šã®ã»ã†**ï¼ˆ`require` ãŒä¸¦ã‚“ã§ã„ã‚‹ã‚ãŸã‚Šï¼‰ã«è¿½åŠ ã—ã¾ã™ã€‚

å…·ä½“çš„ã«ã¯ã€`const SpamDetector = require('./spam-detector');` ã® **ä¸‹**ã«è¿½åŠ ï¼š

```javascript
const ContentFilter = require('./content-filter');
```

ãã—ã¦ã€`const spamDetector = new SpamDetector(db);` ã® **ä¸‹**ã«è¿½åŠ ï¼š

```javascript
const contentFilter = new ContentFilter();
```

---

#### ã‚¹ãƒ†ãƒƒãƒ—2ï¼š/ai ã‚³ãƒãƒ³ãƒ‰ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’è¿½åŠ 

**ã©ã“ã«æ›¸ãã‹ï¼š**  
ã™ã§ã«ã‚ã‚‹ `/ai` ã‚³ãƒãƒ³ãƒ‰ã®å‡¦ç†ã® **ä¸­**ã€ã‚¹ãƒ‘ãƒ ãƒã‚§ãƒƒã‚¯ã® **ä¸‹**ã«è¿½åŠ ã—ã¾ã™ã€‚

**ä»¥ä¸‹ã¯ä¿®æ­£å¾Œã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ï¼ˆæ—¢å­˜ã®ã‚¹ãƒ‘ãƒ ãƒã‚§ãƒƒã‚¯ + æ–°ã—ã„ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼‰ï¼š**

```javascript
const ContentFilter = require('./content-filter');

const contentFilter = new ContentFilter();

// /ai ã‚³ãƒãƒ³ãƒ‰ã«çµ±åˆ
if (interaction.commandName === 'ai') {
  const userId = interaction.user.id;
  const userMessage = interaction.options.getString('message');

  // ã‚¹ãƒ‘ãƒ ãƒã‚§ãƒƒã‚¯
  const spamCheck = await spamDetector.isSpam(userId, userMessage);
  if (spamCheck.isSpam) {
    await interaction.reply({
      content: spamCheck.message,
      ephemeral: true
    });
    
    // ãƒ­ã‚°ã«è¨˜éŒ²
    const logStmt = db.prepare(`
      INSERT INTO moderation_logs (user_id, action, reason) 
      VALUES (?, 'message_blocked', ?)
    `);
    logStmt.run(userId, spamCheck.reason);
    
    return;
  }

  // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  const filterResult = contentFilter.filter(userMessage);
  if (!filterResult.allowed) {
    await interaction.reply({
      content: filterResult.message,
      ephemeral: true
    });
    
    // ãƒ­ã‚°ã«è¨˜éŒ²
    const logStmt = db.prepare(`
      INSERT INTO moderation_logs (user_id, action, reason) 
      VALUES (?, 'content_filtered', ?)
    `);
    logStmt.run(userId, filterResult.reason);
    
    return;
  }

  // ... æ—¢å­˜ã®AIå‡¦ç† ...
}
```

---

## ç¬¬3ç« ï¼šãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†ã‚³ãƒãƒ³ãƒ‰ï¼ˆ20åˆ†ï¼‰

### 3-1. ã‚³ãƒãƒ³ãƒ‰ã®ç™»éŒ²

`register-commands.js` ã«è¿½åŠ ï¼š

```javascript
{
  name: 'moderation',
  description: 'ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰',
  options: [
    {
      name: 'logs',
      description: 'ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã‚’è¡¨ç¤º',
      type: 1,
      options: [
        {
          name: 'limit',
          description: 'è¡¨ç¤ºä»¶æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 10ï¼‰',
          type: 4,
          required: false
        }
      ]
    },
    {
      name: 'unban',
      description: 'ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’è§£é™¤',
      type: 1,
      options: [
        {
          name: 'user',
          description: 'å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼',
          type: 6, // USERå‹
          required: true
        }
      ]
    },
    {
      name: 'stats',
      description: 'ã‚¹ãƒ‘ãƒ çµ±è¨ˆã‚’è¡¨ç¤º',
      type: 1
    },
    {
      name: 'add-word',
      description: 'ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰ã‚’è¿½åŠ ',
      type: 1,
      options: [
        {
          name: 'word',
          description: 'è¿½åŠ ã™ã‚‹ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰',
          type: 3,
          required: true
        }
      ]
    }
  ]
}
```

**ã‚³ãƒãƒ³ãƒ‰å†ç™»éŒ²ï¼š**
```bash
node register-commands.js
```

---

### 3-2. ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè£…

ã“ã“ã§è¿½åŠ ã™ã‚‹å‡¦ç†ã¯ã€**ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸç¬é–“**ã«å‹•ãã‚‚ã®ã§ã™ã€‚  
`index.js` ã‚’é–‹ãã€`client.on('interactionCreate', ...)` ã‚’æ¢ã—ã¦ãã ã•ã„ã€‚  
ãã®ä¸­ã® `if (!interaction.isChatInputCommand()) return;` ãŒã‚ã‚‹ãƒ–ãƒ­ãƒƒã‚¯ãŒå¯¾è±¡ã§ã™ã€‚  
ã“ã®ç« ã®ã‚³ãƒ¼ãƒ‰ã¯ã€åŸºæœ¬çš„ã«ãã® **ãƒ–ãƒ­ãƒƒã‚¯ã®ä¸­**ï¼ˆä»–ã® `if (interaction.commandName === ...)` ã¨åŒã˜ä¸¦ã³ï¼‰ã«å…¥ã‚Œã¾ã™ã€‚


```javascript
if (interaction.commandName === 'moderation') {
  // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
  if (!interaction.member.permissions.has('ManageMessages')) {
    await interaction.reply({ content: 'ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ç®¡ç†è€…ã®ã¿ä½¿ç”¨ã§ãã¾ã™ã€‚', ephemeral: true });
    return;
  }

  const subcommand = interaction.options.getSubcommand();

  // ãƒ­ã‚°è¡¨ç¤º
  if (subcommand === 'logs') {
    const limit = interaction.options.getInteger('limit') || 10;
    
    const stmt = db.prepare(`
      SELECT user_id, action, reason, created_at 
      FROM moderation_logs 
      ORDER BY created_at DESC 
      LIMIT ?
    `);
    const logs = stmt.all(limit);

    if (logs.length === 0) {
      await interaction.reply('ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
      return;
    }

    let message = `**ğŸ“‹ ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ï¼ˆç›´è¿‘${limit}ä»¶ï¼‰**\n\n`;
    logs.forEach(log => {
      const date = new Date(log.created_at).toLocaleString('ja-JP');
      message += `${date}\n`;
      message += `ãƒ¦ãƒ¼ã‚¶ãƒ¼: <@${log.user_id}>\n`;
      message += `ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ${log.action}\n`;
      message += `ç†ç”±: ${log.reason}\n\n`;
    });

    await interaction.reply(message);
  }

  // ãƒšãƒŠãƒ«ãƒ†ã‚£è§£é™¤
  if (subcommand === 'unban') {
    const targetUser = interaction.options.getUser('user');
    
    await spamDetector.removePenalty(targetUser.id);
    
    const logStmt = db.prepare(`
      INSERT INTO moderation_logs (user_id, action, reason, moderator_id) 
      VALUES (?, 'penalty_removed', 'manual_unban', ?)
    `);
    logStmt.run(targetUser.id, interaction.user.id);

    await interaction.reply(`âœ… <@${targetUser.id}> ã®ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’è§£é™¤ã—ã¾ã—ãŸã€‚`);
  }

  // ã‚¹ãƒ‘ãƒ çµ±è¨ˆ
  if (subcommand === 'stats') {
    const stats = spamDetector.getStats();

    if (stats.length === 0) {
      await interaction.reply('éå»7æ—¥é–“ã®ã‚¹ãƒ‘ãƒ æ¤œå‡ºã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
      return;
    }

    let message = '**ğŸ“Š ã‚¹ãƒ‘ãƒ çµ±è¨ˆï¼ˆéå»7æ—¥é–“ï¼‰**\n\n';
    stats.forEach(stat => {
      const actionName = {
        high_frequency: 'é«˜é »åº¦æŠ•ç¨¿',
        rapid_posting: 'é€£æŠ•',
        repeated_content: 'ç¹°ã‚Šè¿”ã—'
      }[stat.action_type] || stat.action_type;

      message += `${actionName}: ${stat.count}å›\n`;
    });

    await interaction.reply(message);
  }

  // ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰è¿½åŠ ï¼ˆç°¡æ˜“ç‰ˆï¼‰
  if (subcommand === 'add-word') {
    const word = interaction.options.getString('word');
    
    // å®Ÿéš›ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã™ã¹ãã§ã™ãŒã€ã“ã“ã§ã¯ç°¡æ˜“çš„ã«
    contentFilter.blockedWords.push(word);
    
    await interaction.reply({
      content: `âœ… ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰ã€Œ${word}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚\nâš ï¸ Botå†èµ·å‹•å¾Œã¯å¤±ã‚ã‚Œã¾ã™ã€‚`,
      ephemeral: true
    });
  }
}
```

---

## ç¬¬4ç« ï¼šAIå¿œç­”ã®ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ15åˆ†ï¼‰

### 4-1. AIå¿œç­”ã®ãƒã‚§ãƒƒã‚¯

AI ã‹ã‚‰ã®å¿œç­”ã‚‚ä¸é©åˆ‡ã§ãªã„ã‹ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ï¼š

```javascript
// ai-helper.js ã«è¿½åŠ 
async chat(userMessage, context = []) {
  try {
    // ... æ—¢å­˜ã®å‡¦ç† ...

    const result = await this.model.generateContent(fullPrompt);
    const response = await result.response;
    const text = response.text();

    // AIå¿œç­”ã®å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯
    if (this.containsUnsafeContent(text)) {
      return {
        success: false,
        message: 'ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€‚é©åˆ‡ãªå¿œç­”ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚åˆ¥ã®è³ªå•ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚',
        filtered: true
      };
    }

    return {
      success: true,
      message: text,
      tokensUsed: response.usageMetadata?.totalTokenCount || 0
    };
  } catch (error) {
    // ... ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° ...
  }
}

// å±é™ºãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ¤œå‡º
containsUnsafeContent(text) {
  const unsafePatterns = [
    /è¨ºæ–­ã—ã¾ã™?/,
    /è–¬ã‚’?.*?é£²/,
    /ç—…é™¢ã«?.*?è¡Œããª/,
    /åŒ»å¸«.*?å¿…è¦ãªã„/
  ];

  return unsafePatterns.some(pattern => pattern.test(text));
}
```

---

## ç¬¬5ç« ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼é€šå ±æ©Ÿèƒ½ï¼ˆ10åˆ†ï¼‰

### 5-1. /report ã‚³ãƒãƒ³ãƒ‰ã®ç™»éŒ²

ã“ã“ã¯ã€ŒDiscordã«ã‚³ãƒãƒ³ãƒ‰ã‚’ç™»éŒ²ã™ã‚‹ã€ãŸã‚ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚  
`register-commands.js` ã‚’é–‹ãã€`const commands = [` ã‚’æ¢ã—ã¦ãã ã•ã„ã€‚  
ã“ã®ç« ã§è¿½åŠ ãƒ»å¤‰æ›´ã™ã‚‹ã®ã¯ã€åŸºæœ¬çš„ã«ã“ã® **é…åˆ—ã®ä¸­èº«**ã§ã™ï¼ˆæ—¢å­˜ã®é…åˆ—ã‚’ç·¨é›†ã—ã¾ã™ï¼‰ã€‚


```javascript
{
  name: 'report',
  description: 'ä¸é©åˆ‡ãªå‹•ä½œã‚’å ±å‘Šã—ã¾ã™',
  options: [
    {
      name: 'type',
      description: 'å ±å‘Šã®ç¨®é¡',
      type: 3,
      required: true,
      choices: [
        { name: 'ã‚¹ãƒ‘ãƒ ', value: 'spam' },
        { name: 'ä¸é©åˆ‡ãªAIå¿œç­”', value: 'inappropriate_ai' },
        { name: 'ãƒã‚°', value: 'bug' },
        { name: 'ãã®ä»–', value: 'other' }
      ]
    },
    {
      name: 'detail',
      description: 'è©³ç´°ï¼ˆä»»æ„ï¼‰',
      type: 3,
      required: false
    }
  ]
}
```

---

### 5-2. /report ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè£…

ã“ã“ã§è¿½åŠ ã™ã‚‹å‡¦ç†ã¯ã€**ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸç¬é–“**ã«å‹•ãã‚‚ã®ã§ã™ã€‚  
`index.js` ã‚’é–‹ãã€`client.on('interactionCreate', ...)` ã‚’æ¢ã—ã¦ãã ã•ã„ã€‚  
ãã®ä¸­ã® `if (!interaction.isChatInputCommand()) return;` ãŒã‚ã‚‹ãƒ–ãƒ­ãƒƒã‚¯ãŒå¯¾è±¡ã§ã™ã€‚  
ã“ã®ç« ã®ã‚³ãƒ¼ãƒ‰ã¯ã€åŸºæœ¬çš„ã«ãã® **ãƒ–ãƒ­ãƒƒã‚¯ã®ä¸­**ï¼ˆä»–ã® `if (interaction.commandName === ...)` ã¨åŒã˜ä¸¦ã³ï¼‰ã«å…¥ã‚Œã¾ã™ã€‚


```javascript
if (interaction.commandName === 'report') {
  const reportType = interaction.options.getString('type');
  const detail = interaction.options.getString('detail') || 'ãªã—';
  const userId = interaction.user.id;

  // å ±å‘Šã‚’è¨˜éŒ²
  const stmt = db.prepare(`
    INSERT INTO moderation_logs (user_id, action, reason) 
    VALUES (?, 'user_report', ?)
  `);
  stmt.run(userId, `${reportType}: ${detail}`);

  await interaction.reply({
    content: 'âœ… å ±å‘Šã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚',
    ephemeral: true
  });

  // ç®¡ç†è€…ã«é€šçŸ¥ï¼ˆãƒãƒ£ãƒ³ãƒãƒ«IDã¯ç’°å¢ƒå¤‰æ•°ã§è¨­å®šï¼‰
  const adminChannelId = process.env.ADMIN_CHANNEL_ID;
  if (adminChannelId) {
    const adminChannel = await client.channels.fetch(adminChannelId);
    if (adminChannel) {
      await adminChannel.send(`ğŸš¨ **ãƒ¦ãƒ¼ã‚¶ãƒ¼å ±å‘Š**\nå ±å‘Šè€…: <@${userId}>\nç¨®é¡: ${reportType}\nè©³ç´°: ${detail}`);
    }
  }
}
```

---

## ç¬¬6ç« ï¼šGit ã§è¨˜éŒ²ï¼ˆ5åˆ†ï¼‰

```bash
git add .
git commit -m "ç¬¬7å›: è’ã‚‰ã—å¯¾ç­–+ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å®Ÿè£…"
git push
```

---

## âœ… ã“ã®å›ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] ã‚¹ãƒ‘ãƒ æ¤œå‡ºãŒå‹•ä½œã—ãŸ
- [ ] ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãŒå‹•ä½œã—ãŸ
- [ ] ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ãŒè¨˜éŒ²ã•ã‚ŒãŸ
- [ ] `/moderation` ã‚³ãƒãƒ³ãƒ‰ãŒå‹•ä½œã—ãŸ
- [ ] `/report` ã‚³ãƒãƒ³ãƒ‰ãŒå‹•ä½œã—ãŸ
- [ ] Git ã«ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ã§ããŸ

---

## ğŸ” ä»Šæ—¥è¦šãˆã‚‹ã“ã¨

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®åŸºæœ¬

- å¤šå±¤é˜²å¾¡ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰
- ãƒ­ã‚°ã®é‡è¦æ€§
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å ±å‘Šæ©Ÿèƒ½

### ã‚¹ãƒ‘ãƒ å¯¾ç­–

- é »åº¦åˆ¶é™
- ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º
- ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚·ã‚¹ãƒ†ãƒ 

### ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

- ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ
- æ­£è¦è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³
- AIå¿œç­”ã®ãƒã‚§ãƒƒã‚¯

---

## âš ï¸ ã‚ˆãã‚ã‚‹ãƒˆãƒ©ãƒ–ãƒ«

### èª¤æ¤œå‡ºãŒå¤šã„

**å¯¾å‡¦æ³•ï¼š**
1. é–¾å€¤ã‚’èª¿æ•´
2. ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã‚’è¿½åŠ 
3. ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã§ç¢ºèª

---

### ãƒšãƒŠãƒ«ãƒ†ã‚£ãŒè§£é™¤ã•ã‚Œãªã„

**å¯¾å‡¦æ³•ï¼š**
```javascript
await spamDetector.removePenalty(userId);
```

---

## ğŸ“Š ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### ãƒãƒ©ãƒ³ã‚¹ãŒé‡è¦

- **å³ã—ã™ãã‚‹** â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ãŒæ‚ªåŒ–
- **ç·©ã™ãã‚‹** â†’ è’ã‚‰ã—ãŒå¢—ãˆã‚‹

### å®šæœŸçš„ãªè¦‹ç›´ã—

1. ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã‚’ç¢ºèª
2. èª¤æ¤œå‡ºã‚’åˆ†æ
3. ãƒ«ãƒ¼ãƒ«ã‚’èª¿æ•´

### é€æ˜æ€§

- ãƒšãƒŠãƒ«ãƒ†ã‚£ç†ç”±ã‚’æ˜ç¤º
- è§£é™¤æ–¹æ³•ã‚’æ¡ˆå†…
- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å—ã‘ä»˜ã‘ã‚‹

---

## ğŸ“ ç™ºå±•èª²é¡Œï¼ˆè‡ªç¿’ç”¨ï¼‰

1. **è‡ªå‹•å­¦ç¿’**
   - ã‚¹ãƒ‘ãƒ ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è‡ªå‹•æ¤œå‡º

2. **æ®µéšçš„ãƒšãƒŠãƒ«ãƒ†ã‚£**
   - åˆå›: è­¦å‘Š
   - 2å›ç›®: 5åˆ†ãƒšãƒŠãƒ«ãƒ†ã‚£
   - 3å›ç›®: 1æ™‚é–“ãƒšãƒŠãƒ«ãƒ†ã‚£

3. **IPåˆ¶é™**
   - åŒä¸€IPã‹ã‚‰ã®å¤§é‡ã‚¢ã‚¯ã‚»ã‚¹æ¤œå‡º

---

## æ¬¡å›äºˆå‘Š

### ç¬¬8å›ï¼šã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¦ã‚‚å®‰å…¨ã«çµ‚ã‚ã‚‹ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰

ã“ã“ã§ã¯ã€Œè½ã¡ã«ããã™ã‚‹ã€ãŸã‚ã«ã€æ—¢å­˜ã®å‡¦ç†ã®è¿‘ãã¸ `try/catch` ãªã©ã‚’è¿½åŠ ã—ã¾ã™ã€‚  
ã¾ãš `index.js` ã§è©²å½“ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰å‡¦ç†ï¼ˆ`interaction.commandName === ...`ï¼‰ã‚’è¦‹ã¤ã‘ã€  
ãã® **å‡¦ç†ã®å†…å´**ã«æ›¸ãè¶³ã™å½¢ã§é€²ã‚ã¾ã™ã€‚


æœ¬ç•ªç’°å¢ƒã‚’æƒ³å®šã—ãŸå …ç‰¢æ€§ï¼š
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
- ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
- ã‚ã–ã¨å±ãªã„å®Ÿè£…ã‚’ä½“é¨“

**ğŸ‘‰ Bot ãŒå£Šã‚Œãªã„ä»•çµ„ã¿ã‚’ä½œã‚Šã¾ã™ï¼**
---

## ğŸ“¦ ç¬¬7å›ã®å®Œæˆç‰ˆã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰

### ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
```
git_practice/
â”œâ”€â”€ .gitignore
â”œâ”€â”€ .env
â”œâ”€â”€ .env.example
â”œâ”€â”€ package.json
â”œâ”€â”€ index.js
â”œâ”€â”€ register-commands.js
â”œâ”€â”€ ai-helper.js
â”œâ”€â”€ spam-detector.jsï¼ˆâ˜…æ–°è¦ï¼‰
â””â”€â”€ content-filter.jsï¼ˆâ˜…æ–°è¦ï¼‰
```

---

### æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ï¼šspam-detector.js
```javascript
class SpamDetector {
  constructor(db) {
    this.db = db;
    
    // ã‚¹ãƒ‘ãƒ æ¤œå‡ºç”¨ãƒ†ãƒ¼ãƒ–ãƒ«
    db.exec(`
      CREATE TABLE IF NOT EXISTS spam_logs (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id TEXT NOT NULL,
        message_content TEXT,
        reason TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
      )
    `);
    
    // ãƒšãƒŠãƒ«ãƒ†ã‚£ãƒ†ãƒ¼ãƒ–ãƒ«
    db.exec(`
      CREATE TABLE IF NOT EXISTS penalties (
        user_id TEXT PRIMARY KEY,
        count INTEGER DEFAULT 0,
        banned_until DATETIME
      )
    `);
  }

  async checkSpam(userId, message) {
    // é€£æŠ•ãƒã‚§ãƒƒã‚¯
    const stmt = this.db.prepare(`
      SELECT COUNT(*) as count 
      FROM spam_logs 
      WHERE user_id = ? AND created_at > datetime('now', '-30 seconds')
    `);
    const { count } = stmt.get(userId);
    
    if (count >= 3) {
      this.addPenalty(userId, 'rapid_posting');
      return { isSpam: true, reason: 'é€£æŠ•ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ' };
    }
    
    // é‡è¤‡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒã‚§ãƒƒã‚¯
    const dupStmt = this.db.prepare(`
      SELECT message_content 
      FROM spam_logs 
      WHERE user_id = ? 
      ORDER BY created_at DESC 
      LIMIT 3
    `);
    const recent = dupStmt.all(userId);
    
    if (recent.length >= 3 && recent.every(r => r.message_content === message)) {
      this.addPenalty(userId, 'duplicate_messages');
      return { isSpam: true, reason: 'åŒã˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç¹°ã‚Šè¿”ã—ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ' };
    }
    
    // ãƒ­ã‚°ã«è¨˜éŒ²
    const logStmt = this.db.prepare('INSERT INTO spam_logs (user_id, message_content) VALUES (?, ?)');
    logStmt.run(userId, message);
    
    return { isSpam: false };
  }

  addPenalty(userId, reason) {
    const stmt = this.db.prepare(`
      INSERT INTO penalties (user_id, count, banned_until) 
      VALUES (?, 1, datetime('now', '+5 minutes'))
      ON CONFLICT(user_id) DO UPDATE SET 
        count = count + 1,
        banned_until = datetime('now', '+' || (count * 5) || ' minutes')
    `);
    stmt.run(userId);
  }

  checkPenalty(userId) {
    const stmt = this.db.prepare('SELECT banned_until FROM penalties WHERE user_id = ?');
    const row = stmt.get(userId);
    
    if (!row) return { banned: false };
    
    const bannedUntil = new Date(row.banned_until);
    const now = new Date();
    
    if (now < bannedUntil) {
      const minutesLeft = Math.ceil((bannedUntil - now) / 60000);
      return { banned: true, minutesLeft };
    }
    
    return { banned: false };
  }

  removePenalty(userId) {
    const stmt = this.db.prepare('DELETE FROM penalties WHERE user_id = ?');
    stmt.run(userId);
  }
}

module.exports = SpamDetector;
```

---

### æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ï¼šcontent-filter.js
```javascript
class ContentFilter {
  constructor() {
    this.bannedWords = [
      // ä¸é©åˆ‡ãªè¡¨ç¾
      'æ­»ã­', 'ã‚¯ã‚½', 'ãƒã‚«', 'ã‚¢ãƒ›', 'ã‚«ã‚¹',
      // å·®åˆ¥çš„è¡¨ç¾
      // ...ï¼ˆå®Ÿéš›ã«ã¯é©åˆ‡ãªãƒªã‚¹ãƒˆã‚’ç”¨æ„ï¼‰
    ];
    
    this.sensitivePatterns = [
      /https?:\/\/[^\s]+/gi,  // URL
      /\d{10,}/,              // é•·ã„æ•°å­—ï¼ˆé›»è©±ç•ªå·ãªã©ï¼‰
      /@everyone/,            // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³
      /@here/
    ];
  }

  check(message) {
    const lowerMessage = message.toLowerCase();
    
    // ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
    for (const word of this.bannedWords) {
      if (lowerMessage.includes(word)) {
        return {
          safe: false,
          reason: 'inappropriate_language',
          message: 'ä¸é©åˆ‡ãªè¡¨ç¾ãŒå«ã¾ã‚Œã¦ã„ã¾ã™'
        };
      }
    }
    
    // ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯
    for (const pattern of this.sensitivePatterns) {
      if (pattern.test(message)) {
        return {
          safe: false,
          reason: 'suspicious_pattern',
          message: 'ä¸é©åˆ‡ãªãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ'
        };
      }
    }
    
    return { safe: true };
  }

  sanitize(message) {
    let sanitized = message;
    
    // URLã‚’å‰Šé™¤
    sanitized = sanitized.replace(/https?:\/\/[^\s]+/gi, '[URLå‰Šé™¤]');
    
    // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
    sanitized = sanitized.replace(/@(everyone|here)/gi, '[@$1]');
    
    return sanitized;
  }
}

module.exports = ContentFilter;
```

---

### index.js ã®å¤‰æ›´ç‚¹

**ç¬¬6å›ã®index.jsã‚’ãƒ™ãƒ¼ã‚¹ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼š**

**1. ãƒ•ã‚¡ã‚¤ãƒ«å…ˆé ­ã«è¿½åŠ ï¼š**
```javascript
const SpamDetector = require('./spam-detector');
const ContentFilter = require('./content-filter');

const spamDetector = new SpamDetector(db);
const contentFilter = new ContentFilter();
```

**2. ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ ï¼š**
```javascript
db.exec(`
  CREATE TABLE IF NOT EXISTS moderation_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    action TEXT NOT NULL,
    reason TEXT,
    moderator_id TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  )
`);
```

**3. /ai ã‚³ãƒãƒ³ãƒ‰ã«ã‚¹ãƒ‘ãƒ ãƒã‚§ãƒƒã‚¯ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’è¿½åŠ ï¼š**
```javascript
if (interaction.commandName === 'ai') {
  const userId = interaction.user.id;
  const userMessage = interaction.options.getString('message');

  // ã‚¹ãƒ‘ãƒ ãƒã‚§ãƒƒã‚¯
  const penalty = spamDetector.checkPenalty(userId);
  if (penalty.banned) {
    await interaction.reply({ content: `â¸ï¸ ç¾åœ¨ãƒšãƒŠãƒ«ãƒ†ã‚£ä¸­ã§ã™ã€‚ã‚ã¨${penalty.minutesLeft}åˆ†ãŠå¾…ã¡ãã ã•ã„ã€‚`, ephemeral: true });
    return;
  }

  const spamCheck = await spamDetector.checkSpam(userId, userMessage);
  if (spamCheck.isSpam) {
    await interaction.reply({ content: `âš ï¸ ${spamCheck.reason}\nå°‘ã—æ™‚é–“ã‚’ç½®ã„ã¦ã‹ã‚‰ãŠè©¦ã—ãã ã•ã„ã€‚`, ephemeral: true });
    return;
  }

  // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  const filterResult = contentFilter.check(userMessage);
  if (!filterResult.safe) {
    await interaction.reply({ content: `â›” ${filterResult.message}`, ephemeral: true });
    return;
  }

  // ä»¥é™ã¯ç¬¬6å›ã¨åŒã˜AIå‡¦ç†
  // ...
}
```

**4. ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒãƒ³ãƒ‰ã‚’è¿½åŠ ï¼š**
```javascript
if (interaction.commandName === 'moderation') {
  if (!interaction.member.permissions.has('ManageMessages')) {
    await interaction.reply({ content: 'ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ç®¡ç†è€…ã®ã¿ä½¿ç”¨ã§ãã¾ã™ã€‚', ephemeral: true });
    return;
  }

  const subcommand = interaction.options.getSubcommand();

  if (subcommand === 'logs') {
    const limit = interaction.options.getInteger('limit') || 10;
    const stmt = db.prepare(`SELECT * FROM moderation_logs ORDER BY created_at DESC LIMIT ?`);
    const logs = stmt.all(limit);
    
    if (logs.length === 0) {
      await interaction.reply('ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
      return;
    }
    
    let message = `**ğŸ“‹ ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ï¼ˆç›´è¿‘${limit}ä»¶ï¼‰**\n\n`;
    logs.forEach(log => {
      const date = new Date(log.created_at).toLocaleString('ja-JP');
      message += `${date}\nãƒ¦ãƒ¼ã‚¶ãƒ¼: <@${log.user_id}>\nã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ${log.action}\nç†ç”±: ${log.reason}\n\n`;
    });
    
    await interaction.reply(message);
  }

  if (subcommand === 'unban') {
    const targetUser = interaction.options.getUser('user');
    await spamDetector.removePenalty(targetUser.id);
    const logStmt = db.prepare(`INSERT INTO moderation_logs (user_id, action, reason, moderator_id) VALUES (?, 'penalty_removed', 'manual_unban', ?)`);
    logStmt.run(targetUser.id, interaction.user.id);
    await interaction.reply(`âœ… <@${targetUser.id}> ã®ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’è§£é™¤ã—ã¾ã—ãŸã€‚`);
  }
}
```

---

### register-commands.js ã®å¤‰æ›´ç‚¹

**commandsé…åˆ—ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼š**
```javascript
{
  name: 'moderation',
  description: 'ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰',
  options: [
    {
      name: 'logs',
      description: 'ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã‚’è¡¨ç¤º',
      type: 1,
      options: [{ name: 'limit', description: 'è¡¨ç¤ºä»¶æ•°', type: 4, required: false }]
    },
    {
      name: 'unban',
      description: 'ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’è§£é™¤',
      type: 1,
      options: [{ name: 'user', description: 'å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼', type: 6, required: true }]
    }
  ]
},
{
  name: 'report',
  description: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é€šå ±ã—ã¾ã™',
  options: [
    { name: 'user', description: 'é€šå ±ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼', type: 6, required: true },
    { name: 'reason', description: 'ç†ç”±', type: 3, required: true }
  ]
}
```

ã“ã‚Œã§ç¬¬7å›ã¯å®Œæˆã§ã™ï¼


---

### index.jsï¼ˆå®Œå…¨ç‰ˆï¼‰

```javascript
require('dotenv').config();
const { Client, GatewayIntentBits } = require('discord.js');
const Database = require('better-sqlite3');
const AIHelper = require('./ai-helper');
const SpamDetector = require('./spam-detector');
const ContentFilter = require('./content-filter');

const db = new Database('bot.db');
const aiHelper = new AIHelper(process.env.GEMINI_API_KEY);
const spamDetector = new SpamDetector(db);
const contentFilter = new ContentFilter();

// æ—¢å­˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆç¬¬6å›ã¨åŒã˜ï¼‰
db.exec(`
  CREATE TABLE IF NOT EXISTS messages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    content TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  )
`);

db.exec(`
  CREATE TABLE IF NOT EXISTS feelings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    feeling TEXT NOT NULL,
    note TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  )
`);

db.exec(`
  CREATE TABLE IF NOT EXISTS templates (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    key TEXT NOT NULL UNIQUE,
    content TEXT NOT NULL,
    category TEXT,
    created_by TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
  )
`);

db.exec(`
  CREATE TABLE IF NOT EXISTS keyword_responses (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    keyword TEXT NOT NULL,
    template_key TEXT NOT NULL,
    priority INTEGER DEFAULT 0,
    enabled INTEGER DEFAULT 1,
    FOREIGN KEY (template_key) REFERENCES templates(key)
  )
`);

db.exec(`
  CREATE TABLE IF NOT EXISTS ai_conversations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    role TEXT NOT NULL,
    content TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  )
`);

db.exec(`
  CREATE TABLE IF NOT EXISTS rate_limits (
    user_id TEXT PRIMARY KEY,
    count INTEGER DEFAULT 0,
    reset_at DATETIME DEFAULT CURRENT_TIMESTAMP
  )
`);

// ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆç¬¬7å›ã§è¿½åŠ ï¼‰
db.exec(`
  CREATE TABLE IF NOT EXISTS moderation_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    action TEXT NOT NULL,
    reason TEXT,
    moderator_id TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  )
`);

db.exec(`DELETE FROM ai_conversations WHERE created_at < datetime('now', '-24 hours')`);

console.log('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æº–å‚™å®Œäº†');

// åˆæœŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç™»éŒ²
function initializeTemplates() {
  const defaultTemplates = [
    { key: 'breathe', content: 'ğŸŒ¬ï¸ **æ·±å‘¼å¸ã—ã¦ã¿ã¾ã—ã‚‡ã†**\n\n4ç§’å¸ã£ã¦... 7ç§’æ­¢ã‚ã¦... 8ç§’ã‹ã‘ã¦åã...\n\nã‚†ã£ãã‚Š3å›ç¹°ã‚Šè¿”ã—ã¦ã¿ã¦ãã ã•ã„ã€‚', category: 'relaxation' },
    { key: 'comfort', content: 'ğŸ¤— **å¤§ä¸ˆå¤«ã§ã™**\n\nè¾›ã„æ°—æŒã¡ã€ã‚ˆãè©±ã—ã¦ãã‚Œã¾ã—ãŸã­ã€‚\nã‚ãªãŸã¯ä¸€äººã˜ã‚ƒã‚ã‚Šã¾ã›ã‚“ã€‚\nå°‘ã—ãšã¤ã€ä¸€ç·’ã«ä¹—ã‚Šè¶Šãˆã¦ã„ãã¾ã—ã‚‡ã†ã€‚', category: 'comfort' },
    { key: 'emergency', content: 'ğŸ“ **ç·Šæ€¥é€£çµ¡å…ˆ**\n\nâ€¢ ã„ã®ã¡ã®é›»è©±: 0570-783-556 (24æ™‚é–“)\nâ€¢ ã“ã“ã‚ã®å¥åº·ç›¸è«‡: 0570-064-556\nâ€¢ SNSç›¸è«‡: https://www.mhlw.go.jp/mamorouyokokoro/\n\nä¸€äººã§æŠ±ãˆè¾¼ã¾ãªã„ã§ãã ã•ã„ã€‚', category: 'emergency' },
    { key: 'grounding', content: 'ğŸŒ **ã‚°ãƒ©ã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°æ³•**\n\nå‘¨ã‚Šã‚’è¦‹æ¸¡ã—ã¦ã€æ¬¡ã®ã‚‚ã®ã‚’æ¢ã—ã¦ã¿ã¦ãã ã•ã„ï¼š\nâ€¢ 5ã¤ã®è¦‹ãˆã‚‹ã‚‚ã®\nâ€¢ 4ã¤ã®è§¦ã‚Œã‚‹ã‚‚ã®\nâ€¢ 3ã¤ã®èã“ãˆã‚‹éŸ³\nâ€¢ 2ã¤ã®åŒ‚ã„\nâ€¢ 1ã¤ã®å‘³\n\nã€Œä»Šã“ã“ã€ã«æˆ»ã£ã¦ãã¾ã—ã‚‡ã†ã€‚', category: 'relaxation' }
  ];
  const insertStmt = db.prepare(`INSERT OR IGNORE INTO templates (key, content, category) VALUES (?, ?, ?)`);
  defaultTemplates.forEach(template => { insertStmt.run(template.key, template.content, template.category); });
  console.log('åˆæœŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæº–å‚™å®Œäº†');
}

function initializeKeywords() {
  const defaultKeywords = [
    { keyword: 'è¾›ã„', template_key: 'comfort', priority: 10 },
    { keyword: 'ã¤ã‚‰ã„', template_key: 'comfort', priority: 10 },
    { keyword: 'è‹¦ã—ã„', template_key: 'breathe', priority: 8 },
    { keyword: 'æ¯è‹¦ã—ã„', template_key: 'breathe', priority: 10 },
    { keyword: 'ãƒ‘ãƒ‹ãƒƒã‚¯', template_key: 'grounding', priority: 10 },
    { keyword: 'æ­»ã«ãŸã„', template_key: 'emergency', priority: 100 },
    { keyword: 'æ¶ˆãˆãŸã„', template_key: 'emergency', priority: 100 }
  ];
  const insertStmt = db.prepare(`INSERT OR IGNORE INTO keyword_responses (keyword, template_key, priority) VALUES (?, ?, ?)`);
  defaultKeywords.forEach(kw => { insertStmt.run(kw.keyword, kw.template_key, kw.priority); });
  console.log('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åå¿œæº–å‚™å®Œäº†');
}

initializeTemplates();
initializeKeywords();

function checkRateLimit(userId) {
  const now = new Date();
  const stmt = db.prepare('SELECT count, reset_at FROM rate_limits WHERE user_id = ?');
  const row = stmt.get(userId);
  if (!row) {
    const insertStmt = db.prepare('INSERT INTO rate_limits (user_id, count, reset_at) VALUES (?, 1, datetime("now", "+1 hour"))');
    insertStmt.run(userId);
    return { allowed: true, remaining: 9 };
  }
  const resetAt = new Date(row.reset_at);
  if (now >= resetAt) {
    const updateStmt = db.prepare('UPDATE rate_limits SET count = 1, reset_at = datetime("now", "+1 hour") WHERE user_id = ?');
    updateStmt.run(userId);
    return { allowed: true, remaining: 9 };
  }
  if (row.count >= 10) {
    const minutesLeft = Math.ceil((resetAt - now) / 60000);
    return { allowed: false, minutesLeft };
  }
  const updateStmt = db.prepare('UPDATE rate_limits SET count = count + 1 WHERE user_id = ?');
  updateStmt.run(userId);
  return { allowed: true, remaining: 10 - row.count - 1 };
}

function getTimeDiff(timestamp) {
  const now = new Date();
  const past = new Date(timestamp);
  const diffMs = now - past;
  const diffMinutes = Math.floor(diffMs / 60000);
  if (diffMinutes < 1) return 'ä»Š';
  if (diffMinutes < 60) return `${diffMinutes}åˆ†å‰`;
  const diffHours = Math.floor(diffMinutes / 60);
  if (diffHours < 24) return `${diffHours}æ™‚é–“å‰`;
  const diffDays = Math.floor(diffHours / 24);
  return `${diffDays}æ—¥å‰`;
}

const client = new Client({
  intents: [GatewayIntentBits.Guilds, GatewayIntentBits.GuildMessages, GatewayIntentBits.MessageContent]
});

client.once('ready', () => {
  console.log(`${client.user.tag} ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸï¼`);
});

client.on('interactionCreate', async interaction => {
  if (!interaction.isChatInputCommand()) return;

  if (interaction.commandName === 'hello') {
    await interaction.reply('ã“ã‚“ã«ã¡ã¯ï¼ä»Šæ—¥ã‚‚é ‘å¼µã‚Šã¾ã—ã‚‡ã† ğŸ˜Š');
  }

  if (interaction.commandName === 'save') {
    const message = interaction.options.getString('message');
    const userId = interaction.user.id;
    const stmt = db.prepare('INSERT INTO messages (user_id, content) VALUES (?, ?)');
    stmt.run(userId, message);
    await interaction.reply('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ ğŸ“');
  }

  if (interaction.commandName === 'read') {
    const userId = interaction.user.id;
    const stmt = db.prepare('SELECT content FROM messages WHERE user_id = ? ORDER BY created_at DESC LIMIT 1');
    const row = stmt.get(userId);
    if (row) {
      await interaction.reply(`è¨˜éŒ²ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${row.content}`);
    } else {
      await interaction.reply('ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“');
    }
  }

  if (interaction.commandName === 'feeling') {
    const userId = interaction.user.id;
    const feeling = interaction.options.getString('mood');
    const note = interaction.options.getString('note') || null;
    const stmt = db.prepare('INSERT INTO feelings (user_id, feeling, note) VALUES (?, ?, ?)');
    stmt.run(userId, feeling, note);
    const countStmt = db.prepare('SELECT COUNT(*) as count FROM feelings WHERE user_id = ?');
    const { count } = countStmt.get(userId);
    const emoji = { great: 'ğŸ˜Š', good: 'ğŸ™‚', okay: 'ğŸ˜', down: 'ğŸ˜”', bad: 'ğŸ˜¢' }[feeling] || 'ğŸ“';
    let message = `ä»Šæ—¥ã®æ°—åˆ†ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ ${emoji} (ç´¯è¨ˆ: ${count}å›ç›®)`;
    if (note) message += `\nãƒ¡ãƒ¢: ${note}`;
    await interaction.reply(message);
  }

  if (interaction.commandName === 'count') {
    const userId = interaction.user.id;
    const totalStmt = db.prepare('SELECT COUNT(*) as count FROM feelings WHERE user_id = ?');
    const { count: totalCount } = totalStmt.get(userId);
    if (totalCount === 0) {
      await interaction.reply('ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚/feeling ã§æ°—åˆ†ã‚’è¨˜éŒ²ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼');
      return;
    }
    const todayStmt = db.prepare(`SELECT COUNT(*) as count FROM feelings WHERE user_id = ? AND DATE(created_at) = DATE('now', 'localtime')`);
    const { count: todayCount } = todayStmt.get(userId);
    const weekStmt = db.prepare(`SELECT COUNT(*) as count FROM feelings WHERE user_id = ? AND DATE(created_at) >= DATE('now', '-7 days', 'localtime')`);
    const { count: weekCount } = weekStmt.get(userId);
    const feelingStmt = db.prepare(`SELECT feeling, COUNT(*) as count FROM feelings WHERE user_id = ? GROUP BY feeling`);
    const feelingCounts = feelingStmt.all(userId);
    const latestStmt = db.prepare(`SELECT feeling, note, created_at FROM feelings WHERE user_id = ? ORDER BY created_at DESC LIMIT 1`);
    const latest = latestStmt.get(userId);
    const timeDiff = getTimeDiff(latest.created_at);
    const emojiMap = { great: 'ğŸ˜Š', good: 'ğŸ™‚', okay: 'ğŸ˜', down: 'ğŸ˜”', bad: 'ğŸ˜¢' };
    let message = '**ã‚ãªãŸã®è¨˜éŒ²**\n';
    message += `ğŸ“Š ç·è¨˜éŒ²æ•°: ${totalCount}å›\nğŸ“… ä»Šæ—¥ã®è¨˜éŒ²: ${todayCount}å›\nğŸ“† éå»7æ—¥é–“: ${weekCount}å›\n\n**æ°—åˆ†ã®å†…è¨³**\n`;
    feelingCounts.forEach(({ feeling, count }) => {
      const emoji = emojiMap[feeling] || 'ğŸ“';
      const percentage = Math.round((count / totalCount) * 100);
      message += `${emoji} ${feeling}: ${count}å› (${percentage}%)\n`;
    });
    message += `\næœ€çµ‚è¨˜éŒ²: ${latest.feeling} (${timeDiff})`;
    if (latest.note) message += `\nãƒ¡ãƒ¢: ${latest.note}`;
    await interaction.reply(message);
  }

  if (interaction.commandName === 'template') {
    const subcommand = interaction.options.getSubcommand();
    if (subcommand === 'get') {
      const key = interaction.options.getString('key');
      const stmt = db.prepare('SELECT content FROM templates WHERE key = ?');
      const row = stmt.get(key);
      if (row) {
        await interaction.reply(row.content);
      } else {
        await interaction.reply(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ '${key}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚/template list ã§ä¸€è¦§ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
      }
    }
    if (subcommand === 'list') {
      const stmt = db.prepare('SELECT key, category FROM templates ORDER BY category, key');
      const templates = stmt.all();
      if (templates.length === 0) {
        await interaction.reply('ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
        return;
      }
      const grouped = {};
      templates.forEach(t => {
        const cat = t.category || 'ãã®ä»–';
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push(t.key);
      });
      let message = '**ğŸ“ ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ**\n\n';
      for (const [category, keys] of Object.entries(grouped)) {
        message += `**${category}**\n`;
        keys.forEach(key => { message += `â€¢ \`${key}\`\n`; });
        message += '\n';
      }
      message += 'ä½¿ã„æ–¹: `/template get <ã‚­ãƒ¼>`';
      await interaction.reply(message);
    }
    if (subcommand === 'add') {
      if (!interaction.member.permissions.has('ManageMessages')) {
        await interaction.reply({ content: 'ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ç®¡ç†è€…ã®ã¿ä½¿ç”¨ã§ãã¾ã™ã€‚', ephemeral: true });
        return;
      }
      const key = interaction.options.getString('key');
      const content = interaction.options.getString('content');
      const category = interaction.options.getString('category') || 'ãã®ä»–';
      const createdBy = interaction.user.id;
      try {
        const stmt = db.prepare(`INSERT INTO templates (key, content, category, created_by) VALUES (?, ?, ?, ?)`);
        stmt.run(key, content, category, createdBy);
        await interaction.reply(`âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ '${key}' ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚`);
      } catch (error) {
        if (error.message.includes('UNIQUE')) {
          await interaction.reply({ content: `âŒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ '${key}' ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚`, ephemeral: true });
        } else {
          await interaction.reply({ content: 'âŒ ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', ephemeral: true });
        }
      }
    }
    if (subcommand === 'delete') {
      if (!interaction.member.permissions.has('ManageMessages')) {
        await interaction.reply({ content: 'ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ç®¡ç†è€…ã®ã¿ä½¿ç”¨ã§ãã¾ã™ã€‚', ephemeral: true });
        return;
      }
      const key = interaction.options.getString('key');
      const stmt = db.prepare('DELETE FROM templates WHERE key = ?');
      const result = stmt.run(key);
      if (result.changes > 0) {
        await interaction.reply(`âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ '${key}' ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
      } else {
        await interaction.reply({ content: `âŒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ '${key}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`, ephemeral: true });
      }
    }
  }

  if (interaction.commandName === 'sos') {
    const stmt = db.prepare('SELECT content FROM templates WHERE key = ?');
    const row = stmt.get('emergency');
    if (row) {
      await interaction.reply(row.content);
    } else {
      await interaction.reply('ğŸ“ ç·Šæ€¥é€£çµ¡å…ˆ\n\nâ€¢ ã„ã®ã¡ã®é›»è©±: 0570-783-556 (24æ™‚é–“)\nâ€¢ ã“ã“ã‚ã®å¥åº·ç›¸è«‡: 0570-064-556\n\nä¸€äººã§æŠ±ãˆè¾¼ã¾ãªã„ã§ãã ã•ã„ã€‚');
    }
  }

  if (interaction.commandName === 'keyword') {
    if (!interaction.member.permissions.has('ManageMessages')) {
      await interaction.reply({ content: 'ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ç®¡ç†è€…ã®ã¿ä½¿ç”¨ã§ãã¾ã™ã€‚', ephemeral: true });
      return;
    }
    const subcommand = interaction.options.getSubcommand();
    if (subcommand === 'add') {
      const keyword = interaction.options.getString('keyword');
      const templateKey = interaction.options.getString('template');
      const priority = interaction.options.getInteger('priority') || 5;
      const checkStmt = db.prepare('SELECT key FROM templates WHERE key = ?');
      if (!checkStmt.get(templateKey)) {
        await interaction.reply({ content: `âŒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ '${templateKey}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`, ephemeral: true });
        return;
      }
      const stmt = db.prepare(`INSERT INTO keyword_responses (keyword, template_key, priority) VALUES (?, ?, ?)`);
      stmt.run(keyword, templateKey, priority);
      await interaction.reply(`âœ… ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ '${keyword}' ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼ˆå„ªå…ˆåº¦: ${priority}ï¼‰`);
    }
    if (subcommand === 'list') {
      const stmt = db.prepare(`SELECT id, keyword, template_key, priority, enabled FROM keyword_responses ORDER BY priority DESC, keyword`);
      const keywords = stmt.all();
      if (keywords.length === 0) {
        await interaction.reply('ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
        return;
      }
      let message = '**ğŸ”‘ ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰**\n\n';
      keywords.forEach(kw => {
        const status = kw.enabled ? 'âœ…' : 'âŒ';
        message += `${status} ID:${kw.id} | ã€Œ${kw.keyword}ã€ â†’ \`${kw.template_key}\` (å„ªå…ˆåº¦: ${kw.priority})\n`;
      });
      await interaction.reply(message);
    }
    if (subcommand === 'delete') {
      const id = interaction.options.getInteger('id');
      const stmt = db.prepare('DELETE FROM keyword_responses WHERE id = ?');
      const result = stmt.run(id);
      if (result.changes > 0) {
        await interaction.reply(`âœ… ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ID ${id} ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
      } else {
        await interaction.reply({ content: `âŒ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ID ${id} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`, ephemeral: true });
      }
    }
  }

  // AIæ©Ÿèƒ½ï¼ˆç¬¬7å›ã§ã¯ã‚¹ãƒ‘ãƒ ãƒã‚§ãƒƒã‚¯ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’è¿½åŠ ï¼‰
  if (interaction.commandName === 'ai') {
    const userId = interaction.user.id;
    const userMessage = interaction.options.getString('message');

    // ã‚¹ãƒ‘ãƒ ãƒã‚§ãƒƒã‚¯
    const penalty = spamDetector.checkPenalty(userId);
    if (penalty.banned) {
      await interaction.reply({ 
        content: `â¸ï¸ ç¾åœ¨ãƒšãƒŠãƒ«ãƒ†ã‚£ä¸­ã§ã™ã€‚ã‚ã¨${penalty.minutesLeft}åˆ†ãŠå¾…ã¡ãã ã•ã„ã€‚`, 
        ephemeral: true 
      });
      return;
    }

    const spamCheck = await spamDetector.checkSpam(userId, userMessage);
    if (spamCheck.isSpam) {
      await interaction.reply({ 
        content: `âš ï¸ ${spamCheck.reason}\nå°‘ã—æ™‚é–“ã‚’ç½®ã„ã¦ã‹ã‚‰ãŠè©¦ã—ãã ã•ã„ã€‚`, 
        ephemeral: true 
      });
      return;
    }

    // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const filterResult = contentFilter.check(userMessage);
    if (!filterResult.safe) {
      await interaction.reply({ 
        content: `â›” ${filterResult.message}`, 
        ephemeral: true 
      });
      return;
    }

    // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
    const rateLimit = checkRateLimit(userId);
    if (!rateLimit.allowed) {
      await interaction.reply({ 
        content: `â° 1æ™‚é–“ã«10å›ã¾ã§ã§ã™ã€‚ã‚ã¨${rateLimit.minutesLeft}åˆ†å¾Œã«å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚`, 
        ephemeral: true 
      });
      return;
    }

    // ç·Šæ€¥ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œå‡º
    if (aiHelper.detectEmergency(userMessage)) {
      await interaction.reply('âš ï¸ ã‚‚ã—ã‚‚ã®æ™‚ã¯ä¸€äººã§æŠ±ãˆè¾¼ã¾ãªã„ã§ãã ã•ã„ã€‚\n`/sos` ã§ç·Šæ€¥é€£çµ¡å…ˆã‚’ç¢ºèªã§ãã¾ã™ã€‚\n\nãã‚Œã§ã‚‚ãŠè©±ã‚’èã‹ã›ã¦ã„ãŸã ãã¾ã™ã­...');
    }

    await interaction.deferReply();

    const historyStmt = db.prepare(`SELECT role, content FROM ai_conversations WHERE user_id = ? ORDER BY created_at DESC LIMIT 10`);
    const history = historyStmt.all(userId).reverse();
    const aiResponse = await aiHelper.chat(userMessage, history);

    const saveStmt = db.prepare('INSERT INTO ai_conversations (user_id, role, content) VALUES (?, ?, ?)');
    saveStmt.run(userId, 'user', userMessage);
    saveStmt.run(userId, 'assistant', aiResponse.message);

    await interaction.editReply(aiResponse.message + `\n\n_ï¼ˆæ®‹ã‚Š ${rateLimit.remaining} å›ï¼‰_`);
  }

  if (interaction.commandName === 'ai-reset') {
    const userId = interaction.user.id;
    const stmt = db.prepare('DELETE FROM ai_conversations WHERE user_id = ?');
    const result = stmt.run(userId);
    await interaction.reply(`âœ… ä¼šè©±å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼ˆ${result.changes}ä»¶ï¼‰`);
  }

  if (interaction.commandName === 'ai-stats') {
    if (!interaction.member.permissions.has('ManageMessages')) {
      await interaction.reply({ content: 'ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ç®¡ç†è€…ã®ã¿ä½¿ç”¨ã§ãã¾ã™ã€‚', ephemeral: true });
      return;
    }
    const totalStmt = db.prepare('SELECT COUNT(*) as count FROM ai_conversations');
    const { count: totalConversations } = totalStmt.get();
    const todayStmt = db.prepare(`SELECT COUNT(*) as count FROM ai_conversations WHERE DATE(created_at) = DATE('now', 'localtime')`);
    const { count: todayConversations } = todayStmt.get();
    const usersStmt = db.prepare('SELECT COUNT(DISTINCT user_id) as count FROM ai_conversations');
    const { count: uniqueUsers } = usersStmt.get();
    let message = '**ğŸ“Š AIä½¿ç”¨çµ±è¨ˆ**\n\nç·ä¼šè©±æ•°: ${totalConversations}å›\nä»Šæ—¥ã®ä¼šè©±æ•°: ${todayConversations}å›\nåˆ©ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ${uniqueUsers}äºº\n';
    await interaction.reply(message);
  }

  // ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒãƒ³ãƒ‰ï¼ˆç¬¬7å›ã§è¿½åŠ ï¼‰
  if (interaction.commandName === 'moderation') {
    if (!interaction.member.permissions.has('ManageMessages')) {
      await interaction.reply({ content: 'ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ç®¡ç†è€…ã®ã¿ä½¿ç”¨ã§ãã¾ã™ã€‚', ephemeral: true });
      return;
    }

    const subcommand = interaction.options.getSubcommand();

    if (subcommand === 'logs') {
      const limit = interaction.options.getInteger('limit') || 10;
      const stmt = db.prepare(`SELECT * FROM moderation_logs ORDER BY created_at DESC LIMIT ?`);
      const logs = stmt.all(limit);
      
      if (logs.length === 0) {
        await interaction.reply('ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
        return;
      }
      
      let message = `**ğŸ“‹ ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ï¼ˆç›´è¿‘${limit}ä»¶ï¼‰**\n\n`;
      logs.forEach(log => {
        const date = new Date(log.created_at).toLocaleString('ja-JP');
        message += `${date}\nãƒ¦ãƒ¼ã‚¶ãƒ¼: <@${log.user_id}>\nã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ${log.action}\nç†ç”±: ${log.reason}\n\n`;
      });
      
      await interaction.reply(message);
    }

    if (subcommand === 'unban') {
      const targetUser = interaction.options.getUser('user');
      await spamDetector.removePenalty(targetUser.id);
      const logStmt = db.prepare(`INSERT INTO moderation_logs (user_id, action, reason, moderator_id) VALUES (?, 'penalty_removed', 'manual_unban', ?)`);
      logStmt.run(targetUser.id, interaction.user.id);
      await interaction.reply(`âœ… <@${targetUser.id}> ã®ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’è§£é™¤ã—ã¾ã—ãŸã€‚`);
    }
  }

  // é€šå ±ã‚³ãƒãƒ³ãƒ‰ï¼ˆç¬¬7å›ã§è¿½åŠ ï¼‰
  if (interaction.commandName === 'report') {
    const targetUser = interaction.options.getUser('user');
    const reason = interaction.options.getString('reason');
    
    const logStmt = db.prepare(`INSERT INTO moderation_logs (user_id, action, reason, moderator_id) VALUES (?, 'user_reported', ?, ?)`);
    logStmt.run(targetUser.id, reason, interaction.user.id);
    
    await interaction.reply({ content: 'âœ… é€šå ±ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚ç®¡ç†è€…ãŒç¢ºèªã—ã¾ã™ã€‚', ephemeral: true });
  }
});

// ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ
client.on('interactionCreate', async interaction => {
  if (!interaction.isAutocomplete()) return;
  if (interaction.commandName === 'template') {
    const focusedValue = interaction.options.getFocused();
    const stmt = db.prepare('SELECT key FROM templates WHERE key LIKE ? LIMIT 25');
    const choices = stmt.all(`%${focusedValue}%`);
    await interaction.respond(choices.map(choice => ({ name: choice.key, value: choice.key })));
  }
});

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¤ãƒ™ãƒ³ãƒˆ
client.on('messageCreate', async message => {
  if (message.author.bot) return;
  if (message.system) return;
  const content = message.content.toLowerCase();
  const stmt = db.prepare(`
    SELECT kr.keyword, kr.template_key, kr.priority, t.content 
    FROM keyword_responses kr
    JOIN templates t ON kr.template_key = t.key
    WHERE kr.enabled = 1 AND LOWER(?) LIKE '%' || LOWER(kr.keyword) || '%'
    ORDER BY kr.priority DESC, kr.keyword DESC LIMIT 1
  `);
  const match = stmt.get(content);
  if (match) {
    if (match.priority >= 100) {
      await message.reply(match.content);
      return;
    }
    if (match.priority >= 10) {
      await message.reply({ content: `${match.content}\n\nå¿…è¦ã§ã‚ã‚Œã° \`/sos\` ã§ç·Šæ€¥é€£çµ¡å…ˆã‚’ç¢ºèªã§ãã¾ã™ã€‚`, allowedMentions: { repliedUser: false } });
      return;
    }
    await message.reply({ content: `ğŸ’¡ \`/template get ${match.template_key}\` ãŒå½¹ç«‹ã¤ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚`, allowedMentions: { repliedUser: false } });
  }
});

client.login(process.env.DISCORD_TOKEN);
```

ã“ã‚Œã§ç¬¬7å›ã¯å®Œæˆã§ã™ï¼
