# 第17回：本番データを守る（捨てる）を決める

「バックアップは取っているけど、復元したことがない...」
「すべてのデータを守るべき？それとも一部は捨ててもいい？」

この回では、**データの価値を見極め、守る責任を理解する**方法を学びます。

---

## 📌 この回の目標

- バックアップの自動化ができる
- 復元演習を実施できる
- 守る価値のあるデータを判断できる

**💡 ポイント：**
- バックアップは「取る」だけでなく「戻せる」が重要
- すべてのデータに同じ価値はない
- 責任の所在を明確にする

---

## 🎯 完成イメージ

```
【バックアップがないと】
サーバーが壊れる
  ↓
すべてのデータが失われる
  ↓
ユーザー：「私のデータは...？」
  ↓
「ありません」

【バックアップがあると】
サーバーが壊れる
  ↓
新しいサーバーを用意
  ↓
バックアップから復元
  ↓
ユーザー：「データは無事？」
  ↓
「はい、すべて復元しました」
```

---

## 第1章：なぜバックアップが必要なのか（10分）

### 1-1. データロスの3つのシナリオ

**シナリオ1：サーバー障害**

```
原因：
- GCP Compute Engineの障害
- ディスク故障
- ハードウェア障害

結果：
- サーバーにアクセスできない
- データが取り出せない

対策：
- バックアップがあれば復元可能
```

---

**シナリオ2：人為ミス**

```
原因：
- 誤って DROP TABLE を実行
- 誤ってファイルを削除
- マイグレーションの失敗

結果：
- データが消える
- 復元不可能

対策：
- バックアップから復元
```

---

**シナリオ3：セキュリティ侵害**

```
原因：
- 不正アクセス
- マルウェア
- ランサムウェア

結果：
- データが改ざん・暗号化される
- サーバーが乗っ取られる

対策：
- バックアップから復元
- セキュリティ強化
```

---

### 1-2. バックアップの「3-2-1ルール」

**3-2-1ルール：**

```
3つのコピー
  ↓
2つの異なるメディア
  ↓
1つはオフサイト（別の場所）
```

**例：Discord Bot の場合**

```
コピー1：本番サーバー（~/git_practice/bot.db）
コピー2：本番サーバーのバックアップ（~/backups/）
コピー3：ローカルPC または Google Drive（オフサイト）

メディア1：サーバーのディスク
メディア2：外部ストレージ（Google Cloud Storage など）
```

---

## 第2章：バックアップの自動化（20分）

### 2-1. バックアップスクリプトの作成

**サーバーで作業：**

```bash
cd ~/git_practice
nano backup.sh
```

**backup.sh の内容：**

```bash
#!/bin/bash

set -e

echo "========================================="
echo "  データベースバックアップスクリプト"
echo "========================================="

# 設定
BACKUP_DIR=~/backups/database
PROJECT_DIR=~/git_practice
DB_FILE=bot.db
DATE=$(date +"%Y%m%d_%H%M%S")
BACKUP_FILE="$BACKUP_DIR/${DB_FILE%.db}_$DATE.db"

# バックアップディレクトリを作成
mkdir -p $BACKUP_DIR

# データベースをコピー
echo "[1/4] データベースをコピー中..."
cp $PROJECT_DIR/$DB_FILE $BACKUP_FILE

if [ $? -eq 0 ]; then
    echo "✓ バックアップ完了: $BACKUP_FILE"
else
    echo "✗ バックアップ失敗"
    exit 1
fi

# ファイルサイズを確認
FILE_SIZE=$(du -h $BACKUP_FILE | cut -f1)
echo "[2/4] ファイルサイズ: $FILE_SIZE"

# 古いバックアップを削除（7日以上前）
echo "[3/4] 古いバックアップを削除中..."
find $BACKUP_DIR -name "*.db" -mtime +7 -delete
echo "✓ 7日以上前のバックアップを削除"

# バックアップ一覧を表示
echo "[4/4] 現在のバックアップ一覧:"
ls -lh $BACKUP_DIR | tail -5

echo ""
echo "========================================="
echo "  バックアップ完了"
echo "========================================="
```

**実行権限を付与：**

```bash
chmod +x backup.sh
```

---

### 2-2. バックアップの実行テスト

**手動でバックアップを実行：**

```bash
./backup.sh
```

**✅ 成功すると：**

```
=========================================
  データベースバックアップスクリプト
=========================================
[1/4] データベースをコピー中...
✓ バックアップ完了: /home/discord_bot/backups/database/bot_20260204_170000.db
[2/4] ファイルサイズ: 128K
[3/4] 古いバックアップを削除中...
✓ 7日以上前のバックアップを削除
[4/4] 現在のバックアップ一覧:
-rw-r--r-- 1 discord_bot discord_bot 128K Feb  4 17:00 bot_20260204_170000.db

=========================================
  バックアップ完了
=========================================
```

---

### 2-3. cronで自動バックアップを設定

**cronとは：**
- 定期的にコマンドを実行するUnixの仕組み
- 毎日、毎時間、など柔軟に設定可能

---

**crontabを編集：**

```bash
crontab -e
```

**以下の行を追加（毎日午前3時にバックアップ）：**

```
0 3 * * * /home/discord_bot/git_practice/backup.sh >> /home/discord_bot/backup.log 2>&1
```

**💡 cron の書き方：**

```
分 時 日 月 曜日 コマンド

0 3 * * *  ← 毎日午前3時
0 */6 * * * ← 6時間ごと
0 0 * * 0  ← 毎週日曜日の午前0時
```

**保存して閉じる：**
- `Ctrl + X` → `Y` → `Enter`

---

**cron設定を確認：**

```bash
crontab -l
```

**出力例：**
```
0 3 * * * /home/discord_bot/git_practice/backup.sh >> /home/discord_bot/backup.log 2>&1
```

---

### 2-4. バックアップログの確認

**翌日以降、バックアップログを確認：**

```bash
cat ~/backup.log
```

**正常に動作していれば、毎日ログが追加されます。**

---

## 第3章：復元演習（20分）

### 3-1. なぜ復元演習が必要か

**復元演習をしないと：**

```
本番障害発生
  ↓
「バックアップから復元しよう」
  ↓
復元方法が分からない
  ↓
焦って失敗
  ↓
さらに悪化
```

**復元演習をしておくと：**

```
本番障害発生
  ↓
「バックアップから復元しよう」
  ↓
練習した手順を実行
  ↓
復元成功（5分）
```

---

### 3-2. 復元演習の実施

**⚠️ 重要：復元演習は必ずテスト環境で行う**

---

#### ステップ1：現在のデータベースを確認

**サーバーで実行：**

```bash
cd ~/git_practice

# データ件数を確認
sqlite3 bot.db "SELECT COUNT(*) FROM feelings;"

# 出力例：42
```

**この数字を覚えておく（例：42件）**

---

#### ステップ2：テストデータを追加

```bash
# SQLiteに接続
sqlite3 bot.db

# テストデータを追加
INSERT INTO feelings (user_id, feeling, note) VALUES ('test_user', 'テスト', '復元演習用のテストデータ');

# 確認
SELECT COUNT(*) FROM feelings;

# 出力例：43（1件増えた）

.quit
```

---

#### ステップ3：バックアップから復元

```bash
# 1. 現在のデータベースを退避
mv bot.db bot.db.before_restore

# 2. バックアップ一覧を確認
ls -lt ~/backups/database/

# 3. 最新のバックアップをコピー（例：bot_20260204_170000.db）
cp ~/backups/database/bot_20260204_170000.db bot.db

# 4. データ件数を確認
sqlite3 bot.db "SELECT COUNT(*) FROM feelings;"

# 出力例：42（元に戻った！）
```

**✅ 復元成功：**
- データ件数が元の数字（42件）に戻った
- テストデータ（43件目）は消えた

---

#### ステップ4：Botを再起動して確認

```bash
pm2 restart discord-bot
pm2 logs discord-bot
```

**Discordでコマンドを実行して、正常に動作するか確認。**

---

#### ステップ5：元に戻す

```bash
# 復元演習前の状態に戻す
mv bot.db.before_restore bot.db

# Bot再起動
pm2 restart discord-bot
```

---

### 3-3. 復元手順書の作成

**ローカルPCで作業：**

```powershell
cd C:\Users\<あなたのユーザー名>\git_practice
New-Item -ItemType File -Name RESTORE_PROCEDURE.md
code RESTORE_PROCEDURE.md
```

**RESTORE_PROCEDURE.md の内容：**

```markdown
# データベース復元手順書

## 緊急時の復元手順

### 前提条件
- バックアップファイルが存在する
- サーバーにSSH接続できる

### 復元手順

#### 1. 現在の状態を確認
```bash
cd ~/git_practice
pm2 status discord-bot
```

#### 2. Botを停止
```bash
pm2 stop discord-bot
```

#### 3. 現在のデータベースを退避
```bash
mv bot.db bot.db.broken.$(date +%Y%m%d_%H%M%S)
```

#### 4. バックアップ一覧を確認
```bash
ls -lt ~/backups/database/
```

#### 5. 復元するバックアップを選択
```bash
# 例：最新のバックアップを使用
BACKUP_FILE=$(ls -t ~/backups/database/*.db | head -1)
echo "復元するファイル: $BACKUP_FILE"
```

#### 6. バックアップをコピー
```bash
cp $BACKUP_FILE bot.db
```

#### 7. ファイルの所有権を確認
```bash
ls -l bot.db
# discord_bot:discord_bot であることを確認
```

#### 8. Botを再起動
```bash
pm2 restart discord-bot
```

#### 9. ログを確認
```bash
pm2 logs discord-bot --lines 50
```

#### 10. 動作確認
- Discordで /feeling コマンドを実行
- /count コマンドを実行
- 正常に動作することを確認

### 復元時のチェックリスト

- [ ] Bot を停止した
- [ ] 現在のDBを退避した（念のため）
- [ ] バックアップファイルを確認した
- [ ] バックアップをコピーした
- [ ] Bot を再起動した
- [ ] ログにエラーがない
- [ ] コマンドが正常に動作する

### トラブルシューティング

#### Bot が起動しない
- ログを確認: `pm2 logs discord-bot --err`
- ファイルの存在確認: `ls -l bot.db`
- ファイルの所有権確認: `chown discord_bot:discord_bot bot.db`

#### データが古い
- 別のバックアップを試す
- バックアップの日時を確認

#### 復元しても問題が解決しない
- 問題がDB以外にある可能性
- コードのロールバックも検討
```

**コミット：**

```powershell
git add RESTORE_PROCEDURE.md backup.sh
git commit -m "バックアップと復元手順書を追加"
git push origin main
```

---

## 第4章：守る価値のあるデータとは（15分）

### 4-1. データの価値分類

**最優先で守るデータ（Critical）：**

```
例：
- ユーザーの気分記録（feelings テーブル）
- ユーザー設定（user_settings テーブル）

理由：
- ユーザーの個人データ
- 失われると信頼を失う
- 復元不可能

対策：
- 毎日バックアップ
- 複数のバックアップを保持
- オフサイトバックアップも取る
```

---

**守るべきデータ（Important）：**

```
例：
- マイグレーション履歴（migrations テーブル）
- システム設定

理由：
- 失われると復旧に時間がかかる
- 再構築可能だが手間

対策：
- 定期的にバックアップ
- 7日分程度を保持
```

---

**捨ててもいいデータ（Low Priority）：**

```
例：
- ログファイル
- 一時ファイル
- キャッシュ

理由：
- 再生成可能
- システムで自動生成される
- 失われても影響なし

対策：
- バックアップ不要
- 定期的に削除してOK
```

---

### 4-2. バックアップ対象の決定

**現在のBot で守るべきデータ：**

```
守る（毎日バックアップ）：
- bot.db（すべてのユーザーデータ）

守る（週1回バックアップ）：
- .env.production（環境変数）
- package.json（依存関係）

守らない：
- node_modules（再インストール可能）
- ログファイル（再生成される）
- バックアップファイル自体（多重バックアップ不要）
```

---

### 4-3. データ保持期間の決定

**保持期間の例：**

```
データベースバックアップ：
- 毎日バックアップ
- 7日分を保持
- それ以上古いものは削除

コードバックアップ：
- Git で管理
- 無期限保持（GitHubが存続する限り）

ログファイル：
- 7日分を保持
- pm2-logrotate で自動削除
```

---

### 4-4. バックアップ計画書の作成

**ローカルPCで作業：**

```powershell
New-Item -ItemType File -Name BACKUP_PLAN.md
code BACKUP_PLAN.md
```

**BACKUP_PLAN.md の内容：**

```markdown
# バックアップ計画書

## バックアップ対象

### 最優先（Critical）
| データ | 頻度 | 保持期間 | 保存場所 |
|--------|------|----------|----------|
| bot.db | 毎日午前3時 | 7日 | ~/backups/database/ |

### 重要（Important）
| データ | 頻度 | 保持期間 | 保存場所 |
|--------|------|----------|----------|
| .env.production | 手動（変更時） | 最新1件 | ~/backups/config/ |
| コード一式 | デプロイ時 | 7件 | ~/backups/YYYYMMDD_HHMMSS/ |

### バックアップ不要
- node_modules（npm install で復元可能）
- ログファイル（pm2-logrotate が管理）
- 一時ファイル

## バックアップ方法

### 自動バックアップ
- cron で毎日午前3時に実行
- スクリプト: `~/git_practice/backup.sh`

### 手動バックアップ
- デプロイ時: `deploy.sh` が自動実行
- 緊急時: `./backup.sh` を手動実行

## 復元方法

詳細は `RESTORE_PROCEDURE.md` を参照

## オフサイトバックアップ（推奨）

### 方法1：Google Cloud Storage にアップロード
```bash
# gsutil をインストール
# バックアップをアップロード
gsutil cp ~/backups/database/bot_*.db gs://your-bucket-name/
```

### 方法2：ローカルPCにダウンロード
```bash
# 定期的にローカルPCにコピー
scp discord_bot@<サーバーIP>:~/backups/database/bot_*.db C:/backups/
```

## 責任者

- バックアップ担当：（あなたの名前）
- 復元権限者：（あなたの名前）
- 連絡先：（あなたの連絡先）

## 復元演習

- 頻度：月1回
- 次回実施日：（日付を記入）
- 実施記録：RESTORE_PROCEDURE.md に追記

## 見直し

- このバックアップ計画は、3ヶ月ごとに見直す
- 次回見直し：（日付を記入）
```

**コミット：**

```powershell
git add BACKUP_PLAN.md
git commit -m "バックアップ計画書を追加"
git push origin main
```

---

## 第5章：責任の所在を理解する（10分）

### 5-1. 個人開発の場合の責任

**あなた（開発者）の責任：**

```
技術的責任：
- バックアップを取る
- 復元できる状態を維持する
- データロスを防ぐ

説明責任：
- ユーザーに「データは守られている」と伝える
- トラブル時に状況を説明する
- 復旧予定を伝える

限界の明示：
- 「100%の保証はできない」
- 「災害時は復旧に時間がかかる可能性」
- 「無料サービスの限界」
```

---

**ユーザーの責任：**

```
- 重要なデータは自分でもバックアップを取る
- 無料サービスの限界を理解する
- トラブル時に協力する
```

---

### 5-2. 利用規約への明記

**ローカルPCで作業：**

```powershell
New-Item -ItemType File -Name TERMS_OF_SERVICE.md
code TERMS_OF_SERVICE.md
```

**TERMS_OF_SERVICE.md の内容（例）：**

```markdown
# Discord Bot 利用規約

## データの取り扱い

### バックアップ
- 当Botは、ユーザーのデータを毎日自動的にバックアップします
- バックアップは7日分を保持します

### データロスのリスク
- サーバー障害、災害、不正アクセスなどにより、データが失われる可能性があります
- 運営者は最善を尽くしますが、100%の保証はできません

### ユーザーの責任
- 重要なデータは、ユーザー自身でもバックアップを取ることを推奨します
- データロスが発生した場合、運営者は復旧に努めますが、完全な復旧を保証できません

### 免責事項
- 無料で提供しているサービスであり、データロスによる損害の責任は負いかねます
- サービスの継続を保証するものではありません

## データの削除

### ユーザーによる削除
- ユーザーは自分のデータをいつでも削除できます
- 削除されたデータは復元できません

### 運営者による削除
- サービス終了時、すべてのデータを削除します
- 終了の30日前までに告知します

## 更新日
2026-02-04
```

---

### 5-3. README.md への追記

**README.md（サーバー側）を作成/更新：**

**サーバーで実行：**

```bash
cd ~/git_practice
nano README.md
```

**以下を追記：**

```markdown
# Discord Bot 運用情報

## データの保護

このBotは、以下の方法でデータを保護しています：

### バックアップ
- 毎日午前3時に自動バックアップ
- 7日分のバックアップを保持

### 復元
- サーバー障害時は、最新のバックアップから復元
- 復元手順は RESTORE_PROCEDURE.md を参照

### オフサイトバックアップ
- （設定している場合）Google Cloud Storage にも保存

## トラブル時の連絡先

- Discord: @your_discord_id
- Email: your_email@example.com

## 利用規約

詳細は TERMS_OF_SERVICE.md を参照してください。
```

---

## ✅ この回のチェックリスト

- [ ] バックアップスクリプトを作成した
- [ ] cronで自動バックアップを設定した
- [ ] 復元演習を実施した
- [ ] 復元手順書を作成した
- [ ] データの価値分類を理解した
- [ ] バックアップ計画書を作成した
- [ ] 責任の所在を理解した
- [ ] 利用規約を作成した

---

## 🎓 この回で学んだこと

**最重要ポイント：**
> **バックアップは「取る」だけでなく「戻せる」が重要。すべてのデータに同じ価値はない。責任の所在を明確にする。**

**具体的に学んだこと：**
1. バックアップの自動化（cron設定）
2. 復元演習の実施と手順書作成
3. データの価値分類（Critical / Important / Low Priority）
4. バックアップ計画書の作成
5. 責任の所在と利用規約

---

## 📝 次回予告

**第18回：Botをもう1体増やす判断をする**

データ保護ができるようになったので、次は「スケールの入口」を学びます。

- 1インスタンスで2体のBotを動かす
- ディレクトリ・envの分離
- pm2での複数Bot管理

---

## 📦 この回で作成したファイル

### ファイル構成（サーバー側）

```
git_practice/
├── backup.sh
└── README.md（運用情報を追記）

~/backups/
├── database/
│   ├── bot_20260204_030000.db
│   ├── bot_20260205_030000.db
│   └── ...
└── ...
```

### ファイル構成（ローカル側）

```
git_practice/
├── BACKUP_PLAN.md
├── RESTORE_PROCEDURE.md
└── TERMS_OF_SERVICE.md
```

---

## 🔧 よくある質問

**Q1: バックアップ容量が心配です。どのくらい必要？**
A: Discord Bot程度なら、データベースは数MB〜数十MB程度。
   7日分でも1GB未満で収まることがほとんどです。

**Q2: 復元演習は本当に必要？**
A: はい。本番障害時に「初めて復元を試す」のは危険です。
   月1回、5分程度でできるので、必ず実施してください。

**Q3: オフサイトバックアップは必須？**
A: サーバーが完全に失われるリスクを考えると、推奨です。
   Google Cloud Storage や Google Drive に週1回コピーするだけでも効果があります。

**Q4: ユーザーのデータを勝手に削除してもいい？**
A: いいえ。利用規約で削除の条件を明記し、ユーザーに同意を得てください。
   また、削除前に必ずエクスポート機能を提供することを推奨します。

---

これで第17回は完了です！

次回（第18回）では、複数Botの管理について学びます。
