# 第18回：Botをもう1体増やす判断をする

―― インスタンスを増やす前に、やることがある ――

Botは安定している。
機能も増えてきた。
「もう1個Bot作れそうだな」と思った瞬間。

ここで多くの人が悩みます。

> **「サーバー、もう1台必要？」**

この回では、

* 新しいサーバーは立てない
* Kubernetes も Docker も使わない
* 難しい話はしない

👉 **“今ある1台”でBotを増やす判断**を、実際にやります。

---

## 📌 この回の目標

* 1台のサーバーで **2つのBotを同時に動かす**
* Botごとに **責任範囲を分ける**
* 「分ける／分けない」の判断基準を持つ

**💡 この回の約束**

* インフラを増やさない
* 最適化しない
* 将来の話をしない

👉 **今日動く現実解だけ**を作ります。

---

## 🎯 完成イメージ

```
/opt/bots/
 ├─ bot-a/
 │   ├─ index.js
 │   ├─ .env
 │   └─ data/
 └─ bot-b/
     ├─ index.js
     ├─ .env
     └─ data/
```

```
pm2 status
┌─────────┬─────────────┬────────┐
│ name    │ status      │ cpu    │
├─────────┼─────────────┼────────┤
│ bot-a   │ online      │ 0.3%   │
│ bot-b   │ online      │ 0.2%   │
└─────────┴─────────────┴────────┘
```

---

## 第1章：Botを増やすと何が変わるのか（10分）

### 1-1. Botが1体のときは気にしなくてよかったこと

* ポート
* メモリ
* ログの量
* envの衝突

1体なら、だいたい何とかなります。

---

### 1-2. 2体になると「事故」が変わる

* 片方のBotが落ちる
* もう片方も巻き込まれる
* どっちのログか分からない

👉 **Botを“分ける”必要が出てくる**

---

## 第2章：Botを分ける最低限の単位（10分）

この回では、
**次の3つだけ分けます**。

1. ディレクトリ
2. 環境変数（.env）
3. pm2のアプリ名

**DBは後で考える**

---

## 第3章：2体目のBotを用意する（15分）

### 3-1. ディレクトリを分ける

```bash
mkdir -p /opt/bots/bot-b
cd /opt/bots/bot-b
```

---

### 3-2. 既存Botをコピーする

```bash
cp -r /opt/bots/bot-a/* .
```

👉 **コピペでOK**
👉 再利用を疑わない

---

### 3-3. .env を書き換える

```env
DISCORD_TOKEN=xxxxx
BOT_NAME=bot-b
```

**ここだけは必ず変える**

* TOKEN
* Bot名

---

## 第4章：pm2で2体管理する（20分）

### 4-1. 1体目の状態を確認

```bash
pm2 status
```

---

### 4-2. 2体目を起動する

```bash
pm2 start index.js --name bot-b
```

確認：

```bash
pm2 status
```

---

### 4-3. 片方だけ落としてみる

```bash
pm2 stop bot-b
pm2 status
```

**確認**

* bot-a は動いている
* 影響が分離されている

👉 **これが目的**

---

## 第5章：ログとDBの衝突を防ぐ（15分）

### 5-1. ログの見分け方

```bash
pm2 logs bot-a
pm2 logs bot-b
```

👉 **名前が違うだけで安心感が違う**

---

### 5-2. DBを共有する？分ける？

この回では **分けます**。

```env
DB_PATH=data/bot-b.db
```

理由：

* 事故の切り分けが楽
* 片方壊れても片方無事

👉 **将来統合は考えない**

---

## 第6章：この構成で困ることをあえて考える（10分）

* CPUが足りなくなる
* メモリを食う
* 片方のAI呼び出しが重い

👉 **この時、初めて「分離」を考える**

---

## 第7章：インスタンスを増やす判断基準（10分）

この回での基準はこれ。

**まだ増やさないでいい条件**

* CPU 50% 未満
* メモリに余裕
* 片方落ちても致命的でない

**増やす理由になる条件**

* 障害影響を分けたい
* Botごとに責任者が違う
* コストを払える

---

## 第8章：この回の結論（超重要）

> **Botが増えたら、
> まず“プロセス”を分ける**
> **サーバーは最後**

---

## ✅ この回のチェックリスト

* [ ] 2体目のBotを起動した
* [ ] pm2で個別管理できた
* [ ] ログを分けて見られた
* [ ] DBを分けた
* [ ] 「増やす判断」を言語化できた

---

## 🎓 この回で得たもの

* スケールへの現実的な入口
* インフラ恐怖症の解除
* 「増やす前に考える」癖

> **台数を増やすのは、
> 技術の話ではなく判断の話**

---

## 📝 次回予告

**第19回：このBotは作り続ける価値があるか？**

次は、

* 機能追加を続ける？
* 凍結する？
* 捨てる？

を、**技術ではなくコストと責任で判断**します。