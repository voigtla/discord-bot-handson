# 第15回：やらかした時に「直さない」生存戦略

「バグを見つけた！すぐ修正しなきゃ！」

**ちょっと待ってください。**

本番環境でトラブルが起きたとき、**「直す」よりも「戻す」方が正しいことがあります。**

この回では、ロールバック（切り戻し）の判断と、最速でサービスを復旧させる方法を学びます。

---

## 📌 この回の目標

- 「直す」と「戻す」の判断基準を理解する
- ロールバック（切り戻し）を実行できる
- 再起動だけで解決するケースを見極める

**💡 ポイント：**
- **まず止血、原因究明は後**
- 本番で実験しない
- ユーザーへの影響を最小化

---

## 🎯 完成イメージ

```
【悪い対応】
本番でエラー発生
  ↓
「原因を特定しなきゃ！」
  ↓
本番サーバーで調査開始
  ↓
「あ、ここかも...」
  ↓
本番で修正を試みる
  ↓
さらに悪化
  ↓
ユーザー：「まだ直らないの？」

【良い対応】
本番でエラー発生
  ↓
「まず止血」
  ↓
前のバージョンに戻す（30秒）
  ↓
サービス復旧
  ↓
ローカル環境で原因調査
  ↓
修正・テスト
  ↓
再デプロイ
```

---

## 第1章：なぜ「直さない」のか（10分）

### 1-1. 本番環境で修正する危険性

**ケース1：応急処置が悪化させる**

```
状況：Bot が起動しない

【その場で修正を試みる】
開発者：「エラーログを見たら、API_KEYが間違ってる」
     ↓
     「.env を直接編集しよう」
     ↓
     nano .env
     ↓
     「あれ、保存できない...」
     ↓
     「Ctrl + X... あれ？消えた？」
     ↓
     .env ファイルが空になる
     ↓
     すべての設定が失われる
     ↓
     Bot が完全に起動不可能に

【ロールバックする】
開発者：「エラーログを見たら、API_KEYが間違ってる」
     ↓
     「まず前のバージョンに戻そう」
     ↓
     cp -r ~/backups/最新/* ~/git_practice/
     ↓
     pm2 restart discord-bot
     ↓
     Bot復旧（1分）
     ↓
     ローカルで .env を修正
     ↓
     テスト → デプロイ
```

---

**ケース2：時間との戦い**

```
【修正を試みる場合】
エラー発生 → 原因調査（10分）
         → 修正（5分）
         → テスト（5分）
         → 失敗
         → 再度調査（10分）
         → ...
ダウンタイム：30分以上

【ロールバックする場合】
エラー発生 → ロールバック（1分）
         → サービス復旧
         → （後で）ローカルで調査・修正
ダウンタイム：1分
```

---

### 1-2. 「直す」と「戻す」の判断基準

**🔴 すぐに戻すべき状況：**

1. **Botが起動しない**
   - 構文エラー
   - 依存関係の問題
   - 環境変数の問題

2. **主要機能が動かない**
   - /feeling が動かない
   - データベースに接続できない
   - AI応答が返らない

3. **原因が不明**
   - エラーログを見てもよく分からない
   - 複数の場所でエラーが出ている

4. **ユーザーからの問い合わせが来ている**
   - 「Botが動かない」
   - 「エラーが出る」

**💡 判断のポイント：**
> **「5分以内に修正できる自信がない」なら、迷わずロールバック**

---

**🟢 その場で修正してもいい状況：**

1. **原因が明確で、修正が簡単**
   - 設定値の誤り（typoなど）
   - 環境変数の追加忘れ

2. **影響範囲が限定的**
   - 特定のコマンドだけが動かない
   - 主要機能は正常

3. **修正方法が確実**
   - 過去に同じ問題を解決した経験がある
   - ドキュメントに解決方法が明記されている

4. **ロールバックしても解決しない**
   - 外部APIの問題
   - サーバー自体の問題

---

## 第2章：ロールバックの実践（20分）

### 2-1. ロールバックの3つの方法

**方法1：バックアップから復元（最速・最安全）**
- deploy.sh で自動作成されたバックアップを使う
- 1分以内に復旧可能

**方法2：Gitで前のコミットに戻す**
- 特定のコミットだけを取り消す
- Git の知識が必要

**方法3：手動で前のコードをコピー**
- 最終手段

---

### 2-2. 方法1：バックアップから復元（推奨）

**サーバーで実行：**

```bash
# 1. 現在のBotを停止
pm2 stop discord-bot

# 2. バックアップ一覧を確認
ls -lt ~/backups/

# 出力例：
# 20260204_160000  ← 最新（失敗したデプロイ）
# 20260204_150000  ← 1つ前（正常動作していた）
# 20260204_140000

# 3. 正常動作していたバックアップを復元
# 例：20260204_150000
cp -r ~/backups/20260204_150000/* ~/git_practice/

# 4. Botを再起動
pm2 restart discord-bot

# 5. 動作確認
pm2 logs discord-bot
```

**✅ 復元完了：**
- Botが正常に起動
- ユーザーが使える状態に戻った

---

### 2-3. 方法2：Gitで前のコミットに戻す

**サーバーで実行：**

```bash
cd ~/git_practice

# 1. コミット履歴を確認
git log --oneline -5

# 出力例：
# a1b2c3d (HEAD) 新機能追加（← このコミットが問題）
# d4e5f6g 前回のデプロイ（← ここに戻したい）
# g7h8i9j データベース修正
```

**方法2-A：直前のコミットだけを取り消す**

```bash
# 直前のコミットを取り消す（ファイルも戻る）
git reset --hard HEAD~1

# Botを再起動
pm2 restart discord-bot
```

**方法2-B：特定のコミットまで戻る**

```bash
# 特定のコミットまで戻る（例：d4e5f6g）
git reset --hard d4e5f6g

# Botを再起動
pm2 restart discord-bot
```

**⚠️ 注意：**
- `git reset --hard` は取り消せない
- 確実に戻したいコミットを指定すること

---

### 2-4. ロールバック後の手順

**ロールバックが成功したら：**

```bash
# 1. ログを確認
pm2 logs discord-bot

# 2. 動作確認
pm2 status discord-bot

# 3. Discordで実際にコマンドを試す
```

**✅ 確認ポイント：**
- Bot が `online` 状態
- エラーログが出ていない
- コマンドが正常に動作する

---

**次にやること：**

1. **ローカル環境で原因調査**
   ```powershell
   # ローカルPCで
   cd C:\Users\<あなたのユーザー名>\git_practice
   git log --oneline
   # 問題のコミットを特定
   ```

2. **ローカル環境で修正**
   - エラーの原因を特定
   - 修正
   - ローカルでテスト

3. **再デプロイ**
   - コミット・プッシュ
   - サーバーで deploy.sh 実行

---

## 第3章：再起動だけで解決するケース（15分）

### 3-1. 「再起動で直る」パターン

**パターン1：メモリリーク**

```
状況：Botが徐々に遅くなる
    → メモリ使用量が増え続けている

解決：pm2 restart discord-bot
    → メモリがクリアされて正常に戻る
```

**パターン2：一時的な外部API障害**

```
状況：Gemini APIが一時的にダウン
    → Bot が「接続エラー」を出し続ける

解決：API復旧後に pm2 restart discord-bot
    → 正常に戻る
```

**パターン3：データベースのロック**

```
状況：SQLiteのデータベースファイルがロックされている
    → 書き込みができない

解決：pm2 restart discord-bot
    → ロックが解除される
```

---

### 3-2. 再起動の正しい手順

**基本の再起動：**

```bash
pm2 restart discord-bot
```

**強制再起動（応答しない場合）：**

```bash
pm2 delete discord-bot
pm2 start index.js --name discord-bot
```

**再起動 + ログクリア：**

```bash
pm2 restart discord-bot
pm2 flush discord-bot
```

---

### 3-3. 再起動だけでは解決しないケース

**❌ 再起動しても無駄なパターン：**

1. **コードのバグ**
   - 構文エラー
   - ロジックエラー
   → ロールバックまたは修正が必要

2. **環境変数の設定ミス**
   - .env の内容が間違っている
   → .env を修正してから再起動

3. **依存関係の問題**
   - 必要なライブラリがインストールされていない
   → npm install してから再起動

4. **ディスク容量不足**
   - ログファイルでディスクが満杯
   → ログ削除してから再起動

---

## 第4章：トラブル対応のフローチャート（10分）

### 4-1. 判断フローチャート

```
本番でトラブル発生
    ↓
【判断1】Botは起動しているか？
    ├─ YES → 次へ
    └─ NO  → ロールバック or 再起動
             ↓
        【判断1-A】最近デプロイした？
            ├─ YES → ロールバック（方法1）
            └─ NO  → 再起動
                    ↓
                  まだ起動しない？
                    ↓
                  ログ確認 → 原因特定
                    ↓
                  ロールバック
                  
【判断2】主要機能は動いているか？
    ├─ YES → 様子見 or 後で修正
    └─ NO  → 次へ
             ↓
        【判断2-A】5分以内に修正できる？
            ├─ YES → 修正して再起動
            └─ NO  → ロールバック
            
【判断3】ユーザーからの問い合わせは？
    ├─ なし → 後で修正
    └─ あり → ロールバック（被害拡大を防ぐ）
```

---

### 4-2. トラブル対応の優先順位

**優先順位1：サービス復旧**
- 何よりもまず、Botを使える状態に戻す
- ロールバック or 再起動

**優先順位2：被害拡大を防ぐ**
- これ以上ユーザーに影響を与えない
- 問題のある機能を無効化

**優先順位3：原因究明**
- サービス復旧後に、ゆっくり調査
- ローカル環境で再現

**優先順位4：恒久対策**
- 同じ問題が起きないように修正
- テスト・デプロイ

---

### 4-3. トラブル対応の記録

**トラブル対応後、必ず記録を残す：**

**ローカルPCで作業：**

```powershell
cd C:\Users\<あなたのユーザー名>\git_practice
New-Item -ItemType File -Name INCIDENT_LOG.md
code INCIDENT_LOG.md
```

**テンプレート：**

```markdown
# トラブル対応記録

## 2026-02-04 16:00 - Bot起動失敗

### 発生事象
- Bot が起動しない
- pm2 logs でエラー：`Error: Cannot find module 'moment'`

### 影響範囲
- すべての機能が停止
- ユーザーからの問い合わせ：3件

### 対応内容
1. バックアップから復元（20260204_150000）
2. pm2 restart discord-bot
3. サービス復旧（ダウンタイム：2分）

### 原因
- ローカルで `npm install moment` したが、
  サーバーでインストールするのを忘れた

### 恒久対策
- deploy.sh に `npm install` を追加済み
- デプロイ前チェックリストに「新しいライブラリを追加したか？」を追加

### 学んだこと
- 新しいライブラリを追加したら、必ず deploy.sh で npm install される
- ローカルとサーバーで環境を同期させる重要性
```

---

## ✅ この回のチェックリスト

- [ ] 「直す」と「戻す」の判断基準を理解した
- [ ] バックアップからの復元を実行できる
- [ ] Gitでコミットを戻せる
- [ ] 再起動だけで解決するケースを見極められる
- [ ] トラブル対応のフローチャートを理解した
- [ ] トラブル対応記録の書き方を理解した

---

## 🎓 この回で学んだこと

**最重要ポイント：**
> **本番でのトラブルは、「まず止血、原因究明は後」。5分以内に修正できないなら、迷わずロールバック。**

**具体的に学んだこと：**
1. ロールバックの3つの方法
2. 「直す」と「戻す」の判断基準
3. 再起動だけで解決するケース
4. トラブル対応のフローチャート
5. トラブル対応記録の重要性

---

## 📝 次回予告

**第16回：DB設計を変える判断（DB恐怖症の解除）**

フェーズAの安全確保が完了しました。ここからはフェーズB：構造変更に入ります。

次回は：
- データベースのカラム追加・変更
- 既存データの移行判断（残す／捨てる）
- DB変更の現実的なリスクと手順

「データベースを変更するのが怖い」という感覚を、具体的な手順で解消します。

---

## 📦 この回で作成したファイル

### INCIDENT_LOG.md（トラブル対応記録）

```markdown
# トラブル対応記録

記録フォーマット：

## YYYY-MM-DD HH:MM - トラブルの概要

### 発生事象
（何が起きたか）

### 影響範囲
（誰に、どれくらいの影響があったか）

### 対応内容
1. （実際に行った対応の手順）
2. 
3. 

### 原因
（なぜ起きたか）

### 恒久対策
（同じ問題が起きないようにした対策）

### 学んだこと
（今回のトラブルから学んだこと）
```

---

## 🔧 よくある質問

**Q1: ロールバックしたら、ユーザーのデータは消える？**
A: いいえ。データベースファイル（bot.db）はバックアップに含まれていないので、
   ロールバックしてもユーザーのデータは残ります。
   ただし、データベーススキーマを変更した場合は注意が必要です（第16回で学習）。

**Q2: バックアップは何日分保存すべき？**
A: 最低7日分。ディスク容量に余裕があれば14日分。
   古いバックアップは手動で削除してOK。

**Q3: ロールバック後、同じ問題が再発することはある？**
A: いいえ。ロールバックは「正常動作していたバージョンに戻す」ので、
   そのバージョンで動いていた限り、再発しません。
   ただし、外部API障害など、コード以外の問題は別です。

**Q4: Gitでコミットを戻した後、もう一度そのコミットを使いたい場合は？**
A: `git reflog` で削除したコミットのハッシュを確認し、
   `git cherry-pick <ハッシュ>` で復活できます。
   ただし、初心者には難しいので、まずはバックアップからの復元を習得しましょう。

---

これで第15回は完了です！

フェーズA（安全確保）はこれで修了です。次回からはフェーズB（構造変更）に入ります。
