# 第11回：仕様を変えたくなったとき、最初にやること

「この機能を追加したい！」  
「この部分を変更したい！」

その気持ちは大切です。しかし、**いきなりコードを書き始めてはいけません。**

この回では、仕様変更の「入口」を正しく設計する方法を学びます。

---

## 📌 この回の目標

- 仕様変更の影響範囲を書き出せるようになる
- 「今回はやらない」を明確に定義できる
- 実装前に設計を固める習慣をつける

**💡 ポイント：**
- いきなり実装しない
- 書き出して可視化する
- 影響範囲を見積もる

---

## 🎯 完成イメージ

```
【悪い例】
「気分記録に日記機能を追加しよう！」
→ いきなりコードを書き始める
→ 途中で「あれ、これどうしよう？」が増える
→ 中途半端な実装で終わる

【良い例】
「気分記録に日記機能を追加しよう！」
→ 影響範囲を書き出す
→ 「今回はやらない」を決める
→ 実装の優先順位を決める
→ 段階的に実装する
→ 完成する
```

---

## 第1章：なぜ「いきなり実装」はダメなのか（10分）

### 1-1. 実際に起こる問題

**ケース1：「とりあえず作ってみた」の末路**

```
要望：「/feeling の後に、長文の日記も書けるようにしたい」

いきなり実装すると...
- データベースに diary テーブルを追加
- /feeling コマンドに日記入力を追加
- /count コマンドにも日記表示を追加

実装中に気づく問題：
- 日記は何文字まで？
- 過去の日記を見る機能は？
- 日記だけ削除したい場合は？
- 画像も添付できる？
- 日記の検索機能は？
- プライバシー設定は？

→ 次々に「これどうする？」が出てきて、収拾がつかない
```

**なぜこうなる？：**
- 影響範囲を見積もっていない
- 「できること」と「やること」の区別がない
- 優先順位が決まっていない

---

### 1-2. 正しいアプローチ

**同じ要望に対して、正しくアプローチする：**

```
【ステップ1】要望を書き出す
- 気分記録に日記を追加したい

【ステップ2】影響範囲を書き出す
- データベース：diaryカラム or 別テーブル？
- コマンド：/feeling の変更
- コマンド：/count の表示変更
- コマンド：新規で /diary コマンド？
- UI：長文入力の方法
- データ移行：既存データはどうする？

【ステップ3】「今回はやらない」を決める
- 画像添付 → やらない
- 検索機能 → やらない
- 削除機能 → やらない（第2フェーズで検討）
- プライバシー設定 → やらない

【ステップ4】「今回やること」を決める
- /feeling コマンドに note オプションがある（すでにある）
- これを活用して、長文対応にする
- 文字数制限：2000文字（Discord の制限）
- /count での表示は最初の100文字のみ

【ステップ5】実装する
（ここで初めてコードを書く）
```

---

## 第2章：影響範囲の書き出し（15分）

### 2-1. 影響範囲チェックリスト

仕様変更を考えたら、以下をすべてチェックしてください。

**チェックリスト：**

```markdown
## 仕様変更の影響範囲

### 要望
（何を実現したいか、一文で書く）

### データベース
- [ ] 新しいテーブルが必要か？
- [ ] 既存テーブルにカラム追加が必要か？
- [ ] 既存データの移行が必要か？

### コマンド
- [ ] 新しいコマンドを追加するか？
- [ ] 既存コマンドを変更するか？
- [ ] コマンドの引数（オプション）を変更するか？

### 処理ロジック
- [ ] 新しい関数・モジュールが必要か？
- [ ] 既存の関数を変更するか？
- [ ] AI APIの使い方を変更するか？

### 外部連携
- [ ] 新しいAPIを使うか？
- [ ] .env に新しい設定が必要か？

### ユーザー体験
- [ ] 既存ユーザーへの影響はあるか？
- [ ] 操作方法が変わるか？
- [ ] エラーメッセージが変わるか？

### 運用
- [ ] デプロイ時に特別な手順が必要か？
- [ ] ダウンタイムが発生するか？
- [ ] データのバックアップが必要か？
```

---

### 2-2. 実践：影響範囲を書き出してみる

**練習問題：「ユーザーごとにAIの性格を設定できるようにしたい」**

この機能を追加する場合の影響範囲を、実際に書き出してみましょう。

---

#### ステップ1：テンプレートをコピー

**ローカルPC（プロジェクトフォルダ）で実行：**

`SPECIFICATION.md` というファイルを作成します。

<details>
<summary><strong>🪟 Windows の場合</strong></summary>

```powershell
cd C:\Users\<あなたのユーザー名>\git_practice
New-Item -ItemType File -Name SPECIFICATION.md
code SPECIFICATION.md
```

</details>

<details>
<summary><strong>🍎 Mac の場合</strong></summary>

```bash
cd ~/git_practice
touch SPECIFICATION.md
open -a "Visual Studio Code" SPECIFICATION.md
```

</details>

---

#### ステップ2：テンプレートを貼り付ける

`SPECIFICATION.md` に以下をコピー＆ペーストしてください：

```markdown
# 仕様変更：ユーザーごとのAI性格設定

## 要望
ユーザーごとにAIの応答スタイル（優しい、厳しい、フランクなど）を設定できるようにしたい

## データベース
- [ ] 新しいテーブルが必要か？
- [ ] 既存テーブルにカラム追加が必要か？
- [ ] 既存データの移行が必要か？

## コマンド
- [ ] 新しいコマンドを追加するか？
- [ ] 既存コマンドを変更するか？
- [ ] コマンドの引数（オプション）を変更するか？

## 処理ロジック
- [ ] 新しい関数・モジュールが必要か？
- [ ] 既存の関数を変更するか？
- [ ] AI APIの使い方を変更するか？

## 外部連携
- [ ] 新しいAPIを使うか？
- [ ] .env に新しい設定が必要か？

## ユーザー体験
- [ ] 既存ユーザーへの影響はあるか？
- [ ] 操作方法が変わるか？
- [ ] エラーメッセージが変わるか？

## 運用
- [ ] デプロイ時に特別な手順が必要か？
- [ ] ダウンタイムが発生するか？
- [ ] データのバックアップが必要か？

## 今回やること
（リストアップ）

## 今回やらないこと
（リストアップ）

## 実装の優先順位
1. （最優先）
2. （次）
3. （余裕があれば）
```

保存してください。

---

#### ステップ3：チェックリストを埋める

**考えながら、各項目にチェックを入れていきます。**

**例：**

```markdown
## データベース
- [x] 新しいテーブルが必要か？
  → user_ai_settings テーブル（user_id, personality, created_at）
- [ ] 既存テーブルにカラム追加が必要か？
  → 不要
- [ ] 既存データの移行が必要か？
  → 不要（デフォルト設定で動作する）

## コマンド
- [x] 新しいコマンドを追加するか？
  → /ai-personality set <性格タイプ>
  → /ai-personality show（現在の設定を表示）
- [ ] 既存コマンドを変更するか？
  → /ai コマンドは内部で設定を参照するが、使い方は変わらない
- [ ] コマンドの引数（オプション）を変更するか？
  → 不要

## 処理ロジック
- [x] 新しい関数・モジュールが必要か？
  → getPersonalityPrompt(userId) 関数
- [x] 既存の関数を変更するか？
  → ai-helper.js の chat() メソッドにpersonalityを追加
- [ ] AI APIの使い方を変更するか？
  → システムプロンプトに性格設定を追加するだけ

## 外部連携
- [ ] 新しいAPIを使うか？
  → 不要
- [ ] .env に新しい設定が必要か？
  → 不要

## ユーザー体験
- [ ] 既存ユーザーへの影響はあるか？
  → 設定しなければデフォルト（従来通り）で動作
- [ ] 操作方法が変わるか？
  → 新しいコマンドが増えるだけ
- [ ] エラーメッセージが変わるか？
  → 不要

## 運用
- [ ] デプロイ時に特別な手順が必要か？
  → 通常のデプロイでOK
- [ ] ダウンタイムが発生するか？
  → 発生しない
- [x] データのバックアップが必要か？
  → 念のため取る（新テーブル追加のため）
```

---

#### ステップ4：「やること」「やらないこと」を決める

```markdown
## 今回やること
1. user_ai_settings テーブルを作成
2. /ai-personality set コマンドを追加
   - 選択肢：優しい、厳しい、フランク、学術的、デフォルト
3. /ai-personality show コマンドを追加
4. ai-helper.js を変更してpersonalityを反映

## 今回やらないこと
- カスタムプロンプトの自由入力（第2フェーズで検討）
- 会話ごとの性格切り替え（複雑すぎる）
- 管理者による強制設定（要望がないので不要）
- 性格の詳細説明（ヘルプコマンドで対応）

## 実装の優先順位
1. データベーステーブルの作成（基盤）
2. /ai-personality set コマンド（設定機能）
3. ai-helper.js の変更（機能統合）
4. /ai-personality show コマンド（確認機能）
```

---

**🎯 これで「何をするか」が明確になりました！**

このドキュメントを見れば、誰でも：
- 何を実装するか分かる
- 何を実装しないか分かる
- どの順番で実装するか分かる

---

## 第3章：「今回はやらない」の価値（10分）

### 3-1. なぜ「やらないこと」を決めるのか

**理由1：スコープが際限なく広がるのを防ぐ**

```
例：日記機能の実装

「やらないこと」を決めないと...
→ 画像も添付できる？
→ 動画も？
→ 音声メモは？
→ リアクション機能は？
→ コメント機能は？
→ 共有機能は？
→ ...（無限に増える）

「やらないこと」を決めると...
→ テキストのみ、2000文字まで
→ それ以外は「今回はやらない」
→ 実装が明確になる
```

---

**理由2：判断の基準ができる**

実装中に「これもできそう」という誘惑が必ず来ます。

```
実装中：「あれ、日記の編集機能も簡単に作れそう...」

【「やらないこと」リストがない場合】
→ 「簡単だし、やっちゃおうかな」
→ スコープが広がる
→ 完成が遠のく

【「やらないこと」リストがある場合】
→ リストを確認
→ 「今回はやらない」に含まれている
→ 「第2フェーズで検討」と決まっている
→ 今回は実装しない
→ 完成する
```

---

### 3-2. 「やらないこと」の書き方

**良い例：**

```markdown
## 今回やらないこと
- 日記の編集機能（ユースケースが不明確）
- 日記の削除機能（第2フェーズで検討）
- 画像添付（技術的に複雑、優先度低い）
- 日記の公開設定（プライバシー設計が必要、今回は全非公開）
```

**💡 ポイント：**
- 単に「やらない」ではなく、「なぜやらないか」も書く
- 「後でやる」のか「永遠にやらない」のかを明確にする

---

**悪い例：**

```markdown
## 今回やらないこと
- その他
```

**❌ なぜダメ？：**
- 「その他」では何も決まっていない
- 実装中に判断に迷う

---

## 第4章：実装の優先順位（10分）

### 4-1. なぜ優先順位が必要か

すべてを一度に実装すると：
- どこから手をつけるか迷う
- 途中で詰まると全体が止まる
- テストしづらい

**優先順位を決めると：**
- 実装の順番が明確
- 段階的にテストできる
- 途中で止めても、「ここまでは完成」が明確

---

### 4-2. 優先順位の付け方

**基本原則：**

1. **基盤 → 機能 → UI** の順番
2. **依存関係を考慮**（AがないとBが作れない場合、Aを先に）
3. **テストしやすい順番**

---

**例：AI性格設定機能の優先順位**

```markdown
## 実装の優先順位

### 第1フェーズ（最優先・必須）
1. データベーステーブルの作成
   → これがないと何も始まらない
2. /ai-personality set コマンドの実装
   → 設定ができないと機能が使えない

### 第2フェーズ（機能統合）
3. ai-helper.js の変更
   → 設定を実際の応答に反映する

### 第3フェーズ（補助機能）
4. /ai-personality show コマンドの実装
   → 確認用。なくても動作する

### 第4フェーズ（余裕があれば）
5. デフォルト性格の自動検出
   → ユーザーの過去の発言から推測
```

---

**💡 実装のコツ：**
- フェーズ1が完成したらコミット
- フェーズ2が完成したらコミット
- こまめにコミットすると、失敗してもロールバックできる

---

## 第5章：実践演習（10分）

### 5-1. 演習問題

以下の要望について、`SPECIFICATION.md` を作成してください。

**要望：**
「ユーザーが自分の気分記録をCSVファイルでエクスポートできるようにしたい」

---

**作成する内容：**
1. 影響範囲チェックリスト（すべて埋める）
2. 「今回やること」リスト
3. 「今回やらないこと」リスト
4. 実装の優先順位

---

**ヒント：**
- どのコマンドを追加する？
- データベースの変更は必要？
- CSVの形式は？（どの情報を含める？）
- ファイルの送信方法は？（Discordに直接？URLで共有？）

---

### 5-2. 解答例

<details>
<summary><strong>解答例を見る（まず自分で考えてから開いてください）</strong></summary>

```markdown
# 仕様変更：気分記録のCSVエクスポート

## 要望
ユーザーが自分の気分記録をCSVファイルでダウンロードできるようにしたい

## データベース
- [ ] 新しいテーブルが必要か？
  → 不要
- [ ] 既存テーブルにカラム追加が必要か？
  → 不要
- [ ] 既存データの移行が必要か？
  → 不要

## コマンド
- [x] 新しいコマンドを追加するか？
  → /export feelings
- [ ] 既存コマンドを変更するか？
  → 不要
- [ ] コマンドの引数（オプション）を変更するか？
  → 不要

## 処理ロジック
- [x] 新しい関数・モジュールが必要か？
  → exportFeelingsToCSV(userId) 関数
- [ ] 既存の関数を変更するか？
  → 不要
- [ ] AI APIの使い方を変更するか？
  → 不要

## 外部連携
- [ ] 新しいAPIを使うか？
  → 不要
- [ ] .env に新しい設定が必要か？
  → 不要

## ユーザー体験
- [ ] 既存ユーザーへの影響はあるか？
  → なし（新機能の追加のみ）
- [ ] 操作方法が変わるか？
  → 新しいコマンドが増えるだけ
- [ ] エラーメッセージが変わるか？
  → エクスポート失敗時のメッセージが必要

## 運用
- [ ] デプロイ時に特別な手順が必要か？
  → 通常のデプロイでOK
- [ ] ダウンタイムが発生するか？
  → 発生しない
- [ ] データのバックアップが必要か？
  → 不要（読み取りのみ）

## 今回やること
1. /export feelings コマンドを追加
2. feelings テーブルからデータを取得してCSV形式に変換
3. DiscordのAttachmentとしてCSVファイルを送信
4. CSV形式：日付,気分,メモ の3カラム

## 今回やらないこと
- 日付範囲の指定（全期間のエクスポートのみ）
- 他のデータ（AI会話など）のエクスポート（別コマンドで検討）
- エクスポート履歴の記録（不要）
- 自動エクスポート機能（手動のみ）
- JSON/XML形式のサポート（CSV のみ）

## 実装の優先順位
1. データ取得処理（feelings テーブルから全データ取得）
2. CSV変換処理（配列 → CSV文字列）
3. /export コマンドの実装
4. ファイル送信処理（Discord Attachment）
```

</details>

---

## ✅ この回のチェックリスト

- [ ] 仕様変更の影響範囲チェックリストを理解した
- [ ] `SPECIFICATION.md` を自分で作成できる
- [ ] 「今回やること」「今回やらないこと」を明確に書ける
- [ ] 実装の優先順位を考えられる
- [ ] 演習問題を解いた

---

## 🎓 この回で学んだこと

**最重要ポイント：**
> **いきなり実装しない。まず設計する。**

**具体的に学んだこと：**
1. 影響範囲を書き出す重要性
2. 「今回はやらない」を決める価値
3. 実装の優先順位の付け方
4. SPECIFICATION.md の作成方法

---

## 📝 次回予告

**第12回：環境（手元・検証・本番）の違いを意識する**

SPECIFICATION.md ができたら、次は「どの環境で開発・テストするか」を学びます。

いきなり本番環境で実装すると危険です。  
ローカル → 検証 → 本番 の流れを作ります。

---

## 📦 この回で作成したファイル

### SPECIFICATION.md（テンプレート）

**プロジェクトのルートディレクトリに配置：**

```markdown
# 仕様変更：（タイトル）

## 要望
（一文で書く）

## データベース
- [ ] 新しいテーブルが必要か？
- [ ] 既存テーブルにカラム追加が必要か？
- [ ] 既存データの移行が必要か？

## コマンド
- [ ] 新しいコマンドを追加するか？
- [ ] 既存コマンドを変更するか？
- [ ] コマンドの引数（オプション）を変更するか？

## 処理ロジック
- [ ] 新しい関数・モジュールが必要か？
- [ ] 既存の関数を変更するか？
- [ ] AI APIの使い方を変更するか？

## 外部連携
- [ ] 新しいAPIを使うか？
- [ ] .env に新しい設定が必要か？

## ユーザー体験
- [ ] 既存ユーザーへの影響はあるか？
- [ ] 操作方法が変わるか？
- [ ] エラーメッセージが変わるか？

## 運用
- [ ] デプロイ時に特別な手順が必要か？
- [ ] ダウンタイムが発生するか？
- [ ] データのバックアップが必要か？

## 今回やること
1. 
2. 
3. 

## 今回やらないこと
- 
- 
- 

## 実装の優先順位
### 第1フェーズ
1. 

### 第2フェーズ
2. 

### 第3フェーズ
3. 
```

**このテンプレートを使って、今後すべての仕様変更を設計してください。**

---

これで第11回は完了です！

次回（第12回）では、このSPECIFICATION.mdをもとに、実際に「どこで開発・テストするか」を学びます。
