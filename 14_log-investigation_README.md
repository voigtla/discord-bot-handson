# 第14回：本番で何か起きたとき、最初に見る場所を決める

―― ログがないと、判断はできない ――

「Bot が動かない」
「なんか遅い」
「エラーは出てない“らしい”」

この状態でコードを触り始めるのは、
**暗闇で目隠しして修理する**のと同じです。

この回では、
**“原因を当てる”のではなく、“状況を観測する”**
ことだけをやります。

---

## 📌 この回の目標

* 本番トラブル時に **最初に見る場所**が分かる
* 「ログが足りない」状態を自分で作って改善できる
* **直す前に、状況を説明できる**ようになる

**💡 この回の約束**

* 原因究明しない
* いきなり修正しない
* 推測しない

👉 **観測だけ**します。

---

## 🎯 完成イメージ

```
【Before】
Bot が動かない…
たぶんここが怪しい？
→ 勘で修正 → さらに悪化

【After】
Bot が動かない
→ ログを見る
→ どこまで動いているか分かる
→ 判断できる
```

---

## 第1章：「ログがない」と何もできない（10分）

### 1-1. よくある“最悪の状況”

```
Bot が反応しない
↓
サーバーに入る
↓
pm2 restart
↓
まだ動かない
↓
コードを修正
↓
もっと壊れる
```

**この流れの共通点：**

> **何も見ていない**

---

### 1-2. ログの役割は「原因を教える」ではない

ログはこういうものです。

> **「ここまでは動いていた」
> 「ここで止まっている」
> を教えるもの**

* 正解は出さない
* 修正方法も教えない

でも、

> **次の一手を“判断できる状態”にする**

これがログの価値です。

---

## 第2章：本番で最初に見る3点（15分）

### 2-1. 見る順番は固定

トラブル時、**この順番以外は見ない**。

```
① pm2 の状態
② pm2 のログ
③ アプリのログ
```

---

### ① pm2 の状態を見る

```bash
pm2 status
```

**見るポイント**

* online / stopped / errored
* 再起動ループしていないか
* 想定のアプリ名か

👉 **ここで止まっていたら、ログを見る前に理由がある**

---

### ② pm2 のログを見る

```bash
pm2 logs discord-bot --lines 50
```

**見るポイント**

* 最後に出たログ
* エラーが出ているか
* 同じ行がループしていないか

👉 **上から全部読まない。最後から読む。**

---

### ③ アプリのログを見る（自分が出したもの）

第12回で作った `log()` 関数のログが対象です。

```
[INFO] 初期テンプレート準備完了
[INFO] Discord にログインしました
```

**ここで分かること**

* 起動しているか
* どこまで進んだか

---

## 第3章：ログが足りない状態を体験する（15分）

### 3-1. わざと「何も分からない」状態を作る

#### ステップ1：ログを全部消す

```js
// console.log や log() を全部コメントアウト
```

#### ステップ2：Bot を起動

```bash
pm2 restart discord-bot
pm2 logs discord-bot
```

**結果：**

```
（ほぼ何も出ない）
```

---

### 3-2. この状態で起きること

* Bot が動かない理由が分からない
* DBか？APIか？Discordか？
* **何も判断できない**

👉 これが
**「ログがない本番」**。

---

## 第4章：最低限必要なログを入れる（20分）

### 4-1. ログは“全部”いらない

この回で入れるログは **5か所だけ**。

---

### ① 起動開始

```js
log('info', 'Bot 起動開始');
```

---

### ② DB 初期化完了

```js
log('info', 'DB 初期化完了');
```

---

### ③ Discord ログイン完了

```js
client.once('ready', () => {
  log('info', `Discord ログイン完了: ${client.user.tag}`);
});
```

---

### ④ コマンド受付

```js
client.on('interactionCreate', async interaction => {
  log('debug', `コマンド受信: ${interaction.commandName}`);
});
```

---

### ⑤ エラー捕捉

```js
process.on('uncaughtException', err => {
  log('error', `未捕捉エラー: ${err.message}`);
});
```

---

### 4-2. これで分かること

```
Bot 起動開始
DB 初期化完了
Discord ログイン完了
```

* ここまで出ていれば **起動OK**
* 出ていなければ **その手前が原因**

👉 **原因を当てなくていい**

---

## 第5章：ログを使った“判断”演習（15分）

### ケース1：DB 初期化で止まる

```
Bot 起動開始
（DB 初期化完了が出ない）
```

**判断できること**

* DB 周りが怪しい
* Discord や API ではない

---

### ケース2：ログインで止まる

```
Bot 起動開始
DB 初期化完了
（ログイン完了が出ない）
```

**判断できること**

* TOKEN / 権限 / Discord 側
* コード修正は不要かもしれない

---

### ケース3：コマンドが反応しない

```
ログイン完了
（コマンド受信ログが出ない）
```

**判断できること**

* コマンド登録
* ギルドID
* 権限設定

👉 **この時点で“直す場所”が絞れる**

---

## 第6章：この回でやらないこと（重要）

この回では **絶対にやらない**：

* 原因の特定
* 修正
* 最適化
* ログを美しくする

> **観測だけで終了してOK**

---

## ✅ この回のチェックリスト

* [ ] トラブル時に見る順番が言える
* [ ] pm2 status / logs を迷わず使える
* [ ] ログが足りない怖さを体験した
* [ ] 最低限のログを自分で入れた
* [ ] 「直す前に判断する」感覚を持った

---

## 🎓 この回で得たもの

* 勘で修正しなくなる
* 「分からない」が言語化できる
* AIに聞く前に **状況を説明できる**

> **ログはデバッグのためではない
> 判断のためにある**

---

## 📝 次回予告

**第15回：やらかした時に“直さない”選択をする**

次は、

* ログは見た
* 原因も分かった
* でも **今は直せない**

そんな時にどうするか。

> **「戻す」「止める」「放置する」**

を、実際に選びます。