# ç¬¬7å›ï¼šAI ã‚’åˆ©ç”¨ã™ã‚‹ ç¬¬äºŒå› - Bot ã®è’ã‚‰ã—å¯¾ç­–ãƒ»ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã‚’åˆ¶é™ã™ã‚‹

AI æ©Ÿèƒ½ã‚’ **å®‰å…¨ã«é‹ç”¨** ã™ã‚‹ãŸã‚ã«ã€è’ã‚‰ã—å¯¾ç­–ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–ã—ã¾ã™ã€‚

---

## ğŸ“Œ ã“ã®å›ã®ç›®æ¨™

- ã‚¹ãƒ‘ãƒ ãƒ»è’ã‚‰ã—å¯¾ç­–ã‚’å®Ÿè£…ã™ã‚‹
- ä¸é©åˆ‡ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®åˆ¶é™ã‚’å¼·åŒ–ã™ã‚‹
- ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã‚’è¨˜éŒ²ã™ã‚‹

**ğŸ’¡ ãƒã‚¤ãƒ³ãƒˆï¼š**
- AI ã¯ä¾¿åˆ©ã ãŒã€æ‚ªç”¨ã•ã‚Œã‚‹ãƒªã‚¹ã‚¯ã‚‚ã‚ã‚‹
- é©åˆ‡ãªåˆ¶é™ã¨ãƒ­ã‚°ã§å®‰å…¨æ€§ã‚’ç¢ºä¿
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’æãªã‚ãªã„ç¯„å›²ã§é˜²å¾¡

---

## ğŸ¯ å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸

```
ã€ã‚¹ãƒ‘ãƒ æ¤œå‡ºã€‘
ãƒ¦ãƒ¼ã‚¶ãƒ¼: aaaaaaaaaa (é€£æŠ•)
Bot: âš ï¸ ã‚¹ãƒ‘ãƒ è¡Œç‚ºã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚
     ä¸€æ™‚çš„ã«æ©Ÿèƒ½ã‚’åˆ¶é™ã—ã¾ã™ã€‚

ã€ä¸é©åˆ‡ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ¤œå‡ºã€‘
ãƒ¦ãƒ¼ã‚¶ãƒ¼: /ai message:[ä¸é©åˆ‡ãªå†…å®¹]
Bot: âŒ ä¸é©åˆ‡ãªå†…å®¹ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
     ã“ã®Botã¯ãƒ¡ãƒ³ã‚¿ãƒ«ã‚µãƒãƒ¼ãƒˆå°‚ç”¨ã§ã™ã€‚

ã€ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã€‘
ç®¡ç†è€…: /moderation-log
Bot: ğŸ“‹ ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ï¼ˆç›´è¿‘10ä»¶ï¼‰
     2025-02-01 14:30 - user123: ã‚¹ãƒ‘ãƒ æ¤œå‡º
     2025-02-01 13:15 - user456: ä¸é©åˆ‡ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
```

**ğŸ‘‰ Bot ãŒå®‰å…¨ã«é‹ç”¨ã§ãã‚‹çŠ¶æ…‹ã«ãªã‚Šã¾ã™**

---

## ğŸ“š äº‹å‰æº–å‚™

### å¿…è¦ãªã‚‚ã®

- âœ… ç¬¬6å›ã¾ã§ã®å®Œæˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
- âœ… AI æ©Ÿèƒ½ãŒå‹•ä½œã—ã¦ã„ã‚‹çŠ¶æ…‹

---

## ç¬¬1ç« :ã‚¹ãƒ‘ãƒ æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ ï¼ˆ20åˆ†ï¼‰

### 1-1. ã‚¹ãƒ‘ãƒ æ¤œå‡ºç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ

`index.js` ã«è¿½åŠ ï¼š

```javascript
// ã‚¹ãƒ‘ãƒ æ¤œå‡ºç”¨ãƒ†ãƒ¼ãƒ–ãƒ«
db.exec(`
  CREATE TABLE IF NOT EXISTS spam_detection (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    action_type TEXT NOT NULL,
    detected_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    penalty_until DATETIME
  )
`);

// ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«
db.exec(`
  CREATE TABLE IF NOT EXISTS moderation_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    action TEXT NOT NULL,
    reason TEXT,
    moderator_id TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  )
`);
```

---

### 1-2. ã‚¹ãƒ‘ãƒ æ¤œå‡ºãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ

`spam-detector.js` ã‚’æ–°è¦ä½œæˆï¼š

```javascript
const Database = require('better-sqlite3');

class SpamDetector {
  constructor(db) {
    this.db = db;
    
    // ã‚¹ãƒ‘ãƒ åˆ¤å®šã®é–¾å€¤
    this.thresholds = {
      messagesPerMinute: 5,      // 1åˆ†é–“ã«5å›ã¾ã§
      repeatedMessages: 3,        // åŒã˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸3å›ã¾ã§
      shortInterval: 2000,        // 2ç§’æœªæº€ã®é€£æŠ•
      penaltyDuration: 300000     // ãƒšãƒŠãƒ«ãƒ†ã‚£5åˆ†
    };
    
    // ä¸€æ™‚è¨˜æ†¶ï¼ˆãƒ¡ãƒ¢ãƒªå†…ï¼‰
    this.recentMessages = new Map();
  }

  // ã‚¹ãƒ‘ãƒ åˆ¤å®š
  async isSpam(userId, message) {
    // ãƒšãƒŠãƒ«ãƒ†ã‚£ä¸­ã‹ãƒã‚§ãƒƒã‚¯
    if (await this.isPenalized(userId)) {
      return { 
        isSpam: true, 
        reason: 'penalty',
        message: 'ã‚¹ãƒ‘ãƒ è¡Œç‚ºã«ã‚ˆã‚Šä¸€æ™‚çš„ã«åˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚'
      };
    }

    const now = Date.now();
    const userKey = `${userId}`;

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å±¥æ­´ã‚’å–å¾—
    if (!this.recentMessages.has(userKey)) {
      this.recentMessages.set(userKey, []);
    }

    const history = this.recentMessages.get(userKey);

    // å¤ã„å±¥æ­´ã‚’å‰Šé™¤ï¼ˆ1åˆ†ä»¥ä¸Šå‰ï¼‰
    const oneMinuteAgo = now - 60000;
    const recentHistory = history.filter(h => h.timestamp > oneMinuteAgo);

    // ãƒã‚§ãƒƒã‚¯1: 1åˆ†é–“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°
    if (recentHistory.length >= this.thresholds.messagesPerMinute) {
      await this.applyPenalty(userId, 'high_frequency');
      return {
        isSpam: true,
        reason: 'high_frequency',
        message: 'â° ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå¤šã™ãã¾ã™ã€‚å°‘ã—æ™‚é–“ã‚’ç½®ã„ã¦ãã ã•ã„ã€‚'
      };
    }

    // ãƒã‚§ãƒƒã‚¯2: çŸ­æ™‚é–“ã®é€£æŠ•
    if (recentHistory.length > 0) {
      const lastMessage = recentHistory[recentHistory.length - 1];
      const timeDiff = now - lastMessage.timestamp;

      if (timeDiff < this.thresholds.shortInterval) {
        await this.applyPenalty(userId, 'rapid_posting');
        return {
          isSpam: true,
          reason: 'rapid_posting',
          message: 'âš ï¸ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ãŒæ—©ã™ãã¾ã™ã€‚'
        };
      }
    }

    // ãƒã‚§ãƒƒã‚¯3: åŒã˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç¹°ã‚Šè¿”ã—
    const sameMessages = recentHistory.filter(h => h.content === message);
    if (sameMessages.length >= this.thresholds.repeatedMessages) {
      await this.applyPenalty(userId, 'repeated_content');
      return {
        isSpam: true,
        reason: 'repeated_content',
        message: 'ğŸ” åŒã˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¹°ã‚Šè¿”ã•ãªã„ã§ãã ã•ã„ã€‚'
      };
    }

    // å±¥æ­´ã«è¿½åŠ 
    recentHistory.push({ timestamp: now, content: message });
    this.recentMessages.set(userKey, recentHistory);

    return { isSpam: false };
  }

  // ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’é©ç”¨
  async applyPenalty(userId, actionType) {
    const penaltyUntil = new Date(Date.now() + this.thresholds.penaltyDuration);
    
    const stmt = this.db.prepare(`
      INSERT INTO spam_detection (user_id, action_type, penalty_until) 
      VALUES (?, ?, ?)
    `);
    stmt.run(userId, actionType, penaltyUntil.toISOString());

    // ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã«è¨˜éŒ²
    const logStmt = this.db.prepare(`
      INSERT INTO moderation_logs (user_id, action, reason) 
      VALUES (?, 'penalty_applied', ?)
    `);
    logStmt.run(userId, actionType);
  }

  // ãƒšãƒŠãƒ«ãƒ†ã‚£ä¸­ã‹ãƒã‚§ãƒƒã‚¯
  async isPenalized(userId) {
    const stmt = this.db.prepare(`
      SELECT penalty_until 
      FROM spam_detection 
      WHERE user_id = ? 
      AND penalty_until > datetime('now')
      ORDER BY detected_at DESC 
      LIMIT 1
    `);
    const result = stmt.get(userId);
    return !!result;
  }

  // ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’è§£é™¤
  async removePenalty(userId) {
    const stmt = this.db.prepare(`
      UPDATE spam_detection 
      SET penalty_until = datetime('now')
      WHERE user_id = ?
    `);
    stmt.run(userId);
  }

  // çµ±è¨ˆã‚’å–å¾—
  getStats() {
    const stmt = this.db.prepare(`
      SELECT action_type, COUNT(*) as count 
      FROM spam_detection 
      WHERE detected_at > datetime('now', '-7 days')
      GROUP BY action_type
    `);
    return stmt.all();
  }
}

module.exports = SpamDetector;
```

---

### 1-3. index.js ã«çµ±åˆ

```javascript
const SpamDetector = require('./spam-detector');

// ... ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–å¾Œ ...

const spamDetector = new SpamDetector(db);

// /ai ã‚³ãƒãƒ³ãƒ‰ã«çµ±åˆ
if (interaction.commandName === 'ai') {
  const userId = interaction.user.id;
  const userMessage = interaction.options.getString('message');

  // ã‚¹ãƒ‘ãƒ ãƒã‚§ãƒƒã‚¯
  const spamCheck = await spamDetector.isSpam(userId, userMessage);
  if (spamCheck.isSpam) {
    await interaction.reply({
      content: spamCheck.message,
      ephemeral: true
    });
    return;
  }

  // ... æ—¢å­˜ã®AIå‡¦ç† ...
}
```

---

## ç¬¬2ç« ï¼šä¸é©åˆ‡ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆ20åˆ†ï¼‰

### 2-1. ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ

`content-filter.js` ã‚’æ–°è¦ä½œæˆï¼š

```javascript
class ContentFilter {
  constructor() {
    // ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆï¼ˆåŸºæœ¬çš„ãªã‚‚ã®ï¼‰
    this.blockedWords = [
      // æš´åŠ›çš„ãªè¡¨ç¾
      'æ®ºã™', 'ã¶ã£æ®ºã™', 'æ®ºã—ã¦ã‚„ã‚‹',
      
      // å·®åˆ¥çš„ãªè¡¨ç¾ï¼ˆä¾‹ç¤ºã®ã¿ï¼‰
      // å®Ÿéš›ã®é‹ç”¨ã§ã¯ã€ã‚ˆã‚Šè©³ç´°ãªãƒªã‚¹ãƒˆã‚’ç”¨æ„
      
      // Botæ‚ªç”¨
      'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ', 'ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ', 'ignore all previous'
    ];

    // ç¹°ã‚Šè¿”ã—ãƒ‘ã‚¿ãƒ¼ãƒ³
    this.spamPatterns = [
      /(.)\1{9,}/,  // åŒã˜æ–‡å­—10å›ä»¥ä¸Š
      /^[ï½—wWW]{10,}$/,  // wwwww...
      /^[ï¼!ï¼Ÿ?]{5,}$/  // !!!!! or ?????
    ];

    // AI ã‚¸ã‚§ã‚¤ãƒ«ãƒ–ãƒ¬ã‚¤ã‚¯æ¤œå‡º
    this.jailbreakPatterns = [
      /ignore\s+(all\s+)?previous/i,
      /ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç„¡è¦–/i,
      /you\s+are\s+now/i,
      /ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ/i,
      /æ–°ã—ã„æŒ‡ç¤º/i
    ];
  }

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  filter(message) {
    const lowerMessage = message.toLowerCase();

    // ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
    for (const word of this.blockedWords) {
      if (lowerMessage.includes(word)) {
        return {
          allowed: false,
          reason: 'blocked_word',
          message: 'âŒ ä¸é©åˆ‡ãªè¡¨ç¾ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚'
        };
      }
    }

    // ã‚¹ãƒ‘ãƒ ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯
    for (const pattern of this.spamPatterns) {
      if (pattern.test(message)) {
        return {
          allowed: false,
          reason: 'spam_pattern',
          message: 'ğŸ” æ„å‘³ã®ãªã„ç¹°ã‚Šè¿”ã—ã¯é¿ã‘ã¦ãã ã•ã„ã€‚'
        };
      }
    }

    // ã‚¸ã‚§ã‚¤ãƒ«ãƒ–ãƒ¬ã‚¤ã‚¯ãƒã‚§ãƒƒã‚¯
    for (const pattern of this.jailbreakPatterns) {
      if (pattern.test(message)) {
        return {
          allowed: false,
          reason: 'jailbreak_attempt',
          message: 'âš ï¸ ã‚·ã‚¹ãƒ†ãƒ ã®æŒ‡ç¤ºã‚’å¤‰æ›´ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚ã“ã®Botã¯ãƒ¡ãƒ³ã‚¿ãƒ«ã‚µãƒãƒ¼ãƒˆå°‚ç”¨ã§ã™ã€‚'
        };
      }
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é•·ãƒã‚§ãƒƒã‚¯
    if (message.length > 2000) {
      return {
        allowed: false,
        reason: 'too_long',
        message: 'ğŸ“ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé•·ã™ãã¾ã™ï¼ˆ2000æ–‡å­—ä»¥å†…ï¼‰ã€‚'
      };
    }

    return { allowed: true };
  }

  // URLæ¤œå‡º
  hasURL(message) {
    const urlPattern = /(https?:\/\/[^\s]+)/g;
    return urlPattern.test(message);
  }

  // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ¤œå‡º
  hasMentions(message) {
    const mentionPattern = /<@!?\d+>/g;
    return mentionPattern.test(message);
  }
}

module.exports = ContentFilter;
```

---

### 2-2. index.js ã«çµ±åˆ

```javascript
const ContentFilter = require('./content-filter');

const contentFilter = new ContentFilter();

// /ai ã‚³ãƒãƒ³ãƒ‰ã«çµ±åˆ
if (interaction.commandName === 'ai') {
  const userId = interaction.user.id;
  const userMessage = interaction.options.getString('message');

  // ã‚¹ãƒ‘ãƒ ãƒã‚§ãƒƒã‚¯
  const spamCheck = await spamDetector.isSpam(userId, userMessage);
  if (spamCheck.isSpam) {
    await interaction.reply({
      content: spamCheck.message,
      ephemeral: true
    });
    
    // ãƒ­ã‚°ã«è¨˜éŒ²
    const logStmt = db.prepare(`
      INSERT INTO moderation_logs (user_id, action, reason) 
      VALUES (?, 'message_blocked', ?)
    `);
    logStmt.run(userId, spamCheck.reason);
    
    return;
  }

  // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  const filterResult = contentFilter.filter(userMessage);
  if (!filterResult.allowed) {
    await interaction.reply({
      content: filterResult.message,
      ephemeral: true
    });
    
    // ãƒ­ã‚°ã«è¨˜éŒ²
    const logStmt = db.prepare(`
      INSERT INTO moderation_logs (user_id, action, reason) 
      VALUES (?, 'content_filtered', ?)
    `);
    logStmt.run(userId, filterResult.reason);
    
    return;
  }

  // ... æ—¢å­˜ã®AIå‡¦ç† ...
}
```

---

## ç¬¬3ç« ï¼šãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†ã‚³ãƒãƒ³ãƒ‰ï¼ˆ20åˆ†ï¼‰

### 3-1. ã‚³ãƒãƒ³ãƒ‰ã®ç™»éŒ²

`register-commands.js` ã«è¿½åŠ ï¼š

```javascript
{
  name: 'moderation',
  description: 'ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰',
  options: [
    {
      name: 'logs',
      description: 'ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã‚’è¡¨ç¤º',
      type: 1,
      options: [
        {
          name: 'limit',
          description: 'è¡¨ç¤ºä»¶æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 10ï¼‰',
          type: 4,
          required: false
        }
      ]
    },
    {
      name: 'unban',
      description: 'ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’è§£é™¤',
      type: 1,
      options: [
        {
          name: 'user',
          description: 'å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼',
          type: 6, // USERå‹
          required: true
        }
      ]
    },
    {
      name: 'stats',
      description: 'ã‚¹ãƒ‘ãƒ çµ±è¨ˆã‚’è¡¨ç¤º',
      type: 1
    },
    {
      name: 'add-word',
      description: 'ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰ã‚’è¿½åŠ ',
      type: 1,
      options: [
        {
          name: 'word',
          description: 'è¿½åŠ ã™ã‚‹ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰',
          type: 3,
          required: true
        }
      ]
    }
  ]
}
```

**ã‚³ãƒãƒ³ãƒ‰å†ç™»éŒ²ï¼š**
```bash
node register-commands.js
```

---

### 3-2. ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè£…

```javascript
if (interaction.commandName === 'moderation') {
  // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
  if (!interaction.member.permissions.has('ManageMessages')) {
    await interaction.reply({ content: 'ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ç®¡ç†è€…ã®ã¿ä½¿ç”¨ã§ãã¾ã™ã€‚', ephemeral: true });
    return;
  }

  const subcommand = interaction.options.getSubcommand();

  // ãƒ­ã‚°è¡¨ç¤º
  if (subcommand === 'logs') {
    const limit = interaction.options.getInteger('limit') || 10;
    
    const stmt = db.prepare(`
      SELECT user_id, action, reason, created_at 
      FROM moderation_logs 
      ORDER BY created_at DESC 
      LIMIT ?
    `);
    const logs = stmt.all(limit);

    if (logs.length === 0) {
      await interaction.reply('ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
      return;
    }

    let message = `**ğŸ“‹ ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ï¼ˆç›´è¿‘${limit}ä»¶ï¼‰**\n\n`;
    logs.forEach(log => {
      const date = new Date(log.created_at).toLocaleString('ja-JP');
      message += `${date}\n`;
      message += `ãƒ¦ãƒ¼ã‚¶ãƒ¼: <@${log.user_id}>\n`;
      message += `ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ${log.action}\n`;
      message += `ç†ç”±: ${log.reason}\n\n`;
    });

    await interaction.reply(message);
  }

  // ãƒšãƒŠãƒ«ãƒ†ã‚£è§£é™¤
  if (subcommand === 'unban') {
    const targetUser = interaction.options.getUser('user');
    
    await spamDetector.removePenalty(targetUser.id);
    
    const logStmt = db.prepare(`
      INSERT INTO moderation_logs (user_id, action, reason, moderator_id) 
      VALUES (?, 'penalty_removed', 'manual_unban', ?)
    `);
    logStmt.run(targetUser.id, interaction.user.id);

    await interaction.reply(`âœ… <@${targetUser.id}> ã®ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’è§£é™¤ã—ã¾ã—ãŸã€‚`);
  }

  // ã‚¹ãƒ‘ãƒ çµ±è¨ˆ
  if (subcommand === 'stats') {
    const stats = spamDetector.getStats();

    if (stats.length === 0) {
      await interaction.reply('éå»7æ—¥é–“ã®ã‚¹ãƒ‘ãƒ æ¤œå‡ºã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
      return;
    }

    let message = '**ğŸ“Š ã‚¹ãƒ‘ãƒ çµ±è¨ˆï¼ˆéå»7æ—¥é–“ï¼‰**\n\n';
    stats.forEach(stat => {
      const actionName = {
        high_frequency: 'é«˜é »åº¦æŠ•ç¨¿',
        rapid_posting: 'é€£æŠ•',
        repeated_content: 'ç¹°ã‚Šè¿”ã—'
      }[stat.action_type] || stat.action_type;

      message += `${actionName}: ${stat.count}å›\n`;
    });

    await interaction.reply(message);
  }

  // ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰è¿½åŠ ï¼ˆç°¡æ˜“ç‰ˆï¼‰
  if (subcommand === 'add-word') {
    const word = interaction.options.getString('word');
    
    // å®Ÿéš›ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã™ã¹ãã§ã™ãŒã€ã“ã“ã§ã¯ç°¡æ˜“çš„ã«
    contentFilter.blockedWords.push(word);
    
    await interaction.reply({
      content: `âœ… ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰ã€Œ${word}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚\nâš ï¸ Botå†èµ·å‹•å¾Œã¯å¤±ã‚ã‚Œã¾ã™ã€‚`,
      ephemeral: true
    });
  }
}
```

---

## ç¬¬4ç« ï¼šAIå¿œç­”ã®ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ15åˆ†ï¼‰

### 4-1. AIå¿œç­”ã®ãƒã‚§ãƒƒã‚¯

AI ã‹ã‚‰ã®å¿œç­”ã‚‚ä¸é©åˆ‡ã§ãªã„ã‹ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ï¼š

```javascript
// ai-helper.js ã«è¿½åŠ 
async chat(userMessage, context = []) {
  try {
    // ... æ—¢å­˜ã®å‡¦ç† ...

    const result = await this.model.generateContent(fullPrompt);
    const response = await result.response;
    const text = response.text();

    // AIå¿œç­”ã®å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯
    if (this.containsUnsafeContent(text)) {
      return {
        success: false,
        message: 'ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€‚é©åˆ‡ãªå¿œç­”ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚åˆ¥ã®è³ªå•ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚',
        filtered: true
      };
    }

    return {
      success: true,
      message: text,
      tokensUsed: response.usageMetadata?.totalTokenCount || 0
    };
  } catch (error) {
    // ... ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° ...
  }
}

// å±é™ºãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ¤œå‡º
containsUnsafeContent(text) {
  const unsafePatterns = [
    /è¨ºæ–­ã—ã¾ã™?/,
    /è–¬ã‚’?.*?é£²/,
    /ç—…é™¢ã«?.*?è¡Œããª/,
    /åŒ»å¸«.*?å¿…è¦ãªã„/
  ];

  return unsafePatterns.some(pattern => pattern.test(text));
}
```

---

## ç¬¬5ç« ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼é€šå ±æ©Ÿèƒ½ï¼ˆ10åˆ†ï¼‰

### 5-1. /report ã‚³ãƒãƒ³ãƒ‰ã®ç™»éŒ²

```javascript
{
  name: 'report',
  description: 'ä¸é©åˆ‡ãªå‹•ä½œã‚’å ±å‘Šã—ã¾ã™',
  options: [
    {
      name: 'type',
      description: 'å ±å‘Šã®ç¨®é¡',
      type: 3,
      required: true,
      choices: [
        { name: 'ã‚¹ãƒ‘ãƒ ', value: 'spam' },
        { name: 'ä¸é©åˆ‡ãªAIå¿œç­”', value: 'inappropriate_ai' },
        { name: 'ãƒã‚°', value: 'bug' },
        { name: 'ãã®ä»–', value: 'other' }
      ]
    },
    {
      name: 'detail',
      description: 'è©³ç´°ï¼ˆä»»æ„ï¼‰',
      type: 3,
      required: false
    }
  ]
}
```

---

### 5-2. /report ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè£…

```javascript
if (interaction.commandName === 'report') {
  const reportType = interaction.options.getString('type');
  const detail = interaction.options.getString('detail') || 'ãªã—';
  const userId = interaction.user.id;

  // å ±å‘Šã‚’è¨˜éŒ²
  const stmt = db.prepare(`
    INSERT INTO moderation_logs (user_id, action, reason) 
    VALUES (?, 'user_report', ?)
  `);
  stmt.run(userId, `${reportType}: ${detail}`);

  await interaction.reply({
    content: 'âœ… å ±å‘Šã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚',
    ephemeral: true
  });

  // ç®¡ç†è€…ã«é€šçŸ¥ï¼ˆãƒãƒ£ãƒ³ãƒãƒ«IDã¯ç’°å¢ƒå¤‰æ•°ã§è¨­å®šï¼‰
  const adminChannelId = process.env.ADMIN_CHANNEL_ID;
  if (adminChannelId) {
    const adminChannel = await client.channels.fetch(adminChannelId);
    if (adminChannel) {
      await adminChannel.send(`ğŸš¨ **ãƒ¦ãƒ¼ã‚¶ãƒ¼å ±å‘Š**\nå ±å‘Šè€…: <@${userId}>\nç¨®é¡: ${reportType}\nè©³ç´°: ${detail}`);
    }
  }
}
```

---

## ç¬¬6ç« ï¼šGit ã§è¨˜éŒ²ï¼ˆ5åˆ†ï¼‰

```bash
git add .
git commit -m "ç¬¬7å›: è’ã‚‰ã—å¯¾ç­–+ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å®Ÿè£…"
git push
```

---

## âœ… ã“ã®å›ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] ã‚¹ãƒ‘ãƒ æ¤œå‡ºãŒå‹•ä½œã—ãŸ
- [ ] ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãŒå‹•ä½œã—ãŸ
- [ ] ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ãŒè¨˜éŒ²ã•ã‚ŒãŸ
- [ ] `/moderation` ã‚³ãƒãƒ³ãƒ‰ãŒå‹•ä½œã—ãŸ
- [ ] `/report` ã‚³ãƒãƒ³ãƒ‰ãŒå‹•ä½œã—ãŸ
- [ ] Git ã«ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ã§ããŸ

---

## ğŸ” ä»Šæ—¥è¦šãˆã‚‹ã“ã¨

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®åŸºæœ¬

- å¤šå±¤é˜²å¾¡ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰
- ãƒ­ã‚°ã®é‡è¦æ€§
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å ±å‘Šæ©Ÿèƒ½

### ã‚¹ãƒ‘ãƒ å¯¾ç­–

- é »åº¦åˆ¶é™
- ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º
- ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚·ã‚¹ãƒ†ãƒ 

### ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

- ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ
- æ­£è¦è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³
- AIå¿œç­”ã®ãƒã‚§ãƒƒã‚¯

---

## âš ï¸ ã‚ˆãã‚ã‚‹ãƒˆãƒ©ãƒ–ãƒ«

### èª¤æ¤œå‡ºãŒå¤šã„

**å¯¾å‡¦æ³•ï¼š**
1. é–¾å€¤ã‚’èª¿æ•´
2. ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã‚’è¿½åŠ 
3. ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã§ç¢ºèª

---

### ãƒšãƒŠãƒ«ãƒ†ã‚£ãŒè§£é™¤ã•ã‚Œãªã„

**å¯¾å‡¦æ³•ï¼š**
```javascript
await spamDetector.removePenalty(userId);
```

---

## ğŸ“Š ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### ãƒãƒ©ãƒ³ã‚¹ãŒé‡è¦

- **å³ã—ã™ãã‚‹** â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ãŒæ‚ªåŒ–
- **ç·©ã™ãã‚‹** â†’ è’ã‚‰ã—ãŒå¢—ãˆã‚‹

### å®šæœŸçš„ãªè¦‹ç›´ã—

1. ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã‚’ç¢ºèª
2. èª¤æ¤œå‡ºã‚’åˆ†æ
3. ãƒ«ãƒ¼ãƒ«ã‚’èª¿æ•´

### é€æ˜æ€§

- ãƒšãƒŠãƒ«ãƒ†ã‚£ç†ç”±ã‚’æ˜ç¤º
- è§£é™¤æ–¹æ³•ã‚’æ¡ˆå†…
- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å—ã‘ä»˜ã‘ã‚‹

---

## ğŸ“ ç™ºå±•èª²é¡Œï¼ˆè‡ªç¿’ç”¨ï¼‰

1. **è‡ªå‹•å­¦ç¿’**
   - ã‚¹ãƒ‘ãƒ ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è‡ªå‹•æ¤œå‡º

2. **æ®µéšçš„ãƒšãƒŠãƒ«ãƒ†ã‚£**
   - åˆå›: è­¦å‘Š
   - 2å›ç›®: 5åˆ†ãƒšãƒŠãƒ«ãƒ†ã‚£
   - 3å›ç›®: 1æ™‚é–“ãƒšãƒŠãƒ«ãƒ†ã‚£

3. **IPåˆ¶é™**
   - åŒä¸€IPã‹ã‚‰ã®å¤§é‡ã‚¢ã‚¯ã‚»ã‚¹æ¤œå‡º

---

## æ¬¡å›äºˆå‘Š

### ç¬¬8å›ï¼šã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¦ã‚‚å®‰å…¨ã«çµ‚ã‚ã‚‹ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰

æœ¬ç•ªç’°å¢ƒã‚’æƒ³å®šã—ãŸå …ç‰¢æ€§ï¼š
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
- ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
- ã‚ã–ã¨å±ãªã„å®Ÿè£…ã‚’ä½“é¨“

**ğŸ‘‰ Bot ãŒå£Šã‚Œãªã„ä»•çµ„ã¿ã‚’ä½œã‚Šã¾ã™ï¼**
