# 第16回：DB設計を「変える」判断をする

―― DBは聖域ではない ――

Bot は動いている。
ユーザーもいる。
データも入っている。

でも──
**仕様を足したくなった瞬間、DBが怖くなる。**

この回では、

* きれいな設計は目指さない
* 正規化もしない
* ベストプラクティスも探さない

👉 **「変えていいDB」と「変え方」を体で覚えます。**

---

## 📌 この回の目標

* 既存データがある DB を **実際に変更する**
* データを「残す／捨てる」を判断できる
* DB変更＝即死ではないと理解する

**💡 この回の約束**

* 新しいDBは使わない
* ORMは入れない
* 理論説明しない

👉 **SQLiteをそのまま殴る回**です。

---

## 🎯 完成イメージ

```
【Before】
DB怖い…
触ったら壊れそう
→ 仕様追加できない

【After】
DB変えた
データも残った
壊れても戻せる
→ 判断できる
```

---

## 第1章：なぜDBは怖くなるのか（10分）

### 1-1. DBが怖くなる瞬間

* カラムを足したい
* データ形式を変えたい
* 使ってない列がある

このとき頭に浮かぶのは：

> 「壊れたら終わる」

---

### 1-2. 現実のDBはこう扱われている

* 完璧ではない
* 途中で変わる
* 使われなくなる列が残る

👉 **設計が綺麗＝正義ではない**

---

## 第2章：今回やるDB変更の内容（5分）

この回でやるのは **この3つだけ**。

1. カラムを追加する
2. 既存データをそのまま使う
3. 壊れたら戻す

**削除はしません（今回は）**

---

## 第3章：現状のDBを確認する（10分）

### 3-1. テーブル構造を見る

```bash
sqlite3 data/bot.db
```

```sql
.schema
```

例：

```sql
CREATE TABLE feelings (
  id INTEGER PRIMARY KEY,
  user_id TEXT,
  feeling TEXT,
  created_at TEXT
);
```

---

### 3-2. 何が足りないか考える（1分）

例：

* どのサーバーか分からない
* 強度（level）を持ちたい
* メモを付けたい

👉 **今回は理由はいらない**
👉 *「足したい」でOK*

---

## 第4章：カラムを追加する（15分）

### 4-1. ALTER TABLE を実行する

例：`note` カラムを追加

```sql
ALTER TABLE feelings ADD COLUMN note TEXT;
```

確認：

```sql
.schema feelings
```

---

### 4-2. 既存データを確認する

```sql
SELECT * FROM feelings LIMIT 3;
```

結果：

```
note が NULL
```

👉 **これでOK**

---

## 第5章：コード側を“雑に”対応する（15分）

### 5-1. INSERT を少しだけ変える

```js
db.run(
  'INSERT INTO feelings (user_id, feeling, note, created_at) VALUES (?, ?, ?, ?)',
  [userId, feeling, note ?? null, createdAt]
);
```

**ポイント**

* NULL を許容する
* 既存データを気にしない

---

### 5-2. SELECT はそのままでも動く

```js
SELECT user_id, feeling FROM feelings;
```

👉 **新しい列は無視される**

---

## 第6章：わざと失敗してみる（15分）

### 6-1. コードだけ先に変える（DB未変更）

```js
INSERT INTO feelings (user_id, feeling, note, created_at)
```

### 6-2. Bot を起動

```bash
pm2 restart discord-bot
pm2 logs discord-bot
```

**結果**

* エラーが出る
* Bot が止まる

---

### 6-3. 判断する

* 修正する？
* ロールバック？
* DBを先に変える？

👉 **前回（第15回）の判断を使う**

---

## 第7章：この回で一番大事な判断（10分）

### 7-1. DB変更で毎回考える3点

* 既存データは **守る？捨てる？**
* 今回の変更は **一時的？恒久的？**
* 失敗したら **戻せる？**

---

### 7-2. この回の結論

> **DB設計は“固定物”ではない**
> **変更できる前提で付き合うもの**

---

## 第8章：この回でやらないこと

* 正規化
* マイグレーションツール導入
* 綺麗な設計

👉 **それは次のフェーズ**

---

## ✅ この回のチェックリスト

* [ ] ALTER TABLE を実行した
* [ ] NULL を許容した設計を作った
* [ ] 既存データを壊さずに動かした
* [ ] DB変更の怖さが減った
* [ ] 「変えていい」と判断できた

---

## 🎓 この回で得たもの

* DBは触っていい対象になる
* 設計が「判断」に変わる
* 仕様追加が止まらなくなる

> **DBが怖いのは、
> 触ったことがないから**

---

## 📝 次回予告

**第17回：本番データを守る（捨てる）判断をする**

次は、

* このデータは守る価値がある？
* 壊れたら終わり？
* バックアップは必要？

を、**実際にバックアップして復元します**。