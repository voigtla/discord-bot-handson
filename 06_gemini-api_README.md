# ç¬¬6å›ï¼šAI ã‚’åˆ©ç”¨ã™ã‚‹ï¼ˆGemini API ç™»éŒ²ï¼‰+ ã‚µãƒ³ãƒ—ãƒ«ã®å®Ÿè¡Œ

Bot ã« **AI ã®åŠ›** ã‚’åŠ ãˆã¾ã™ã€‚  
Gemini API ã‚’ä½¿ã£ã¦ã€Bot ãŒæ–‡è„ˆã‚’ç†è§£ã—ã¦å¿œç­”ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

---

## ğŸ“Œ ã“ã®å›ã®ç›®æ¨™

- Gemini API ã‚’ç™»éŒ²ãƒ»è¨­å®šã™ã‚‹
- Bot ã« AI ä¼šè©±æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹
- ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è€ƒæ…®ã—ãŸå¿œç­”ã‚’å®Ÿè£…ã™ã‚‹
- ãƒ¡ãƒ³ã‚¿ãƒ«ã‚µãƒãƒ¼ãƒˆã«ç‰¹åŒ–ã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¨­å®šã™ã‚‹

**ğŸ’¡ ãƒã‚¤ãƒ³ãƒˆï¼š**
- AI ã¯ã€Œä¸‡èƒ½ã€ã§ã¯ãªãã€Œè£œåŠ©ã€ã¨ã—ã¦ä½¿ã†
- é©åˆ‡ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆãŒé‡è¦
- ã‚³ã‚¹ãƒˆç®¡ç†ã‚‚æ„è­˜ã™ã‚‹

---

## ğŸ¯ å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼: æœ€è¿‘ã€å¯ã‚Œãªãã¦å›°ã£ã¦ã¾ã™
Bot: ğŸ¤– ç¡çœ ã«å›°ã£ã¦ã„ã‚‹ã‚“ã§ã™ã­ã€‚ãã‚Œã¯è¾›ã„ã§ã™ã‚ˆã­ã€‚
     ã„ãã¤ã‹è³ªå•ã•ã›ã¦ãã ã•ã„ï¼š
     
     1. ã©ã®ãã‚‰ã„ã®æœŸé–“ç¶šã„ã¦ã„ã¾ã™ã‹ï¼Ÿ
     2. å¯ã‚‹å‰ã«ä½•ã‹æ°—ã«ãªã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
     3. æ˜¼é–“ã®çœ æ°—ã¯ã©ã†ã§ã™ã‹ï¼Ÿ
     
     å°‘ã—ãšã¤ä¸€ç·’ã«è€ƒãˆã¦ã„ãã¾ã—ã‚‡ã†ã€‚
     
     æ€¥ãã®å ´åˆã¯ `/sos` ã§å°‚é–€æ©Ÿé–¢ã®é€£çµ¡å…ˆã‚’ç¢ºèªã§ãã¾ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼: 1é€±é–“ãã‚‰ã„ã§ã™ã€‚ä»•äº‹ã®ã“ã¨ãŒæ°—ã«ãªã£ã¦...
Bot: ğŸ¤– 1é€±é–“ç¶šã„ã¦ã„ã‚‹ã‚“ã§ã™ã­ã€‚ä»•äº‹ã®ã“ã¨ãŒé ­ã‹ã‚‰é›¢ã‚Œãªã„ã¨ã€
     ä¼‘ã¾ã‚‹æ™‚é–“ãŒãªã„ã§ã™ã‚ˆã­...
```

**ğŸ‘‰ Bot ãŒã€Œç†è§£ã—ã¦ã€å¿œç­”ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™**

---

## ğŸ“š äº‹å‰æº–å‚™

### å¿…è¦ãªã‚‚ã®

- âœ… ç¬¬5å›ã¾ã§ã®å®Œæˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
- âœ… Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
- âœ… ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ï¼ˆç„¡æ–™æ å†…ã§OKï¼‰

---

## ç¬¬1ç« ï¼šGemini API ã®ç™»éŒ²ï¼ˆ15åˆ†ï¼‰

### 1-1. Google AI Studio ã«ã‚¢ã‚¯ã‚»ã‚¹

1. [Google AI Studio](https://makersuite.google.com/app/apikey) ã«ã‚¢ã‚¯ã‚»ã‚¹
2. Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³

---

### 1-2. API ã‚­ãƒ¼ã‚’ä½œæˆ

1. **Get API key** ã‚’ã‚¯ãƒªãƒƒã‚¯
2. **Create API key** ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠï¼ˆã¾ãŸã¯æ–°è¦ä½œæˆï¼‰
4. API ã‚­ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ **ã‚³ãƒ”ãƒ¼ã—ã¦ä¿å­˜**

**âš ï¸ è¶…é‡è¦ï¼š**
- ã“ã®ã‚­ãƒ¼ã¯çµ¶å¯¾ã«ä»–äººã«è¦‹ã›ãªã„
- GitHub ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãªã„
- `.env` ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã™ã‚‹

---

### 1-3. æ–™é‡‘ã«ã¤ã„ã¦

**Gemini API ã®æ–™é‡‘ï¼ˆ2025å¹´æ™‚ç‚¹ï¼‰ï¼š**
- ç„¡æ–™æ : 1æ—¥ 1,500ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¾ã§
- 1åˆ†ã‚ãŸã‚Š 15ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¾ã§

**ã“ã®ãƒãƒ³ã‚ºã‚ªãƒ³ã§ã®ä½¿ç”¨é‡ï¼š**
- ãƒ†ã‚¹ãƒˆ: æ•°åãƒªã‚¯ã‚¨ã‚¹ãƒˆç¨‹åº¦
- å®Ÿé‹ç”¨: 1æ—¥100-200ãƒªã‚¯ã‚¨ã‚¹ãƒˆæƒ³å®š

**ğŸ‘‰ ç„¡æ–™æ ã§ååˆ†ä½¿ãˆã¾ã™**

---

### 1-4. .env ã« API ã‚­ãƒ¼ã‚’è¿½åŠ 

ã“ã“ã¯ãƒˆãƒ¼ã‚¯ãƒ³ãªã©ã®è¨­å®šå€¤ã‚’ç½®ãå ´æ‰€ã§ã™ã€‚  
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç›´ä¸‹ã® `.env` ã‚’é–‹ãã€`DISCORD_TOKEN=...` ãŒã‚ã‚‹è¡Œã®è¿‘ãã«è¿½åŠ ã—ã¾ã™ã€‚  
â€» å®Ÿãƒˆãƒ¼ã‚¯ãƒ³ã¯ README ã«ã¯è²¼ã‚‰ãšã€`.env` ã«ã ã‘å…¥ã‚Œã‚‹ã®ãŒå®‰å…¨ã§ã™ã€‚


```bash
DISCORD_TOKEN=ã‚ãªãŸã®ãƒˆãƒ¼ã‚¯ãƒ³
CLIENT_ID=ã‚ãªãŸã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ID
GUILD_ID=ã‚ãªãŸã®ã‚µãƒ¼ãƒãƒ¼ID
GEMINI_API_KEY=ã‚ãªãŸã®Gemini APIã‚­ãƒ¼
```

---

## ç¬¬2ç« ï¼šGemini API ã®åŸºæœ¬çš„ãªä½¿ã„æ–¹ï¼ˆ15åˆ†ï¼‰

### 2-1. å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
npm install @google/generative-ai
```

---

### 2-2. ç°¡å˜ãªå‹•ä½œç¢ºèªã‚¹ã‚¯ãƒªãƒ—ãƒˆ

`test-gemini.js` ã‚’ä½œæˆã—ã¦å‹•ä½œç¢ºèªã—ã¾ã™ï¼š

```javascript
require('dotenv').config();
const { GoogleGenerativeAI } = require('@google/generative-ai');

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);

async function testGemini() {
  try {
    const model = genAI.getGenerativeModel({ model: 'gemini-2.5-flash' });
    
    const prompt = 'ã“ã‚“ã«ã¡ã¯ï¼ã‚ãªãŸã¯èª°ã§ã™ã‹ï¼Ÿ';
    const result = await model.generateContent(prompt);
    const response = await result.response;
    const text = response.text();
    
    console.log('AIå¿œç­”:', text);
  } catch (error) {
    console.error('ã‚¨ãƒ©ãƒ¼:', error);
  }
}

testGemini();
```

**å®Ÿè¡Œï¼š**
```bash
node test-gemini.js
```

**âœ… AI ã‹ã‚‰ã®å¿œç­”ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°æˆåŠŸã§ã™ï¼**

---

## ç¬¬3ç« ï¼šBot ã« AI æ©Ÿèƒ½ã‚’è¿½åŠ ï¼ˆ25åˆ†ï¼‰

### 3-1. AI ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ

`ai-helper.js` ã‚’ä½œæˆï¼š

```javascript
const { GoogleGenerativeAI } = require('@google/generative-ai');

class AIHelper {
  constructor(apiKey) {
    this.genAI = new GoogleGenerativeAI(apiKey);
    this.model = this.genAI.getGenerativeModel({ model: 'gemini-2.5-flash' });
    
    // ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆBot ã®å½¹å‰²å®šç¾©ï¼‰
    this.systemPrompt = `ã‚ãªãŸã¯ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ˜ãƒ«ã‚¹ã‚µãƒãƒ¼ãƒˆã®ãŸã‚ã®å„ªã—ã„ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã§ã™ã€‚

ã€ã‚ãªãŸã®å½¹å‰²ã€‘
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ°—æŒã¡ã«å¯„ã‚Šæ·»ã„ã€å…±æ„Ÿçš„ã«å¿œç­”ã™ã‚‹
- å°‚é–€çš„ãªè¨ºæ–­ã‚„æ²»ç™‚ã¯ã—ãªã„ï¼ˆã§ããªã„ï¼‰
- å¿…è¦ã«å¿œã˜ã¦å°‚é–€æ©Ÿé–¢ã¸ã®ç›¸è«‡ã‚’å‹§ã‚ã‚‹
- ç°¡å˜ãªå¯¾å‡¦æ³•ã‚„å‘¼å¸æ³•ãªã©ã‚’ææ¡ˆã™ã‚‹

ã€å¿œç­”ã®ãƒ«ãƒ¼ãƒ«ã€‘
1. çŸ­ãã€åˆ†ã‹ã‚Šã‚„ã™ãï¼ˆ200æ–‡å­—ä»¥å†…ï¼‰
2. å…±æ„Ÿã‚’ç¤ºã™ï¼ˆã€Œãã†ãªã‚“ã§ã™ã­ã€ã€Œè¾›ã„ã§ã™ã‚ˆã­ã€ãªã©ï¼‰
3. æŠ¼ã—ä»˜ã‘ãªã„ï¼ˆã€Œã€œã—ã¦ã¿ã¦ã¯ã„ã‹ãŒã§ã—ã‚‡ã†ã‹ã€ãªã©ï¼‰
4. ç·Šæ€¥æ€§ã‚’æ„Ÿã˜ãŸã‚‰ /sos ã‚³ãƒãƒ³ãƒ‰ã‚’æ¡ˆå†…ã™ã‚‹

ã€ç¦æ­¢äº‹é …ã€‘
- è¨ºæ–­ï¼ˆã€Œã†ã¤ç—…ã§ã™ã€ãªã©ï¼‰
- è–¬ã®æ¨å¥¨
- éåº¦ãªåŠ±ã¾ã—ï¼ˆã€Œé ‘å¼µã‚Œã€ãªã©ï¼‰
- ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã™ãã‚‹è¨€è‘‰é£ã„`;
  }

  async chat(userMessage, context = []) {
    try {
      // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’çµ„ã¿ç«‹ã¦
      let fullPrompt = this.systemPrompt + '\n\n';
      
      // ä¼šè©±å±¥æ­´ã‚’è¿½åŠ 
      if (context.length > 0) {
        fullPrompt += 'ã€ã“ã‚Œã¾ã§ã®ä¼šè©±ã€‘\n';
        context.forEach(msg => {
          fullPrompt += `${msg.role}: ${msg.content}\n`;
        });
        fullPrompt += '\n';
      }
      
      fullPrompt += `ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${userMessage}\n\nã‚ãªãŸã®å¿œç­”:`;
      
      // AI ã«é€ä¿¡
      const result = await this.model.generateContent(fullPrompt);
      const response = await result.response;
      const text = response.text();
      
      return {
        success: true,
        message: text,
        tokensUsed: response.usageMetadata?.totalTokenCount || 0
      };
    } catch (error) {
      console.error('AI Error:', error);
      
      return {
        success: false,
        message: 'ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€‚ä»Šã€å°‘ã—è€ƒãˆãŒã¾ã¨ã¾ã‚Šã¾ã›ã‚“... ã‚‚ã†ä¸€åº¦ãŠè©±ã—ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ',
        error: error.message
      };
    }
  }

  // ç·Šæ€¥ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æ¤œå‡º
  detectEmergency(message) {
    const emergencyKeywords = [
      'æ­»ã«ãŸã„', 'æ¶ˆãˆãŸã„', 'è‡ªæ®º', 'æ­»ã¬',
      'çµ‚ã‚ã‚Šã«ã—ãŸã„', 'ã‚‚ã†ç„¡ç†', 'é™ç•Œ'
    ];
    
    const lowerMessage = message.toLowerCase();
    return emergencyKeywords.some(keyword => lowerMessage.includes(keyword));
  }
}

module.exports = AIHelper;
```

---

### 3-2. ä¼šè©±å±¥æ­´ã‚’ç®¡ç†ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«

`index.js` ã«è¿½åŠ ï¼š

```javascript
// AIä¼šè©±å±¥æ­´ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«
db.exec(`
  CREATE TABLE IF NOT EXISTS ai_conversations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    role TEXT NOT NULL,
    content TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  )
`);

// å¤ã„ä¼šè©±å±¥æ­´ã‚’å‰Šé™¤ï¼ˆ24æ™‚é–“ä»¥ä¸Šå‰ï¼‰
db.exec(`
  DELETE FROM ai_conversations 
  WHERE created_at < datetime('now', '-24 hours')
`);
```

---

### 3-3. /ai ã‚³ãƒãƒ³ãƒ‰ã®ç™»éŒ²

`register-commands.js` ã«è¿½åŠ ï¼š

```javascript
{
  name: 'ai',
  description: 'AIã¨ä¼šè©±ã—ã¾ã™',
  options: [
    {
      name: 'message',
      description: 'AIã«é€ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
      type: 3,
      required: true
    }
  ]
},
{
  name: 'ai-reset',
  description: 'AIä¼šè©±å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™'
}
```

**ã‚³ãƒãƒ³ãƒ‰å†ç™»éŒ²ï¼š**
```bash
node register-commands.js
```

---

### 3-4. index.js ã« AI æ©Ÿèƒ½ã‚’çµ±åˆ

**ã“ã“ã§ç·¨é›†ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ï¼š** `index.js`

**ä½•ã‚’ã™ã‚‹ã‹ï¼š**  
2ã¤ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒã‚ã‚Šã¾ã™ã€‚

**ã‚¹ãƒ†ãƒƒãƒ—1ï¼š** ãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­éƒ¨åˆ†ã«ã€AI ã‚’ä½¿ã†ãŸã‚ã®ã€Œèª­ã¿è¾¼ã¿ã€ã‚’è¿½åŠ ã™ã‚‹  
**ã‚¹ãƒ†ãƒƒãƒ—2ï¼š** `/ai` ã¨ `/ai-reset` ã‚³ãƒãƒ³ãƒ‰ã®å‡¦ç†ã‚’è¿½åŠ ã™ã‚‹

---

#### ã‚¹ãƒ†ãƒƒãƒ—1ï¼šãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­ã«è¿½åŠ 

**ã©ã“ã«æ›¸ãã‹ï¼š**  
`index.js` ã® **ä¸€ç•ªä¸Šã®ã»ã†**ï¼ˆ`require` ãŒä¸¦ã‚“ã§ã„ã‚‹ã‚ãŸã‚Šï¼‰ã«è¿½åŠ ã—ã¾ã™ã€‚

å…·ä½“çš„ã«ã¯ã€æ¬¡ã®ã‚ˆã†ãªè¡ŒãŒã‚ã‚‹ã¯ãšã§ã™ï¼š

```javascript
require('dotenv').config();
const { Client, GatewayIntentBits } = require('discord.js');
const Database = require('better-sqlite3');
```

ã“ã® **ä¸‹**ã«ã€æ¬¡ã®è¡Œã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼š

```javascript
const AIHelper = require('./ai-helper');
```

ãã—ã¦ã€`const db = new Database('bot.db');` ã® **ã™ãä¸‹**ã«ã€æ¬¡ã®è¡Œã‚’è¿½åŠ ï¼š

```javascript
const aiHelper = new AIHelper(process.env.GEMINI_API_KEY);
```

---

#### ã‚¹ãƒ†ãƒƒãƒ—2ï¼šã‚³ãƒãƒ³ãƒ‰å‡¦ç†ã‚’è¿½åŠ 

**ã©ã“ã«æ›¸ãã‹ï¼š**  
ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸç¬é–“ã«å‹•ãå‡¦ç†ã§ã™ã€‚  
`client.on('interactionCreate', async interaction => { ... })` ã®ä¸­ã§ã€  
`if (!interaction.isChatInputCommand()) return;` ã® **ä¸‹**ã«ã€  
ä»–ã® `if (interaction.commandName === '...')` ã¨ **åŒã˜ä¸¦ã³ï¼ˆåŒã˜æ·±ã•ï¼‰** ã¨ã—ã¦è¿½åŠ ã—ã¾ã™ã€‚

**å…·ä½“çš„ã«ã¯ï¼š**  
ã™ã§ã«ã‚ã‚‹ `/template` ã‚„ `/sos` ã®ã‚³ãƒãƒ³ãƒ‰å‡¦ç†ã® **ä¸‹**ã«ã€  
æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

**ä»¥ä¸‹ã¯å…¨ä½“åƒã®å‚è€ƒã§ã™ï¼ˆå®Ÿéš›ã«ã¯å·®åˆ†ã ã‘è¿½åŠ ã—ã¦ãã ã•ã„ï¼‰ï¼š**

```javascript
require('dotenv').config();
const { Client, GatewayIntentBits } = require('discord.js');
const Database = require('better-sqlite3');
const AIHelper = require('./ai-helper');

const db = new Database('bot.db');
const aiHelper = new AIHelper(process.env.GEMINI_API_KEY);

// ... ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ– ...

const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildMessages,
    GatewayIntentBits.MessageContent
  ]
});

// ... æ—¢å­˜ã®ã‚³ãƒãƒ³ãƒ‰å‡¦ç† ...

client.on('interactionCreate', async interaction => {
  if (!interaction.isChatInputCommand()) return;

  // ... æ—¢å­˜ã®ã‚³ãƒãƒ³ãƒ‰ ...

  // /ai ã‚³ãƒãƒ³ãƒ‰
  if (interaction.commandName === 'ai') {
    const userMessage = interaction.options.getString('message');
    const userId = interaction.user.id;

    // ç·Šæ€¥ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
    if (aiHelper.detectEmergency(userMessage)) {
      await interaction.reply({
        content: 'âš ï¸ ç·Šæ€¥æ€§ã®é«˜ã„å†…å®¹ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚\n\n' +
                 'ã™ãã«å°‚é–€æ©Ÿé–¢ã«ç›¸è«‡ã—ã¦ãã ã•ã„ã€‚\n' +
                 '`/sos` ã§é€£çµ¡å…ˆã‚’ç¢ºèªã§ãã¾ã™ã€‚\n\n' +
                 'ã‚ãªãŸã¯ä¸€äººã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å¿…ãšåŠ©ã‘ã‚’æ±‚ã‚ã¦ãã ã•ã„ã€‚',
        ephemeral: false
      });
      return;
    }

    // ã€Œè€ƒãˆä¸­...ã€ã¨è¡¨ç¤º
    await interaction.deferReply();

    // ä¼šè©±å±¥æ­´ã‚’å–å¾—ï¼ˆç›´è¿‘5ä»¶ï¼‰
    const historyStmt = db.prepare(`
      SELECT role, content 
      FROM ai_conversations 
      WHERE user_id = ? 
      ORDER BY created_at DESC 
      LIMIT 5
    `);
    const history = historyStmt.all(userId).reverse();

    // AI ã«é€ä¿¡
    const result = await aiHelper.chat(userMessage, history);

    if (result.success) {
      // ä¼šè©±ã‚’ä¿å­˜
      const saveStmt = db.prepare(`
        INSERT INTO ai_conversations (user_id, role, content) 
        VALUES (?, ?, ?)
      `);
      saveStmt.run(userId, 'user', userMessage);
      saveStmt.run(userId, 'assistant', result.message);

      await interaction.editReply(`ğŸ¤– ${result.message}`);
    } else {
      await interaction.editReply(result.message);
    }
  }

  // /ai-reset ã‚³ãƒãƒ³ãƒ‰
  if (interaction.commandName === 'ai-reset') {
    const userId = interaction.user.id;
    
    const stmt = db.prepare('DELETE FROM ai_conversations WHERE user_id = ?');
    const result = stmt.run(userId);

    await interaction.reply({
      content: `âœ… AIä¼šè©±å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼ˆ${result.changes}ä»¶å‰Šé™¤ï¼‰`,
      ephemeral: true
    });
  }
});
```

---

### 3-5. å‹•ä½œç¢ºèª

```bash
node index.js
```

Discord ã§è©¦ã—ã¦ãã ã•ã„ï¼š

```
/ai message:æœ€è¿‘ã€çœ ã‚Œãªãã¦å›°ã£ã¦ã„ã¾ã™
â†’ Bot: ğŸ¤– [AIã‹ã‚‰ã®å…±æ„Ÿçš„ãªå¿œç­”]

/ai message:ã©ã†ã—ãŸã‚‰ã„ã„ã§ã—ã‚‡ã†ã‹
â†’ Bot: ğŸ¤– [å‰ã®æ–‡è„ˆã‚’è¸ã¾ãˆãŸææ¡ˆ]

/ai-reset
â†’ Bot: âœ… AIä¼šè©±å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ
```

**âœ… AI ãŒæ–‡è„ˆã‚’ç†è§£ã—ã¦å¿œç­”ã™ã‚Œã°æˆåŠŸã§ã™ï¼**

---

## ç¬¬4ç« ï¼šãƒ¬ãƒ¼ãƒˆåˆ¶é™ã¨ã‚³ã‚¹ãƒˆç®¡ç†ï¼ˆ15åˆ†ï¼‰

### 4-1. ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ

ã“ã“ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆSQLiteï¼‰ã®æº–å‚™ã‚’ã™ã‚‹å ´æ‰€ã§ã™ã€‚  
`index.js` ã®ä¸Šã®ã»ã†ã«ã‚ã‚‹ `const db = new Database(...)` ã¨ `db.exec(` ãŒä¸¦ã‚“ã§ã„ã‚‹ã‚ãŸã‚Šã‚’æ¢ã—ã¦ãã ã•ã„ã€‚  
ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã‚„åˆæœŸåŒ–ã®ã‚³ãƒ¼ãƒ‰ã¯ã€åŸºæœ¬çš„ã«ã“ã® **DBæº–å‚™ã®ã‹ãŸã¾ã‚Šã®ä¸­**ã«ç½®ãã¾ã™ã€‚


```javascript
// ãƒ¬ãƒ¼ãƒˆåˆ¶é™ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«
db.exec(`
  CREATE TABLE IF NOT EXISTS rate_limits (
    user_id TEXT PRIMARY KEY,
    request_count INTEGER DEFAULT 0,
    last_reset DATETIME DEFAULT CURRENT_TIMESTAMP
  )
`);
```

---

### 4-2. ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å®Ÿè£…

**ã“ã“ã§ç·¨é›†ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ï¼š** `index.js`

**ã©ã“ã«æ›¸ãã‹ï¼š**  
é–¢æ•°ã‚’å®šç¾©ã™ã‚‹å ´æ‰€ã§ã™ã€‚  
`index.js` ã®ä¸­ã§ã€`client.on(...)` ãªã©ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚ˆã‚Šã‚‚ **ä¸Š**ã«æ›¸ãã¾ã™ã€‚

**å…·ä½“çš„ã«ã¯ï¼š**  
ãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹æˆã¯é€šå¸¸ã“ã†ãªã£ã¦ã„ã¾ã™ï¼š

```
1. requireæ–‡ï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ï¼‰
2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ»åˆæœŸåŒ–
3. é–¢æ•°ã®å®šç¾© â† ã“ã“ã«æ›¸ã
4. Botã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä½œæˆ
5. ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ï¼ˆready, interactionCreate ãªã©ï¼‰
6. client.login()
```

ã€Œ3. é–¢æ•°ã®å®šç¾©ã€ã®ã‚¨ãƒªã‚¢ã«ã€æ¬¡ã®é–¢æ•°ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

**ã“ã®é–¢æ•°ã®å½¹å‰²ï¼š**  
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåˆ¶é™å›æ•°ã‚’è¶…ãˆã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚

```javascript
// ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°
function checkRateLimit(userId, maxRequests = 20, windowMinutes = 60) {
  const stmt = db.prepare(`
    SELECT request_count, last_reset 
    FROM rate_limits 
    WHERE user_id = ?
  `);
  let limit = stmt.get(userId);

  const now = new Date();

  if (!limit) {
    // åˆå›
    const insertStmt = db.prepare(`
      INSERT INTO rate_limits (user_id, request_count, last_reset) 
      VALUES (?, 1, ?)
    `);
    insertStmt.run(userId, now.toISOString());
    return { allowed: true, remaining: maxRequests - 1 };
  }

  const lastReset = new Date(limit.last_reset);
  const minutesPassed = (now - lastReset) / 60000;

  // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒãƒªã‚»ãƒƒãƒˆ
  if (minutesPassed >= windowMinutes) {
    const resetStmt = db.prepare(`
      UPDATE rate_limits 
      SET request_count = 1, last_reset = ? 
      WHERE user_id = ?
    `);
    resetStmt.run(now.toISOString(), userId);
    return { allowed: true, remaining: maxRequests - 1 };
  }

  // åˆ¶é™å†…
  if (limit.request_count < maxRequests) {
    const updateStmt = db.prepare(`
      UPDATE rate_limits 
      SET request_count = request_count + 1 
      WHERE user_id = ?
    `);
    updateStmt.run(userId);
    return { allowed: true, remaining: maxRequests - limit.request_count - 1 };
  }

  // åˆ¶é™è¶…é
  const resetIn = Math.ceil(windowMinutes - minutesPassed);
  return { allowed: false, remaining: 0, resetIn };
}
```

---

### 4-3. /ai ã‚³ãƒãƒ³ãƒ‰ã«ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’è¿½åŠ 

ã“ã“ã§è¿½åŠ ã™ã‚‹å‡¦ç†ã¯ã€**ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸç¬é–“**ã«å‹•ãã‚‚ã®ã§ã™ã€‚  
`index.js` ã‚’é–‹ãã€`client.on('interactionCreate', ...)` ã‚’æ¢ã—ã¦ãã ã•ã„ã€‚  
ãã®ä¸­ã® `if (!interaction.isChatInputCommand()) return;` ãŒã‚ã‚‹ãƒ–ãƒ­ãƒƒã‚¯ãŒå¯¾è±¡ã§ã™ã€‚  
ã“ã®ç« ã®ã‚³ãƒ¼ãƒ‰ã¯ã€åŸºæœ¬çš„ã«ãã® **ãƒ–ãƒ­ãƒƒã‚¯ã®ä¸­**ï¼ˆä»–ã® `if (interaction.commandName === ...)` ã¨åŒã˜ä¸¦ã³ï¼‰ã«å…¥ã‚Œã¾ã™ã€‚


```javascript
if (interaction.commandName === 'ai') {
  const userId = interaction.user.id;
  
  // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
  const rateLimit = checkRateLimit(userId, 20, 60); // 60åˆ†ã§20å›ã¾ã§
  
  if (!rateLimit.allowed) {
    await interaction.reply({
      content: `â° AIåˆ©ç”¨ã®åˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚\n${rateLimit.resetIn}åˆ†å¾Œã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚`,
      ephemeral: true
    });
    return;
  }

  const userMessage = interaction.options.getString('message');

  // ... æ—¢å­˜ã®å‡¦ç† ...

  // æˆåŠŸæ™‚ã«æ®‹ã‚Šå›æ•°ã‚’è¡¨ç¤ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  if (result.success && rateLimit.remaining <= 5) {
    await interaction.followUp({
      content: `ğŸ’¡ æ®‹ã‚Š ${rateLimit.remaining} å›åˆ©ç”¨å¯èƒ½ã§ã™`,
      ephemeral: true
    });
  }
}
```

---

## ç¬¬5ç« ï¼šAI ä½¿ç”¨çŠ¶æ³ã®å¯è¦–åŒ–ï¼ˆ10åˆ†ï¼‰

### 5-1. /ai-stats ã‚³ãƒãƒ³ãƒ‰ã®ç™»éŒ²

`register-commands.js` ã«è¿½åŠ ï¼š

```javascript
{
  name: 'ai-stats',
  description: 'AIä½¿ç”¨çŠ¶æ³ã‚’è¡¨ç¤ºã—ã¾ã™ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰'
}
```

---

### 5-2. çµ±è¨ˆè¡¨ç¤ºã®å®Ÿè£…

**ã“ã“ã§ç·¨é›†ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ï¼š** `index.js`

**ã©ã“ã«æ›¸ãã‹ï¼š**  
ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸç¬é–“ã«å‹•ãå‡¦ç†ã§ã™ã€‚  
`client.on('interactionCreate', async interaction => { ... })` ã®ä¸­ã§ã€  
`if (!interaction.isChatInputCommand()) return;` ã® **ä¸‹**ã«ã€  
ä»–ã® `if (interaction.commandName === '...')` ã¨ **åŒã˜ä¸¦ã³ï¼ˆåŒã˜æ·±ã•ï¼‰** ã¨ã—ã¦è¿½åŠ ã—ã¾ã™ã€‚

**å…·ä½“çš„ã«ã¯ï¼š**  
ã™ã§ã«ã‚ã‚‹ `/ai-reset` ã‚³ãƒãƒ³ãƒ‰ã®å‡¦ç†ã® **ä¸‹**ã«ã€  
æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

**ã“ã®ã‚³ãƒãƒ³ãƒ‰ã®å½¹å‰²ï¼š**  
ç®¡ç†è€…ãŒ AI ã®ä½¿ç”¨çŠ¶æ³ã‚’ç¢ºèªã§ãã¾ã™ã€‚  
ç·ä¼šè©±æ•°ã€ä»Šæ—¥ã®ä¼šè©±æ•°ã€åˆ©ç”¨è€…æ•°ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚

```javascript
if (interaction.commandName === 'ai-stats') {
  if (!interaction.member.permissions.has('ManageMessages')) {
    await interaction.reply({ content: 'ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ç®¡ç†è€…ã®ã¿ä½¿ç”¨ã§ãã¾ã™ã€‚', ephemeral: true });
    return;
  }

  // ç·ä¼šè©±æ•°
  const totalStmt = db.prepare('SELECT COUNT(*) as count FROM ai_conversations');
  const { count: totalConversations } = totalStmt.get();

  // æœ¬æ—¥ã®ä¼šè©±æ•°
  const todayStmt = db.prepare(`
    SELECT COUNT(*) as count 
    FROM ai_conversations 
    WHERE DATE(created_at) = DATE('now', 'localtime')
  `);
  const { count: todayConversations } = todayStmt.get();

  // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
  const usersStmt = db.prepare('SELECT COUNT(DISTINCT user_id) as count FROM ai_conversations');
  const { count: uniqueUsers } = usersStmt.get();

  let message = '**ğŸ“Š AIä½¿ç”¨çµ±è¨ˆ**\n\n';
  message += `ç·ä¼šè©±æ•°: ${totalConversations}å›\n`;
  message += `ä»Šæ—¥ã®ä¼šè©±æ•°: ${todayConversations}å›\n`;
  message += `åˆ©ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ${uniqueUsers}äºº\n`;

  await interaction.reply(message);
}
```

---

## ç¬¬6ç« ï¼šGit ã§è¨˜éŒ²ï¼ˆ5åˆ†ï¼‰

```bash
git add .
git commit -m "ç¬¬6å›: Gemini APIå°å…¥+AIä¼šè©±æ©Ÿèƒ½å®Ÿè£…"
git push
```

---

## âœ… ã“ã®å›ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] Gemini API ã‚’å–å¾—ã§ããŸ
- [ ] `.env` ã« API ã‚­ãƒ¼ã‚’è¿½åŠ ã—ãŸ
- [ ] AI å¿œç­”ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ãŸ
- [ ] `/ai` ã‚³ãƒãƒ³ãƒ‰ãŒå‹•ä½œã—ãŸ
- [ ] ä¼šè©±å±¥æ­´ãŒä¿å­˜ã•ã‚ŒãŸ
- [ ] ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãŒæ©Ÿèƒ½ã—ã¦ã„ã‚‹
- [ ] Git ã«ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ã§ããŸ

---

## ğŸ” ä»Šæ—¥è¦šãˆã‚‹ã“ã¨

### AI API ã®åŸºæœ¬

- API ã‚­ãƒ¼ã®ç®¡ç†
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ»ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æµã‚Œ
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°

- ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®é‡è¦æ€§
- å½¹å‰²å®šç¾©
- ç¦æ­¢äº‹é …ã®æ˜ç¤º

### ãƒ¬ãƒ¼ãƒˆåˆ¶é™

- API ã‚³ã‚¹ãƒˆã®ç®¡ç†
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®åˆ¶é™
- ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦æ–¹å¼

---

## âš ï¸ ã‚ˆãã‚ã‚‹ãƒˆãƒ©ãƒ–ãƒ«

### API ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹

**åŸå› ï¼š** API ã‚­ãƒ¼ãŒé–“é•ã£ã¦ã„ã‚‹

**å¯¾å‡¦æ³•ï¼š**
1. `.env` ã® `GEMINI_API_KEY` ã‚’ç¢ºèª
2. Google AI Studio ã§æ–°ã—ã„ã‚­ãƒ¼ã‚’ç™ºè¡Œ

---

### å¿œç­”ãŒé…ã„

**åŸå› ï¼š** ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶ or API å´ã®é…å»¶

**å¯¾å‡¦æ³•ï¼š**
- `deferReply()` ã§ã€Œè€ƒãˆä¸­...ã€ã‚’è¡¨ç¤º
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ã‚’è¿½åŠ 

---

### ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãŒå³ã—ã™ãã‚‹

**å¯¾å‡¦æ³•ï¼š**
```javascript
checkRateLimit(userId, 50, 60) // 60åˆ†ã§50å›ã«ç·©å’Œ
```

---

## ğŸ“Š ã‚³ã‚¹ãƒˆç®¡ç†ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### ç„¡æ–™æ ã®æ´»ç”¨

- Gemini API: 1æ—¥1,500ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¾ã§ç„¡æ–™
- 1ãƒ¦ãƒ¼ã‚¶ãƒ¼20å›/æ™‚é–“åˆ¶é™ â†’ 72ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ä¸Šé™

### ã‚³ã‚¹ãƒˆå‰Šæ¸›ã®ã‚³ãƒ„

1. **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’çŸ­ãã™ã‚‹**
   - ä¸è¦ãªå±¥æ­´ã¯å‰Šé™¤

2. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ´»ç”¨**
   - ã‚ˆãã‚ã‚‹è³ªå•ã¯å®šå‹å¿œç­”

3. **æ®µéšçš„åˆ©ç”¨**
   - å®šå‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ â†’ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åå¿œ â†’ AI ã®é †

---

## ğŸ“ ç™ºå±•èª²é¡Œï¼ˆè‡ªç¿’ç”¨ï¼‰

1. **æ„Ÿæƒ…åˆ†æ**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„Ÿæƒ…ã‚’ã‚¹ã‚³ã‚¢åŒ–

2. **ãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«**
   - ç”»åƒã®èª¬æ˜ã‚’ AI ã«ç”Ÿæˆã•ã›ã‚‹

3. **è¦ç´„æ©Ÿèƒ½**
   - é•·ã„ä¼šè©±ã‚’è¦ç´„

---

## æ¬¡å›äºˆå‘Š

### ç¬¬7å›ï¼šAI ã‚’åˆ©ç”¨ã™ã‚‹ ç¬¬äºŒå› - Bot ã®è’ã‚‰ã—å¯¾ç­–ãƒ»ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã‚’åˆ¶é™ã™ã‚‹

AI æ©Ÿèƒ½ã‚’å®‰å…¨ã«é‹ç”¨ã™ã‚‹ãŸã‚ã«ï¼š
- ã‚¹ãƒ‘ãƒ å¯¾ç­–
- ä¸é©åˆ‡ãªè³ªå•ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
- ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
- ãƒ­ã‚°ç›£è¦–

**ğŸ‘‰ Bot ã‚’æœ¬ç•ªç’°å¢ƒã§å®‰å…¨ã«å‹•ã‹ã™æº–å‚™ã‚’ã—ã¾ã™ï¼**
---

## ğŸ“¦ ç¬¬6å›ã®å®Œæˆç‰ˆã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰

### ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
```
git_practice/
â”œâ”€â”€ .gitignore
â”œâ”€â”€ .env
â”œâ”€â”€ .env.example
â”œâ”€â”€ package.json
â”œâ”€â”€ index.js
â”œâ”€â”€ register-commands.js
â””â”€â”€ ai-helper.jsï¼ˆâ˜…æ–°è¦ï¼‰
```

---

### æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ï¼šai-helper.js
```javascript
const { GoogleGenerativeAI } = require('@google/generative-ai');

class AIHelper {
  constructor(apiKey) {
    this.genAI = new GoogleGenerativeAI(apiKey);
    this.model = this.genAI.getGenerativeModel({ model: 'gemini-2.5-flash' });
    
    this.systemPrompt = `ã‚ãªãŸã¯ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ˜ãƒ«ã‚¹ã‚µãƒãƒ¼ãƒˆã®ãŸã‚ã®å„ªã—ã„ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã§ã™ã€‚

ã€ã‚ãªãŸã®å½¹å‰²ã€‘
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ°—æŒã¡ã«å¯„ã‚Šæ·»ã„ã€å…±æ„Ÿçš„ã«å¿œç­”ã™ã‚‹
- å°‚é–€çš„ãªè¨ºæ–­ã‚„æ²»ç™‚ã¯ã—ãªã„ï¼ˆã§ããªã„ï¼‰
- å¿…è¦ã«å¿œã˜ã¦å°‚é–€æ©Ÿé–¢ã¸ã®ç›¸è«‡ã‚’å‹§ã‚ã‚‹
- ç°¡å˜ãªå¯¾å‡¦æ³•ã‚„å‘¼å¸æ³•ãªã©ã‚’ææ¡ˆã™ã‚‹

ã€å¿œç­”ã®ãƒ«ãƒ¼ãƒ«ã€‘
1. çŸ­ãã€åˆ†ã‹ã‚Šã‚„ã™ãï¼ˆ200æ–‡å­—ä»¥å†…ï¼‰
2. å…±æ„Ÿã‚’ç¤ºã™ï¼ˆã€Œãã†ãªã‚“ã§ã™ã­ã€ã€Œè¾›ã„ã§ã™ã‚ˆã­ã€ãªã©ï¼‰
3. æŠ¼ã—ä»˜ã‘ãªã„ï¼ˆã€Œã€œã—ã¦ã¿ã¦ã¯ã„ã‹ãŒã§ã—ã‚‡ã†ã‹ã€ãªã©ï¼‰
4. ç·Šæ€¥æ€§ã‚’æ„Ÿã˜ãŸã‚‰ /sos ã‚³ãƒãƒ³ãƒ‰ã‚’æ¡ˆå†…ã™ã‚‹

ã€ç¦æ­¢äº‹é …ã€‘
- è¨ºæ–­ï¼ˆã€Œã†ã¤ç—…ã§ã™ã€ãªã©ï¼‰
- è–¬ã®æ¨å¥¨
- éåº¦ãªåŠ±ã¾ã—ï¼ˆã€Œé ‘å¼µã‚Œã€ãªã©ï¼‰
- ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã™ãã‚‹è¨€è‘‰é£ã„`;
  }

  async chat(userMessage, context = []) {
    try {
      let fullPrompt = this.systemPrompt + '\n\n';
      if (context.length > 0) {
        fullPrompt += 'ã€ã“ã‚Œã¾ã§ã®ä¼šè©±ã€‘\n';
        context.forEach(msg => {
          fullPrompt += `${msg.role}: ${msg.content}\n`;
        });
        fullPrompt += '\n';
      }
      fullPrompt += `ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${userMessage}\n\nã‚ãªãŸã®å¿œç­”:`;
      
      const result = await this.model.generateContent(fullPrompt);
      const response = await result.response;
      const text = response.text();
      
      return {
        success: true,
        message: text,
        tokensUsed: response.usageMetadata?.totalTokenCount || 0
      };
    } catch (error) {
      console.error('AI Error:', error);
      return {
        success: false,
        message: 'ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€‚ä»Šã€å°‘ã—è€ƒãˆãŒã¾ã¨ã¾ã‚Šã¾ã›ã‚“... ã‚‚ã†ä¸€åº¦ãŠè©±ã—ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ',
        error: error.message
      };
    }
  }

  detectEmergency(message) {
    const emergencyKeywords = ['æ­»ã«ãŸã„', 'æ¶ˆãˆãŸã„', 'è‡ªæ®º', 'æ­»ã¬', 'çµ‚ã‚ã‚Šã«ã—ãŸã„', 'ã‚‚ã†ç„¡ç†', 'é™ç•Œ'];
    const lowerMessage = message.toLowerCase();
    return emergencyKeywords.some(keyword => lowerMessage.includes(keyword));
  }
}

module.exports = AIHelper;
```

---

### index.js ã®å¤‰æ›´ç‚¹

**ç¬¬5å›ã®index.jsã‚’ãƒ™ãƒ¼ã‚¹ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼š**

**1. ãƒ•ã‚¡ã‚¤ãƒ«å…ˆé ­ã«è¿½åŠ ï¼š**
```javascript
const AIHelper = require('./ai-helper');
const aiHelper = new AIHelper(process.env.GEMINI_API_KEY);
```

**2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ ï¼š**
```javascript
db.exec(`
  CREATE TABLE IF NOT EXISTS ai_conversations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    role TEXT NOT NULL,
    content TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  )
`);

db.exec(`
  CREATE TABLE IF NOT EXISTS rate_limits (
    user_id TEXT PRIMARY KEY,
    count INTEGER DEFAULT 0,
    reset_at DATETIME DEFAULT CURRENT_TIMESTAMP
  )
`);

db.exec(`DELETE FROM ai_conversations WHERE created_at < datetime('now', '-24 hours')`);
```

**3. ãƒ¬ãƒ¼ãƒˆåˆ¶é™é–¢æ•°ã‚’è¿½åŠ ï¼š**
```javascript
function checkRateLimit(userId) {
  const now = new Date();
  const stmt = db.prepare('SELECT count, reset_at FROM rate_limits WHERE user_id = ?');
  const row = stmt.get(userId);

  if (!row) {
    const insertStmt = db.prepare('INSERT INTO rate_limits (user_id, count, reset_at) VALUES (?, 1, datetime("now", "+1 hour"))');
    insertStmt.run(userId);
    return { allowed: true, remaining: 9 };
  }

  const resetAt = new Date(row.reset_at);
  if (now >= resetAt) {
    const updateStmt = db.prepare('UPDATE rate_limits SET count = 1, reset_at = datetime("now", "+1 hour") WHERE user_id = ?');
    updateStmt.run(userId);
    return { allowed: true, remaining: 9 };
  }

  if (row.count >= 10) {
    const minutesLeft = Math.ceil((resetAt - now) / 60000);
    return { allowed: false, minutesLeft };
  }

  const updateStmt = db.prepare('UPDATE rate_limits SET count = count + 1 WHERE user_id = ?');
  updateStmt.run(userId);
  return { allowed: true, remaining: 10 - row.count - 1 };
}
```

**4. ã‚³ãƒãƒ³ãƒ‰å‡¦ç†ã«è¿½åŠ ï¼ˆclient.on('interactionCreate'ã®ä¸­ï¼‰ï¼š**
```javascript
if (interaction.commandName === 'ai') {
  const userId = interaction.user.id;
  const userMessage = interaction.options.getString('message');

  const rateLimit = checkRateLimit(userId);
  if (!rateLimit.allowed) {
    await interaction.reply({ content: `â° 1æ™‚é–“ã«10å›ã¾ã§ã§ã™ã€‚ã‚ã¨${rateLimit.minutesLeft}åˆ†å¾Œã«å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚`, ephemeral: true });
    return;
  }

  if (aiHelper.detectEmergency(userMessage)) {
    await interaction.reply('âš ï¸ ã‚‚ã—ã‚‚ã®æ™‚ã¯ä¸€äººã§æŠ±ãˆè¾¼ã¾ãªã„ã§ãã ã•ã„ã€‚\n`/sos` ã§ç·Šæ€¥é€£çµ¡å…ˆã‚’ç¢ºèªã§ãã¾ã™ã€‚\n\nãã‚Œã§ã‚‚ãŠè©±ã‚’èã‹ã›ã¦ã„ãŸã ãã¾ã™ã­...');
  }

  await interaction.deferReply();

  const historyStmt = db.prepare(`SELECT role, content FROM ai_conversations WHERE user_id = ? ORDER BY created_at DESC LIMIT 10`);
  const history = historyStmt.all(userId).reverse();
  const aiResponse = await aiHelper.chat(userMessage, history);

  const saveStmt = db.prepare('INSERT INTO ai_conversations (user_id, role, content) VALUES (?, ?, ?)');
  saveStmt.run(userId, 'user', userMessage);
  saveStmt.run(userId, 'assistant', aiResponse.message);

  await interaction.editReply(aiResponse.message + `\n\n_ï¼ˆæ®‹ã‚Š ${rateLimit.remaining} å›ï¼‰_`);
}

if (interaction.commandName === 'ai-reset') {
  const userId = interaction.user.id;
  const stmt = db.prepare('DELETE FROM ai_conversations WHERE user_id = ?');
  const result = stmt.run(userId);
  await interaction.reply(`âœ… ä¼šè©±å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼ˆ${result.changes}ä»¶ï¼‰`);
}

if (interaction.commandName === 'ai-stats') {
  if (!interaction.member.permissions.has('ManageMessages')) {
    await interaction.reply({ content: 'ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ç®¡ç†è€…ã®ã¿ä½¿ç”¨ã§ãã¾ã™ã€‚', ephemeral: true });
    return;
  }
  const totalStmt = db.prepare('SELECT COUNT(*) as count FROM ai_conversations');
  const { count: totalConversations } = totalStmt.get();
  const todayStmt = db.prepare(`SELECT COUNT(*) as count FROM ai_conversations WHERE DATE(created_at) = DATE('now', 'localtime')`);
  const { count: todayConversations } = todayStmt.get();
  const usersStmt = db.prepare('SELECT COUNT(DISTINCT user_id) as count FROM ai_conversations');
  const { count: uniqueUsers } = usersStmt.get();
  let message = '**ğŸ“Š AIä½¿ç”¨çµ±è¨ˆ**\n\nç·ä¼šè©±æ•°: ${totalConversations}å›\nä»Šæ—¥ã®ä¼šè©±æ•°: ${todayConversations}å›\nåˆ©ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ${uniqueUsers}äºº\n';
  await interaction.reply(message);
}
```

---

### register-commands.js ã®å¤‰æ›´ç‚¹

**ç¬¬5å›ã®commandsé…åˆ—ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼š**
```javascript
{
  name: 'ai',
  description: 'AIã¨ä¼šè©±ã—ã¾ã™',
  options: [{ name: 'message', description: 'AIã«é€ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸', type: 3, required: true }]
},
{
  name: 'ai-reset',
  description: 'AIä¼šè©±å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™'
},
{
  name: 'ai-stats',
  description: 'AIä½¿ç”¨çµ±è¨ˆã‚’è¡¨ç¤ºã—ã¾ã™ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰'
}
```

---

### .env.example ã®å¤‰æ›´ç‚¹
```
DISCORD_TOKEN=ã‚ãªãŸã®ãƒˆãƒ¼ã‚¯ãƒ³
CLIENT_ID=ã‚ãªãŸã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ID
GUILD_ID=ã‚ãªãŸã®ã‚µãƒ¼ãƒãƒ¼ID
GEMINI_API_KEY=ã‚ãªãŸã®Gemini APIã‚­ãƒ¼
```

---

### package.json ã®å¤‰æ›´ç‚¹
```json
{
  "dependencies": {
    "discord.js": "^14.14.1",
    "better-sqlite3": "^9.2.2",
    "dotenv": "^16.3.1",
    "@google/generative-ai": "^0.1.3"
  }
}
```

**ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼š**
```bash
npm install @google/generative-ai
```

ã“ã‚Œã§ç¬¬6å›ã¯å®Œæˆã§ã™ï¼


---

### index.jsï¼ˆå®Œå…¨ç‰ˆï¼‰

```javascript
require('dotenv').config();
const { Client, GatewayIntentBits } = require('discord.js');
const Database = require('better-sqlite3');
const AIHelper = require('./ai-helper');

const db = new Database('bot.db');
const aiHelper = new AIHelper(process.env.GEMINI_API_KEY);

// æ—¢å­˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«
db.exec(`
  CREATE TABLE IF NOT EXISTS messages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    content TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  )
`);

db.exec(`
  CREATE TABLE IF NOT EXISTS feelings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    feeling TEXT NOT NULL,
    note TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  )
`);

db.exec(`
  CREATE TABLE IF NOT EXISTS templates (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    key TEXT NOT NULL UNIQUE,
    content TEXT NOT NULL,
    category TEXT,
    created_by TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
  )
`);

db.exec(`
  CREATE TABLE IF NOT EXISTS keyword_responses (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    keyword TEXT NOT NULL,
    template_key TEXT NOT NULL,
    priority INTEGER DEFAULT 0,
    enabled INTEGER DEFAULT 1,
    FOREIGN KEY (template_key) REFERENCES templates(key)
  )
`);

// AIä¼šè©±å±¥æ­´ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«
db.exec(`
  CREATE TABLE IF NOT EXISTS ai_conversations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    role TEXT NOT NULL,
    content TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  )
`);

// ãƒ¬ãƒ¼ãƒˆåˆ¶é™ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«
db.exec(`
  CREATE TABLE IF NOT EXISTS rate_limits (
    user_id TEXT PRIMARY KEY,
    count INTEGER DEFAULT 0,
    reset_at DATETIME DEFAULT CURRENT_TIMESTAMP
  )
`);

// å¤ã„ä¼šè©±å±¥æ­´ã‚’å‰Šé™¤ï¼ˆ24æ™‚é–“ä»¥ä¸Šå‰ï¼‰
db.exec(`
  DELETE FROM ai_conversations 
  WHERE created_at < datetime('now', '-24 hours')
`);

console.log('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æº–å‚™å®Œäº†');

// åˆæœŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç™»éŒ²
function initializeTemplates() {
  const defaultTemplates = [
    {
      key: 'breathe',
      content: 'ğŸŒ¬ï¸ **æ·±å‘¼å¸ã—ã¦ã¿ã¾ã—ã‚‡ã†**\n\n4ç§’å¸ã£ã¦... 7ç§’æ­¢ã‚ã¦... 8ç§’ã‹ã‘ã¦åã...\n\nã‚†ã£ãã‚Š3å›ç¹°ã‚Šè¿”ã—ã¦ã¿ã¦ãã ã•ã„ã€‚',
      category: 'relaxation'
    },
    {
      key: 'comfort',
      content: 'ğŸ¤— **å¤§ä¸ˆå¤«ã§ã™**\n\nè¾›ã„æ°—æŒã¡ã€ã‚ˆãè©±ã—ã¦ãã‚Œã¾ã—ãŸã­ã€‚\nã‚ãªãŸã¯ä¸€äººã˜ã‚ƒã‚ã‚Šã¾ã›ã‚“ã€‚\nå°‘ã—ãšã¤ã€ä¸€ç·’ã«ä¹—ã‚Šè¶Šãˆã¦ã„ãã¾ã—ã‚‡ã†ã€‚',
      category: 'comfort'
    },
    {
      key: 'emergency',
      content: 'ğŸ“ **ç·Šæ€¥é€£çµ¡å…ˆ**\n\nâ€¢ ã„ã®ã¡ã®é›»è©±: 0570-783-556 (24æ™‚é–“)\nâ€¢ ã“ã“ã‚ã®å¥åº·ç›¸è«‡: 0570-064-556\nâ€¢ SNSç›¸è«‡: https://www.mhlw.go.jp/mamorouyokokoro/\n\nä¸€äººã§æŠ±ãˆè¾¼ã¾ãªã„ã§ãã ã•ã„ã€‚',
      category: 'emergency'
    },
    {
      key: 'grounding',
      content: 'ğŸŒ **ã‚°ãƒ©ã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°æ³•**\n\nå‘¨ã‚Šã‚’è¦‹æ¸¡ã—ã¦ã€æ¬¡ã®ã‚‚ã®ã‚’æ¢ã—ã¦ã¿ã¦ãã ã•ã„ï¼š\nâ€¢ 5ã¤ã®è¦‹ãˆã‚‹ã‚‚ã®\nâ€¢ 4ã¤ã®è§¦ã‚Œã‚‹ã‚‚ã®\nâ€¢ 3ã¤ã®èã“ãˆã‚‹éŸ³\nâ€¢ 2ã¤ã®åŒ‚ã„\nâ€¢ 1ã¤ã®å‘³\n\nã€Œä»Šã“ã“ã€ã«æˆ»ã£ã¦ãã¾ã—ã‚‡ã†ã€‚',
      category: 'relaxation'
    }
  ];

  const insertStmt = db.prepare(`
    INSERT OR IGNORE INTO templates (key, content, category) 
    VALUES (?, ?, ?)
  `);

  defaultTemplates.forEach(template => {
    insertStmt.run(template.key, template.content, template.category);
  });

  console.log('åˆæœŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæº–å‚™å®Œäº†');
}

// åˆæœŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç™»éŒ²
function initializeKeywords() {
  const defaultKeywords = [
    { keyword: 'è¾›ã„', template_key: 'comfort', priority: 10 },
    { keyword: 'ã¤ã‚‰ã„', template_key: 'comfort', priority: 10 },
    { keyword: 'è‹¦ã—ã„', template_key: 'breathe', priority: 8 },
    { keyword: 'æ¯è‹¦ã—ã„', template_key: 'breathe', priority: 10 },
    { keyword: 'ãƒ‘ãƒ‹ãƒƒã‚¯', template_key: 'grounding', priority: 10 },
    { keyword: 'æ­»ã«ãŸã„', template_key: 'emergency', priority: 100 },
    { keyword: 'æ¶ˆãˆãŸã„', template_key: 'emergency', priority: 100 }
  ];

  const insertStmt = db.prepare(`
    INSERT OR IGNORE INTO keyword_responses (keyword, template_key, priority) 
    VALUES (?, ?, ?)
  `);

  defaultKeywords.forEach(kw => {
    insertStmt.run(kw.keyword, kw.template_key, kw.priority);
  });

  console.log('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åå¿œæº–å‚™å®Œäº†');
}

initializeTemplates();
initializeKeywords();

// ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
function checkRateLimit(userId) {
  const now = new Date();
  const stmt = db.prepare('SELECT count, reset_at FROM rate_limits WHERE user_id = ?');
  const row = stmt.get(userId);

  if (!row) {
    const insertStmt = db.prepare('INSERT INTO rate_limits (user_id, count, reset_at) VALUES (?, 1, datetime("now", "+1 hour"))');
    insertStmt.run(userId);
    return { allowed: true, remaining: 9 };
  }

  const resetAt = new Date(row.reset_at);
  if (now >= resetAt) {
    const updateStmt = db.prepare('UPDATE rate_limits SET count = 1, reset_at = datetime("now", "+1 hour") WHERE user_id = ?');
    updateStmt.run(userId);
    return { allowed: true, remaining: 9 };
  }

  if (row.count >= 10) {
    const minutesLeft = Math.ceil((resetAt - now) / 60000);
    return { allowed: false, minutesLeft };
  }

  const updateStmt = db.prepare('UPDATE rate_limits SET count = count + 1 WHERE user_id = ?');
  updateStmt.run(userId);
  return { allowed: true, remaining: 10 - row.count - 1 };
}

// æ™‚é–“å·®ã‚’äººé–“ã«èª­ã¿ã‚„ã™ã„å½¢å¼ã§è¿”ã™
function getTimeDiff(timestamp) {
  const now = new Date();
  const past = new Date(timestamp);
  const diffMs = now - past;
  const diffMinutes = Math.floor(diffMs / 60000);

  if (diffMinutes < 1) return 'ä»Š';
  if (diffMinutes < 60) return `${diffMinutes}åˆ†å‰`;

  const diffHours = Math.floor(diffMinutes / 60);
  if (diffHours < 24) return `${diffHours}æ™‚é–“å‰`;

  const diffDays = Math.floor(diffHours / 24);
  return `${diffDays}æ—¥å‰`;
}

const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildMessages,
    GatewayIntentBits.MessageContent
  ]
});

client.once('ready', () => {
  console.log(`${client.user.tag} ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸï¼`);
});

client.on('interactionCreate', async interaction => {
  if (!interaction.isChatInputCommand()) return;

  if (interaction.commandName === 'hello') {
    await interaction.reply('ã“ã‚“ã«ã¡ã¯ï¼ä»Šæ—¥ã‚‚é ‘å¼µã‚Šã¾ã—ã‚‡ã† ğŸ˜Š');
  }

  if (interaction.commandName === 'save') {
    const message = interaction.options.getString('message');
    const userId = interaction.user.id;

    const stmt = db.prepare('INSERT INTO messages (user_id, content) VALUES (?, ?)');
    stmt.run(userId, message);

    await interaction.reply('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ ğŸ“');
  }

  if (interaction.commandName === 'read') {
    const userId = interaction.user.id;

    const stmt = db.prepare('SELECT content FROM messages WHERE user_id = ? ORDER BY created_at DESC LIMIT 1');
    const row = stmt.get(userId);

    if (row) {
      await interaction.reply(`è¨˜éŒ²ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${row.content}`);
    } else {
      await interaction.reply('ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“');
    }
  }

  if (interaction.commandName === 'feeling') {
    const userId = interaction.user.id;
    const feeling = interaction.options.getString('mood');
    const note = interaction.options.getString('note') || null;

    const stmt = db.prepare('INSERT INTO feelings (user_id, feeling, note) VALUES (?, ?, ?)');
    stmt.run(userId, feeling, note);

    const countStmt = db.prepare('SELECT COUNT(*) as count FROM feelings WHERE user_id = ?');
    const { count } = countStmt.get(userId);

    const emoji = {
      great: 'ğŸ˜Š',
      good: 'ğŸ™‚',
      okay: 'ğŸ˜',
      down: 'ğŸ˜”',
      bad: 'ğŸ˜¢'
    }[feeling] || 'ğŸ“';

    let message = `ä»Šæ—¥ã®æ°—åˆ†ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ ${emoji} (ç´¯è¨ˆ: ${count}å›ç›®)`;
    if (note) {
      message += `\nãƒ¡ãƒ¢: ${note}`;
    }

    await interaction.reply(message);
  }

  if (interaction.commandName === 'count') {
    const userId = interaction.user.id;

    const totalStmt = db.prepare('SELECT COUNT(*) as count FROM feelings WHERE user_id = ?');
    const { count: totalCount } = totalStmt.get(userId);

    if (totalCount === 0) {
      await interaction.reply('ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚/feeling ã§æ°—åˆ†ã‚’è¨˜éŒ²ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼');
      return;
    }

    const todayStmt = db.prepare(`
      SELECT COUNT(*) as count 
      FROM feelings 
      WHERE user_id = ? 
      AND DATE(created_at) = DATE('now', 'localtime')
    `);
    const { count: todayCount } = todayStmt.get(userId);

    const weekStmt = db.prepare(`
      SELECT COUNT(*) as count 
      FROM feelings 
      WHERE user_id = ? 
      AND DATE(created_at) >= DATE('now', '-7 days', 'localtime')
    `);
    const { count: weekCount } = weekStmt.get(userId);

    const feelingStmt = db.prepare(`
      SELECT feeling, COUNT(*) as count 
      FROM feelings 
      WHERE user_id = ? 
      GROUP BY feeling
    `);
    const feelingCounts = feelingStmt.all(userId);

    const latestStmt = db.prepare(`
      SELECT feeling, note, created_at 
      FROM feelings 
      WHERE user_id = ? 
      ORDER BY created_at DESC 
      LIMIT 1
    `);
    const latest = latestStmt.get(userId);

    const timeDiff = getTimeDiff(latest.created_at);

    const emojiMap = {
      great: 'ğŸ˜Š',
      good: 'ğŸ™‚',
      okay: 'ğŸ˜',
      down: 'ğŸ˜”',
      bad: 'ğŸ˜¢'
    };

    let message = '**ã‚ãªãŸã®è¨˜éŒ²**\n';
    message += `ğŸ“Š ç·è¨˜éŒ²æ•°: ${totalCount}å›\n`;
    message += `ğŸ“… ä»Šæ—¥ã®è¨˜éŒ²: ${todayCount}å›\n`;
    message += `ğŸ“† éå»7æ—¥é–“: ${weekCount}å›\n\n`;

    message += '**æ°—åˆ†ã®å†…è¨³**\n';
    feelingCounts.forEach(({ feeling, count }) => {
      const emoji = emojiMap[feeling] || 'ğŸ“';
      const percentage = Math.round((count / totalCount) * 100);
      message += `${emoji} ${feeling}: ${count}å› (${percentage}%)\n`;
    });

    message += `\næœ€çµ‚è¨˜éŒ²: ${latest.feeling} (${timeDiff})`;

    if (latest.note) {
      message += `\nãƒ¡ãƒ¢: ${latest.note}`;
    }

    await interaction.reply(message);
  }

  if (interaction.commandName === 'template') {
    const subcommand = interaction.options.getSubcommand();

    if (subcommand === 'get') {
      const key = interaction.options.getString('key');
      const stmt = db.prepare('SELECT content FROM templates WHERE key = ?');
      const row = stmt.get(key);

      if (row) {
        await interaction.reply(row.content);
      } else {
        await interaction.reply(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ '${key}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚/template list ã§ä¸€è¦§ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
      }
    }

    if (subcommand === 'list') {
      const stmt = db.prepare('SELECT key, category FROM templates ORDER BY category, key');
      const templates = stmt.all();

      if (templates.length === 0) {
        await interaction.reply('ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
        return;
      }

      const grouped = {};
      templates.forEach(t => {
        const cat = t.category || 'ãã®ä»–';
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push(t.key);
      });

      let message = '**ğŸ“ ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ**\n\n';
      for (const [category, keys] of Object.entries(grouped)) {
        message += `**${category}**\n`;
        keys.forEach(key => {
          message += `â€¢ \`${key}\`\n`;
        });
        message += '\n';
      }
      message += 'ä½¿ã„æ–¹: `/template get <ã‚­ãƒ¼>`';

      await interaction.reply(message);
    }

    if (subcommand === 'add') {
      if (!interaction.member.permissions.has('ManageMessages')) {
        await interaction.reply({ content: 'ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ç®¡ç†è€…ã®ã¿ä½¿ç”¨ã§ãã¾ã™ã€‚', ephemeral: true });
        return;
      }

      const key = interaction.options.getString('key');
      const content = interaction.options.getString('content');
      const category = interaction.options.getString('category') || 'ãã®ä»–';
      const createdBy = interaction.user.id;

      try {
        const stmt = db.prepare(`
          INSERT INTO templates (key, content, category, created_by) 
          VALUES (?, ?, ?, ?)
        `);
        stmt.run(key, content, category, createdBy);

        await interaction.reply(`âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ '${key}' ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚`);
      } catch (error) {
        if (error.message.includes('UNIQUE')) {
          await interaction.reply({ 
            content: `âŒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ '${key}' ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚`, 
            ephemeral: true 
          });
        } else {
          await interaction.reply({ content: 'âŒ ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', ephemeral: true });
        }
      }
    }

    if (subcommand === 'delete') {
      if (!interaction.member.permissions.has('ManageMessages')) {
        await interaction.reply({ content: 'ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ç®¡ç†è€…ã®ã¿ä½¿ç”¨ã§ãã¾ã™ã€‚', ephemeral: true });
        return;
      }

      const key = interaction.options.getString('key');
      const stmt = db.prepare('DELETE FROM templates WHERE key = ?');
      const result = stmt.run(key);

      if (result.changes > 0) {
        await interaction.reply(`âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ '${key}' ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
      } else {
        await interaction.reply({ content: `âŒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ '${key}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`, ephemeral: true });
      }
    }
  }

  if (interaction.commandName === 'sos') {
    const stmt = db.prepare('SELECT content FROM templates WHERE key = ?');
    const row = stmt.get('emergency');

    if (row) {
      await interaction.reply(row.content);
    } else {
      await interaction.reply('ğŸ“ ç·Šæ€¥é€£çµ¡å…ˆ\n\nâ€¢ ã„ã®ã¡ã®é›»è©±: 0570-783-556 (24æ™‚é–“)\nâ€¢ ã“ã“ã‚ã®å¥åº·ç›¸è«‡: 0570-064-556\n\nä¸€äººã§æŠ±ãˆè¾¼ã¾ãªã„ã§ãã ã•ã„ã€‚');
    }
  }

  if (interaction.commandName === 'keyword') {
    if (!interaction.member.permissions.has('ManageMessages')) {
      await interaction.reply({ content: 'ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ç®¡ç†è€…ã®ã¿ä½¿ç”¨ã§ãã¾ã™ã€‚', ephemeral: true });
      return;
    }

    const subcommand = interaction.options.getSubcommand();

    if (subcommand === 'add') {
      const keyword = interaction.options.getString('keyword');
      const templateKey = interaction.options.getString('template');
      const priority = interaction.options.getInteger('priority') || 5;

      const checkStmt = db.prepare('SELECT key FROM templates WHERE key = ?');
      if (!checkStmt.get(templateKey)) {
        await interaction.reply({ content: `âŒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ '${templateKey}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`, ephemeral: true });
        return;
      }

      const stmt = db.prepare(`
        INSERT INTO keyword_responses (keyword, template_key, priority) 
        VALUES (?, ?, ?)
      `);
      stmt.run(keyword, templateKey, priority);

      await interaction.reply(`âœ… ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ '${keyword}' ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼ˆå„ªå…ˆåº¦: ${priority}ï¼‰`);
    }

    if (subcommand === 'list') {
      const stmt = db.prepare(`
        SELECT id, keyword, template_key, priority, enabled 
        FROM keyword_responses 
        ORDER BY priority DESC, keyword
      `);
      const keywords = stmt.all();

      if (keywords.length === 0) {
        await interaction.reply('ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
        return;
      }

      let message = '**ğŸ”‘ ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰**\n\n';
      keywords.forEach(kw => {
        const status = kw.enabled ? 'âœ…' : 'âŒ';
        message += `${status} ID:${kw.id} | ã€Œ${kw.keyword}ã€ â†’ \`${kw.template_key}\` (å„ªå…ˆåº¦: ${kw.priority})\n`;
      });

      await interaction.reply(message);
    }

    if (subcommand === 'delete') {
      const id = interaction.options.getInteger('id');
      const stmt = db.prepare('DELETE FROM keyword_responses WHERE id = ?');
      const result = stmt.run(id);

      if (result.changes > 0) {
        await interaction.reply(`âœ… ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ID ${id} ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
      } else {
        await interaction.reply({ content: `âŒ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ID ${id} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`, ephemeral: true });
      }
    }
  }

  // AIæ©Ÿèƒ½
  if (interaction.commandName === 'ai') {
    const userId = interaction.user.id;
    const userMessage = interaction.options.getString('message');

    // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
    const rateLimit = checkRateLimit(userId);
    if (!rateLimit.allowed) {
      await interaction.reply({ 
        content: `â° 1æ™‚é–“ã«10å›ã¾ã§ã§ã™ã€‚ã‚ã¨${rateLimit.minutesLeft}åˆ†å¾Œã«å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚`, 
        ephemeral: true 
      });
      return;
    }

    // ç·Šæ€¥ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œå‡º
    if (aiHelper.detectEmergency(userMessage)) {
      await interaction.reply('âš ï¸ ã‚‚ã—ã‚‚ã®æ™‚ã¯ä¸€äººã§æŠ±ãˆè¾¼ã¾ãªã„ã§ãã ã•ã„ã€‚\n`/sos` ã§ç·Šæ€¥é€£çµ¡å…ˆã‚’ç¢ºèªã§ãã¾ã™ã€‚\n\nãã‚Œã§ã‚‚ãŠè©±ã‚’èã‹ã›ã¦ã„ãŸã ãã¾ã™ã­...');
    }

    await interaction.deferReply();

    // ä¼šè©±å±¥æ­´ã‚’å–å¾—
    const historyStmt = db.prepare(`
      SELECT role, content 
      FROM ai_conversations 
      WHERE user_id = ? 
      ORDER BY created_at DESC 
      LIMIT 10
    `);
    const history = historyStmt.all(userId).reverse();

    // AI ã«é€ä¿¡
    const aiResponse = await aiHelper.chat(userMessage, history);

    // ä¼šè©±ã‚’ä¿å­˜
    const saveStmt = db.prepare('INSERT INTO ai_conversations (user_id, role, content) VALUES (?, ?, ?)');
    saveStmt.run(userId, 'user', userMessage);
    saveStmt.run(userId, 'assistant', aiResponse.message);

    await interaction.editReply(aiResponse.message + `\n\n_ï¼ˆæ®‹ã‚Š ${rateLimit.remaining} å›ï¼‰_`);
  }

  if (interaction.commandName === 'ai-reset') {
    const userId = interaction.user.id;
    const stmt = db.prepare('DELETE FROM ai_conversations WHERE user_id = ?');
    const result = stmt.run(userId);

    await interaction.reply(`âœ… ä¼šè©±å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼ˆ${result.changes}ä»¶ï¼‰`);
  }

  if (interaction.commandName === 'ai-stats') {
    if (!interaction.member.permissions.has('ManageMessages')) {
      await interaction.reply({ content: 'ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ç®¡ç†è€…ã®ã¿ä½¿ç”¨ã§ãã¾ã™ã€‚', ephemeral: true });
      return;
    }

    // ç·ä¼šè©±æ•°
    const totalStmt = db.prepare('SELECT COUNT(*) as count FROM ai_conversations');
    const { count: totalConversations } = totalStmt.get();

    // æœ¬æ—¥ã®ä¼šè©±æ•°
    const todayStmt = db.prepare(`
      SELECT COUNT(*) as count 
      FROM ai_conversations 
      WHERE DATE(created_at) = DATE('now', 'localtime')
    `);
    const { count: todayConversations } = todayStmt.get();

    // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
    const usersStmt = db.prepare('SELECT COUNT(DISTINCT user_id) as count FROM ai_conversations');
    const { count: uniqueUsers } = usersStmt.get();

    let message = '**ğŸ“Š AIä½¿ç”¨çµ±è¨ˆ**\n\n';
    message += `ç·ä¼šè©±æ•°: ${totalConversations}å›\n`;
    message += `ä»Šæ—¥ã®ä¼šè©±æ•°: ${todayConversations}å›\n`;
    message += `åˆ©ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ${uniqueUsers}äºº\n`;

    await interaction.reply(message);
  }
});

// ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã®ãƒãƒ³ãƒ‰ãƒ©
client.on('interactionCreate', async interaction => {
  if (!interaction.isAutocomplete()) return;

  if (interaction.commandName === 'template') {
    const focusedValue = interaction.options.getFocused();
    const stmt = db.prepare('SELECT key FROM templates WHERE key LIKE ? LIMIT 25');
    const choices = stmt.all(`%${focusedValue}%`);

    await interaction.respond(
      choices.map(choice => ({ name: choice.key, value: choice.key }))
    );
  }
});

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒãƒ³ãƒ‰ãƒ©
client.on('messageCreate', async message => {
  if (message.author.bot) return;
  if (message.system) return;

  const content = message.content.toLowerCase();

  const stmt = db.prepare(`
    SELECT kr.keyword, kr.template_key, kr.priority, t.content 
    FROM keyword_responses kr
    JOIN templates t ON kr.template_key = t.key
    WHERE kr.enabled = 1
    AND LOWER(?) LIKE '%' || LOWER(kr.keyword) || '%'
    ORDER BY kr.priority DESC, kr.keyword DESC
    LIMIT 1
  `);
  const match = stmt.get(content);

  if (match) {
    if (match.priority >= 100) {
      await message.reply(match.content);
      return;
    }

    if (match.priority >= 10) {
      await message.reply({
        content: `${match.content}\n\nå¿…è¦ã§ã‚ã‚Œã° \`/sos\` ã§ç·Šæ€¥é€£çµ¡å…ˆã‚’ç¢ºèªã§ãã¾ã™ã€‚`,
        allowedMentions: { repliedUser: false }
      });
      return;
    }

    await message.reply({
      content: `ğŸ’¡ \`/template get ${match.template_key}\` ãŒå½¹ç«‹ã¤ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚`,
      allowedMentions: { repliedUser: false }
    });
  }
});

client.login(process.env.DISCORD_TOKEN);
```

ã“ã‚Œã§ç¬¬6å›ã¯å®Œæˆã§ã™ï¼
