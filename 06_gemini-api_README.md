# ç¬¬6å›ï¼šAI ã‚’åˆ©ç”¨ã™ã‚‹ï¼ˆGemini API ç™»éŒ²ï¼‰+ ã‚µãƒ³ãƒ—ãƒ«ã®å®Ÿè¡Œ

Bot ã« **AI ã®åŠ›** ã‚’åŠ ãˆã¾ã™ã€‚  
Gemini API ã‚’ä½¿ã£ã¦ã€Bot ãŒæ–‡è„ˆã‚’ç†è§£ã—ã¦å¿œç­”ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

---

## ğŸ“Œ ã“ã®å›ã®ç›®æ¨™

- Gemini API ã‚’ç™»éŒ²ãƒ»è¨­å®šã™ã‚‹
- Bot ã« AI ä¼šè©±æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹
- ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è€ƒæ…®ã—ãŸå¿œç­”ã‚’å®Ÿè£…ã™ã‚‹
- ãƒ¡ãƒ³ã‚¿ãƒ«ã‚µãƒãƒ¼ãƒˆã«ç‰¹åŒ–ã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¨­å®šã™ã‚‹

**ğŸ’¡ ãƒã‚¤ãƒ³ãƒˆï¼š**
- AI ã¯ã€Œä¸‡èƒ½ã€ã§ã¯ãªãã€Œè£œåŠ©ã€ã¨ã—ã¦ä½¿ã†
- é©åˆ‡ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆãŒé‡è¦
- ã‚³ã‚¹ãƒˆç®¡ç†ã‚‚æ„è­˜ã™ã‚‹

---

## ğŸ¯ å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼: æœ€è¿‘ã€å¯ã‚Œãªãã¦å›°ã£ã¦ã¾ã™
Bot: ğŸ¤– ç¡çœ ã«å›°ã£ã¦ã„ã‚‹ã‚“ã§ã™ã­ã€‚ãã‚Œã¯è¾›ã„ã§ã™ã‚ˆã­ã€‚
     ã„ãã¤ã‹è³ªå•ã•ã›ã¦ãã ã•ã„ï¼š
     
     1. ã©ã®ãã‚‰ã„ã®æœŸé–“ç¶šã„ã¦ã„ã¾ã™ã‹ï¼Ÿ
     2. å¯ã‚‹å‰ã«ä½•ã‹æ°—ã«ãªã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
     3. æ˜¼é–“ã®çœ æ°—ã¯ã©ã†ã§ã™ã‹ï¼Ÿ
     
     å°‘ã—ãšã¤ä¸€ç·’ã«è€ƒãˆã¦ã„ãã¾ã—ã‚‡ã†ã€‚
     
     æ€¥ãã®å ´åˆã¯ `/sos` ã§å°‚é–€æ©Ÿé–¢ã®é€£çµ¡å…ˆã‚’ç¢ºèªã§ãã¾ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼: 1é€±é–“ãã‚‰ã„ã§ã™ã€‚ä»•äº‹ã®ã“ã¨ãŒæ°—ã«ãªã£ã¦...
Bot: ğŸ¤– 1é€±é–“ç¶šã„ã¦ã„ã‚‹ã‚“ã§ã™ã­ã€‚ä»•äº‹ã®ã“ã¨ãŒé ­ã‹ã‚‰é›¢ã‚Œãªã„ã¨ã€
     ä¼‘ã¾ã‚‹æ™‚é–“ãŒãªã„ã§ã™ã‚ˆã­...
```

**ğŸ‘‰ Bot ãŒã€Œç†è§£ã—ã¦ã€å¿œç­”ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™**

---

## ğŸ“š äº‹å‰æº–å‚™

### å¿…è¦ãªã‚‚ã®

- âœ… ç¬¬5å›ã¾ã§ã®å®Œæˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
- âœ… Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
- âœ… ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ï¼ˆç„¡æ–™æ å†…ã§OKï¼‰

---

## ç¬¬1ç« ï¼šGemini API ã®ç™»éŒ²ï¼ˆ15åˆ†ï¼‰

### 1-1. Google AI Studio ã«ã‚¢ã‚¯ã‚»ã‚¹

1. [Google AI Studio](https://makersuite.google.com/app/apikey) ã«ã‚¢ã‚¯ã‚»ã‚¹
2. Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³

---

### 1-2. API ã‚­ãƒ¼ã‚’ä½œæˆ

1. **Get API key** ã‚’ã‚¯ãƒªãƒƒã‚¯
2. **Create API key** ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠï¼ˆã¾ãŸã¯æ–°è¦ä½œæˆï¼‰
4. API ã‚­ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ **ã‚³ãƒ”ãƒ¼ã—ã¦ä¿å­˜**

**âš ï¸ è¶…é‡è¦ï¼š**
- ã“ã®ã‚­ãƒ¼ã¯çµ¶å¯¾ã«ä»–äººã«è¦‹ã›ãªã„
- GitHub ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãªã„
- `.env` ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã™ã‚‹

---

### 1-3. æ–™é‡‘ã«ã¤ã„ã¦

**Gemini API ã®æ–™é‡‘ï¼ˆ2025å¹´æ™‚ç‚¹ï¼‰ï¼š**
- ç„¡æ–™æ : 1æ—¥ 1,500ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¾ã§
- 1åˆ†ã‚ãŸã‚Š 15ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¾ã§

**ã“ã®ãƒãƒ³ã‚ºã‚ªãƒ³ã§ã®ä½¿ç”¨é‡ï¼š**
- ãƒ†ã‚¹ãƒˆ: æ•°åãƒªã‚¯ã‚¨ã‚¹ãƒˆç¨‹åº¦
- å®Ÿé‹ç”¨: 1æ—¥100-200ãƒªã‚¯ã‚¨ã‚¹ãƒˆæƒ³å®š

**ğŸ‘‰ ç„¡æ–™æ ã§ååˆ†ä½¿ãˆã¾ã™**

---

### 1-4. .env ã« API ã‚­ãƒ¼ã‚’è¿½åŠ 

ã“ã“ã¯ãƒˆãƒ¼ã‚¯ãƒ³ãªã©ã®è¨­å®šå€¤ã‚’ç½®ãå ´æ‰€ã§ã™ã€‚  
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç›´ä¸‹ã® `.env` ã‚’é–‹ãã€`DISCORD_TOKEN=...` ãŒã‚ã‚‹è¡Œã®è¿‘ãã«è¿½åŠ ã—ã¾ã™ã€‚  
â€» å®Ÿãƒˆãƒ¼ã‚¯ãƒ³ã¯ README ã«ã¯è²¼ã‚‰ãšã€`.env` ã«ã ã‘å…¥ã‚Œã‚‹ã®ãŒå®‰å…¨ã§ã™ã€‚


```bash
DISCORD_TOKEN=ã‚ãªãŸã®ãƒˆãƒ¼ã‚¯ãƒ³
CLIENT_ID=ã‚ãªãŸã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ID
GUILD_ID=ã‚ãªãŸã®ã‚µãƒ¼ãƒãƒ¼ID
GEMINI_API_KEY=ã‚ãªãŸã®Gemini APIã‚­ãƒ¼
```

---

## ç¬¬2ç« ï¼šGemini API ã®åŸºæœ¬çš„ãªä½¿ã„æ–¹ï¼ˆ15åˆ†ï¼‰

### 2-1. å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
npm install @google/generative-ai
```

---

### 2-2. ç°¡å˜ãªå‹•ä½œç¢ºèªã‚¹ã‚¯ãƒªãƒ—ãƒˆ

`test-gemini.js` ã‚’ä½œæˆã—ã¦å‹•ä½œç¢ºèªã—ã¾ã™ï¼š

```javascript
require('dotenv').config();
const { GoogleGenerativeAI } = require('@google/generative-ai');

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);

async function testGemini() {
  try {
    const model = genAI.getGenerativeModel({ model: 'gemini-2.5-flash' });
    
    const prompt = 'ã“ã‚“ã«ã¡ã¯ï¼ã‚ãªãŸã¯èª°ã§ã™ã‹ï¼Ÿ';
    const result = await model.generateContent(prompt);
    const response = await result.response;
    const text = response.text();
    
    console.log('AIå¿œç­”:', text);
  } catch (error) {
    console.error('ã‚¨ãƒ©ãƒ¼:', error);
  }
}

testGemini();
```

**å®Ÿè¡Œï¼š**
```bash
node test-gemini.js
```

**âœ… AI ã‹ã‚‰ã®å¿œç­”ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°æˆåŠŸã§ã™ï¼**

---

## ç¬¬3ç« ï¼šBot ã« AI æ©Ÿèƒ½ã‚’è¿½åŠ ï¼ˆ25åˆ†ï¼‰

### 3-1. AI ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ

`ai-helper.js` ã‚’ä½œæˆï¼š

```javascript
const { GoogleGenerativeAI } = require('@google/generative-ai');

class AIHelper {
  constructor(apiKey) {
    this.genAI = new GoogleGenerativeAI(apiKey);
    this.model = this.genAI.getGenerativeModel({ model: 'gemini-2.5-flash' });
    
    // ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆBot ã®å½¹å‰²å®šç¾©ï¼‰
    this.systemPrompt = `ã‚ãªãŸã¯ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ˜ãƒ«ã‚¹ã‚µãƒãƒ¼ãƒˆã®ãŸã‚ã®å„ªã—ã„ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã§ã™ã€‚

ã€ã‚ãªãŸã®å½¹å‰²ã€‘
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ°—æŒã¡ã«å¯„ã‚Šæ·»ã„ã€å…±æ„Ÿçš„ã«å¿œç­”ã™ã‚‹
- å°‚é–€çš„ãªè¨ºæ–­ã‚„æ²»ç™‚ã¯ã—ãªã„ï¼ˆã§ããªã„ï¼‰
- å¿…è¦ã«å¿œã˜ã¦å°‚é–€æ©Ÿé–¢ã¸ã®ç›¸è«‡ã‚’å‹§ã‚ã‚‹
- ç°¡å˜ãªå¯¾å‡¦æ³•ã‚„å‘¼å¸æ³•ãªã©ã‚’ææ¡ˆã™ã‚‹

ã€å¿œç­”ã®ãƒ«ãƒ¼ãƒ«ã€‘
1. çŸ­ãã€åˆ†ã‹ã‚Šã‚„ã™ãï¼ˆ200æ–‡å­—ä»¥å†…ï¼‰
2. å…±æ„Ÿã‚’ç¤ºã™ï¼ˆã€Œãã†ãªã‚“ã§ã™ã­ã€ã€Œè¾›ã„ã§ã™ã‚ˆã­ã€ãªã©ï¼‰
3. æŠ¼ã—ä»˜ã‘ãªã„ï¼ˆã€Œã€œã—ã¦ã¿ã¦ã¯ã„ã‹ãŒã§ã—ã‚‡ã†ã‹ã€ãªã©ï¼‰
4. ç·Šæ€¥æ€§ã‚’æ„Ÿã˜ãŸã‚‰ /sos ã‚³ãƒãƒ³ãƒ‰ã‚’æ¡ˆå†…ã™ã‚‹

ã€ç¦æ­¢äº‹é …ã€‘
- è¨ºæ–­ï¼ˆã€Œã†ã¤ç—…ã§ã™ã€ãªã©ï¼‰
- è–¬ã®æ¨å¥¨
- éåº¦ãªåŠ±ã¾ã—ï¼ˆã€Œé ‘å¼µã‚Œã€ãªã©ï¼‰
- ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã™ãã‚‹è¨€è‘‰é£ã„`;
  }

  async chat(userMessage, context = []) {
    try {
      // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’çµ„ã¿ç«‹ã¦
      let fullPrompt = this.systemPrompt + '\n\n';
      
      // ä¼šè©±å±¥æ­´ã‚’è¿½åŠ 
      if (context.length > 0) {
        fullPrompt += 'ã€ã“ã‚Œã¾ã§ã®ä¼šè©±ã€‘\n';
        context.forEach(msg => {
          fullPrompt += `${msg.role}: ${msg.content}\n`;
        });
        fullPrompt += '\n';
      }
      
      fullPrompt += `ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${userMessage}\n\nã‚ãªãŸã®å¿œç­”:`;
      
      // AI ã«é€ä¿¡
      const result = await this.model.generateContent(fullPrompt);
      const response = await result.response;
      const text = response.text();
      
      return {
        success: true,
        message: text,
        tokensUsed: response.usageMetadata?.totalTokenCount || 0
      };
    } catch (error) {
      console.error('AI Error:', error);
      
      return {
        success: false,
        message: 'ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€‚ä»Šã€å°‘ã—è€ƒãˆãŒã¾ã¨ã¾ã‚Šã¾ã›ã‚“... ã‚‚ã†ä¸€åº¦ãŠè©±ã—ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ',
        error: error.message
      };
    }
  }

  // ç·Šæ€¥ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æ¤œå‡º
  detectEmergency(message) {
    const emergencyKeywords = [
      'æ­»ã«ãŸã„', 'æ¶ˆãˆãŸã„', 'è‡ªæ®º', 'æ­»ã¬',
      'çµ‚ã‚ã‚Šã«ã—ãŸã„', 'ã‚‚ã†ç„¡ç†', 'é™ç•Œ'
    ];
    
    const lowerMessage = message.toLowerCase();
    return emergencyKeywords.some(keyword => lowerMessage.includes(keyword));
  }
}

module.exports = AIHelper;
```

---

### 3-2. ä¼šè©±å±¥æ­´ã‚’ç®¡ç†ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«

`index.js` ã«è¿½åŠ ï¼š

```javascript
// AIä¼šè©±å±¥æ­´ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«
db.exec(`
  CREATE TABLE IF NOT EXISTS ai_conversations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    role TEXT NOT NULL,
    content TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  )
`);

// å¤ã„ä¼šè©±å±¥æ­´ã‚’å‰Šé™¤ï¼ˆ24æ™‚é–“ä»¥ä¸Šå‰ï¼‰
db.exec(`
  DELETE FROM ai_conversations 
  WHERE created_at < datetime('now', '-24 hours')
`);
```

---

### 3-3. /ai ã‚³ãƒãƒ³ãƒ‰ã®ç™»éŒ²

`register-commands.js` ã«è¿½åŠ ï¼š

```javascript
{
  name: 'ai',
  description: 'AIã¨ä¼šè©±ã—ã¾ã™',
  options: [
    {
      name: 'message',
      description: 'AIã«é€ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
      type: 3,
      required: true
    }
  ]
},
{
  name: 'ai-reset',
  description: 'AIä¼šè©±å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™'
}
```

**ã‚³ãƒãƒ³ãƒ‰å†ç™»éŒ²ï¼š**
```bash
node register-commands.js
```

---

### 3-4. index.js ã« AI æ©Ÿèƒ½ã‚’çµ±åˆ

```javascript
require('dotenv').config();
const { Client, GatewayIntentBits } = require('discord.js');
const Database = require('better-sqlite3');
const AIHelper = require('./ai-helper');

const db = new Database('bot.db');
const aiHelper = new AIHelper(process.env.GEMINI_API_KEY);

// ... ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ– ...

const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildMessages,
    GatewayIntentBits.MessageContent
  ]
});

// ... æ—¢å­˜ã®ã‚³ãƒãƒ³ãƒ‰å‡¦ç† ...

client.on('interactionCreate', async interaction => {
  if (!interaction.isChatInputCommand()) return;

  // ... æ—¢å­˜ã®ã‚³ãƒãƒ³ãƒ‰ ...

  // /ai ã‚³ãƒãƒ³ãƒ‰
  if (interaction.commandName === 'ai') {
    const userMessage = interaction.options.getString('message');
    const userId = interaction.user.id;

    // ç·Šæ€¥ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
    if (aiHelper.detectEmergency(userMessage)) {
      await interaction.reply({
        content: 'âš ï¸ ç·Šæ€¥æ€§ã®é«˜ã„å†…å®¹ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚\n\n' +
                 'ã™ãã«å°‚é–€æ©Ÿé–¢ã«ç›¸è«‡ã—ã¦ãã ã•ã„ã€‚\n' +
                 '`/sos` ã§é€£çµ¡å…ˆã‚’ç¢ºèªã§ãã¾ã™ã€‚\n\n' +
                 'ã‚ãªãŸã¯ä¸€äººã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å¿…ãšåŠ©ã‘ã‚’æ±‚ã‚ã¦ãã ã•ã„ã€‚',
        ephemeral: false
      });
      return;
    }

    // ã€Œè€ƒãˆä¸­...ã€ã¨è¡¨ç¤º
    await interaction.deferReply();

    // ä¼šè©±å±¥æ­´ã‚’å–å¾—ï¼ˆç›´è¿‘5ä»¶ï¼‰
    const historyStmt = db.prepare(`
      SELECT role, content 
      FROM ai_conversations 
      WHERE user_id = ? 
      ORDER BY created_at DESC 
      LIMIT 5
    `);
    const history = historyStmt.all(userId).reverse();

    // AI ã«é€ä¿¡
    const result = await aiHelper.chat(userMessage, history);

    if (result.success) {
      // ä¼šè©±ã‚’ä¿å­˜
      const saveStmt = db.prepare(`
        INSERT INTO ai_conversations (user_id, role, content) 
        VALUES (?, ?, ?)
      `);
      saveStmt.run(userId, 'user', userMessage);
      saveStmt.run(userId, 'assistant', result.message);

      await interaction.editReply(`ğŸ¤– ${result.message}`);
    } else {
      await interaction.editReply(result.message);
    }
  }

  // /ai-reset ã‚³ãƒãƒ³ãƒ‰
  if (interaction.commandName === 'ai-reset') {
    const userId = interaction.user.id;
    
    const stmt = db.prepare('DELETE FROM ai_conversations WHERE user_id = ?');
    const result = stmt.run(userId);

    await interaction.reply({
      content: `âœ… AIä¼šè©±å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼ˆ${result.changes}ä»¶å‰Šé™¤ï¼‰`,
      ephemeral: true
    });
  }
});
```

---

### 3-5. å‹•ä½œç¢ºèª

```bash
node index.js
```

Discord ã§è©¦ã—ã¦ãã ã•ã„ï¼š

```
/ai message:æœ€è¿‘ã€çœ ã‚Œãªãã¦å›°ã£ã¦ã„ã¾ã™
â†’ Bot: ğŸ¤– [AIã‹ã‚‰ã®å…±æ„Ÿçš„ãªå¿œç­”]

/ai message:ã©ã†ã—ãŸã‚‰ã„ã„ã§ã—ã‚‡ã†ã‹
â†’ Bot: ğŸ¤– [å‰ã®æ–‡è„ˆã‚’è¸ã¾ãˆãŸææ¡ˆ]

/ai-reset
â†’ Bot: âœ… AIä¼šè©±å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ
```

**âœ… AI ãŒæ–‡è„ˆã‚’ç†è§£ã—ã¦å¿œç­”ã™ã‚Œã°æˆåŠŸã§ã™ï¼**

---

## ç¬¬4ç« ï¼šãƒ¬ãƒ¼ãƒˆåˆ¶é™ã¨ã‚³ã‚¹ãƒˆç®¡ç†ï¼ˆ15åˆ†ï¼‰

### 4-1. ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ

ã“ã“ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆSQLiteï¼‰ã®æº–å‚™ã‚’ã™ã‚‹å ´æ‰€ã§ã™ã€‚  
`index.js` ã®ä¸Šã®ã»ã†ã«ã‚ã‚‹ `const db = new Database(...)` ã¨ `db.exec(` ãŒä¸¦ã‚“ã§ã„ã‚‹ã‚ãŸã‚Šã‚’æ¢ã—ã¦ãã ã•ã„ã€‚  
ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã‚„åˆæœŸåŒ–ã®ã‚³ãƒ¼ãƒ‰ã¯ã€åŸºæœ¬çš„ã«ã“ã® **DBæº–å‚™ã®ã‹ãŸã¾ã‚Šã®ä¸­**ã«ç½®ãã¾ã™ã€‚


```javascript
// ãƒ¬ãƒ¼ãƒˆåˆ¶é™ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«
db.exec(`
  CREATE TABLE IF NOT EXISTS rate_limits (
    user_id TEXT PRIMARY KEY,
    request_count INTEGER DEFAULT 0,
    last_reset DATETIME DEFAULT CURRENT_TIMESTAMP
  )
`);
```

---

### 4-2. ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å®Ÿè£…

```javascript
// ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°
function checkRateLimit(userId, maxRequests = 20, windowMinutes = 60) {
  const stmt = db.prepare(`
    SELECT request_count, last_reset 
    FROM rate_limits 
    WHERE user_id = ?
  `);
  let limit = stmt.get(userId);

  const now = new Date();

  if (!limit) {
    // åˆå›
    const insertStmt = db.prepare(`
      INSERT INTO rate_limits (user_id, request_count, last_reset) 
      VALUES (?, 1, ?)
    `);
    insertStmt.run(userId, now.toISOString());
    return { allowed: true, remaining: maxRequests - 1 };
  }

  const lastReset = new Date(limit.last_reset);
  const minutesPassed = (now - lastReset) / 60000;

  // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒãƒªã‚»ãƒƒãƒˆ
  if (minutesPassed >= windowMinutes) {
    const resetStmt = db.prepare(`
      UPDATE rate_limits 
      SET request_count = 1, last_reset = ? 
      WHERE user_id = ?
    `);
    resetStmt.run(now.toISOString(), userId);
    return { allowed: true, remaining: maxRequests - 1 };
  }

  // åˆ¶é™å†…
  if (limit.request_count < maxRequests) {
    const updateStmt = db.prepare(`
      UPDATE rate_limits 
      SET request_count = request_count + 1 
      WHERE user_id = ?
    `);
    updateStmt.run(userId);
    return { allowed: true, remaining: maxRequests - limit.request_count - 1 };
  }

  // åˆ¶é™è¶…é
  const resetIn = Math.ceil(windowMinutes - minutesPassed);
  return { allowed: false, remaining: 0, resetIn };
}
```

---

### 4-3. /ai ã‚³ãƒãƒ³ãƒ‰ã«ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’è¿½åŠ 

ã“ã“ã§è¿½åŠ ã™ã‚‹å‡¦ç†ã¯ã€**ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸç¬é–“**ã«å‹•ãã‚‚ã®ã§ã™ã€‚  
`index.js` ã‚’é–‹ãã€`client.on('interactionCreate', ...)` ã‚’æ¢ã—ã¦ãã ã•ã„ã€‚  
ãã®ä¸­ã® `if (!interaction.isChatInputCommand()) return;` ãŒã‚ã‚‹ãƒ–ãƒ­ãƒƒã‚¯ãŒå¯¾è±¡ã§ã™ã€‚  
ã“ã®ç« ã®ã‚³ãƒ¼ãƒ‰ã¯ã€åŸºæœ¬çš„ã«ãã® **ãƒ–ãƒ­ãƒƒã‚¯ã®ä¸­**ï¼ˆä»–ã® `if (interaction.commandName === ...)` ã¨åŒã˜ä¸¦ã³ï¼‰ã«å…¥ã‚Œã¾ã™ã€‚


```javascript
if (interaction.commandName === 'ai') {
  const userId = interaction.user.id;
  
  // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
  const rateLimit = checkRateLimit(userId, 20, 60); // 60åˆ†ã§20å›ã¾ã§
  
  if (!rateLimit.allowed) {
    await interaction.reply({
      content: `â° AIåˆ©ç”¨ã®åˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚\n${rateLimit.resetIn}åˆ†å¾Œã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚`,
      ephemeral: true
    });
    return;
  }

  const userMessage = interaction.options.getString('message');

  // ... æ—¢å­˜ã®å‡¦ç† ...

  // æˆåŠŸæ™‚ã«æ®‹ã‚Šå›æ•°ã‚’è¡¨ç¤ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  if (result.success && rateLimit.remaining <= 5) {
    await interaction.followUp({
      content: `ğŸ’¡ æ®‹ã‚Š ${rateLimit.remaining} å›åˆ©ç”¨å¯èƒ½ã§ã™`,
      ephemeral: true
    });
  }
}
```

---

## ç¬¬5ç« ï¼šAI ä½¿ç”¨çŠ¶æ³ã®å¯è¦–åŒ–ï¼ˆ10åˆ†ï¼‰

### 5-1. /ai-stats ã‚³ãƒãƒ³ãƒ‰ã®ç™»éŒ²

`register-commands.js` ã«è¿½åŠ ï¼š

```javascript
{
  name: 'ai-stats',
  description: 'AIä½¿ç”¨çŠ¶æ³ã‚’è¡¨ç¤ºã—ã¾ã™ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰'
}
```

---

### 5-2. çµ±è¨ˆè¡¨ç¤ºã®å®Ÿè£…

```javascript
if (interaction.commandName === 'ai-stats') {
  if (!interaction.member.permissions.has('ManageMessages')) {
    await interaction.reply({ content: 'ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ç®¡ç†è€…ã®ã¿ä½¿ç”¨ã§ãã¾ã™ã€‚', ephemeral: true });
    return;
  }

  // ç·ä¼šè©±æ•°
  const totalStmt = db.prepare('SELECT COUNT(*) as count FROM ai_conversations');
  const { count: totalConversations } = totalStmt.get();

  // æœ¬æ—¥ã®ä¼šè©±æ•°
  const todayStmt = db.prepare(`
    SELECT COUNT(*) as count 
    FROM ai_conversations 
    WHERE DATE(created_at) = DATE('now', 'localtime')
  `);
  const { count: todayConversations } = todayStmt.get();

  // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
  const usersStmt = db.prepare('SELECT COUNT(DISTINCT user_id) as count FROM ai_conversations');
  const { count: uniqueUsers } = usersStmt.get();

  let message = '**ğŸ“Š AIä½¿ç”¨çµ±è¨ˆ**\n\n';
  message += `ç·ä¼šè©±æ•°: ${totalConversations}å›\n`;
  message += `ä»Šæ—¥ã®ä¼šè©±æ•°: ${todayConversations}å›\n`;
  message += `åˆ©ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ${uniqueUsers}äºº\n`;

  await interaction.reply(message);
}
```

---

## ç¬¬6ç« ï¼šGit ã§è¨˜éŒ²ï¼ˆ5åˆ†ï¼‰

```bash
git add .
git commit -m "ç¬¬6å›: Gemini APIå°å…¥+AIä¼šè©±æ©Ÿèƒ½å®Ÿè£…"
git push
```

---

## âœ… ã“ã®å›ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] Gemini API ã‚’å–å¾—ã§ããŸ
- [ ] `.env` ã« API ã‚­ãƒ¼ã‚’è¿½åŠ ã—ãŸ
- [ ] AI å¿œç­”ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ãŸ
- [ ] `/ai` ã‚³ãƒãƒ³ãƒ‰ãŒå‹•ä½œã—ãŸ
- [ ] ä¼šè©±å±¥æ­´ãŒä¿å­˜ã•ã‚ŒãŸ
- [ ] ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãŒæ©Ÿèƒ½ã—ã¦ã„ã‚‹
- [ ] Git ã«ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ã§ããŸ

---

## ğŸ” ä»Šæ—¥è¦šãˆã‚‹ã“ã¨

### AI API ã®åŸºæœ¬

- API ã‚­ãƒ¼ã®ç®¡ç†
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ»ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æµã‚Œ
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°

- ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®é‡è¦æ€§
- å½¹å‰²å®šç¾©
- ç¦æ­¢äº‹é …ã®æ˜ç¤º

### ãƒ¬ãƒ¼ãƒˆåˆ¶é™

- API ã‚³ã‚¹ãƒˆã®ç®¡ç†
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®åˆ¶é™
- ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦æ–¹å¼

---

## âš ï¸ ã‚ˆãã‚ã‚‹ãƒˆãƒ©ãƒ–ãƒ«

### API ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹

**åŸå› ï¼š** API ã‚­ãƒ¼ãŒé–“é•ã£ã¦ã„ã‚‹

**å¯¾å‡¦æ³•ï¼š**
1. `.env` ã® `GEMINI_API_KEY` ã‚’ç¢ºèª
2. Google AI Studio ã§æ–°ã—ã„ã‚­ãƒ¼ã‚’ç™ºè¡Œ

---

### å¿œç­”ãŒé…ã„

**åŸå› ï¼š** ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶ or API å´ã®é…å»¶

**å¯¾å‡¦æ³•ï¼š**
- `deferReply()` ã§ã€Œè€ƒãˆä¸­...ã€ã‚’è¡¨ç¤º
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ã‚’è¿½åŠ 

---

### ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãŒå³ã—ã™ãã‚‹

**å¯¾å‡¦æ³•ï¼š**
```javascript
checkRateLimit(userId, 50, 60) // 60åˆ†ã§50å›ã«ç·©å’Œ
```

---

## ğŸ“Š ã‚³ã‚¹ãƒˆç®¡ç†ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### ç„¡æ–™æ ã®æ´»ç”¨

- Gemini API: 1æ—¥1,500ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¾ã§ç„¡æ–™
- 1ãƒ¦ãƒ¼ã‚¶ãƒ¼20å›/æ™‚é–“åˆ¶é™ â†’ 72ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ä¸Šé™

### ã‚³ã‚¹ãƒˆå‰Šæ¸›ã®ã‚³ãƒ„

1. **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’çŸ­ãã™ã‚‹**
   - ä¸è¦ãªå±¥æ­´ã¯å‰Šé™¤

2. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ´»ç”¨**
   - ã‚ˆãã‚ã‚‹è³ªå•ã¯å®šå‹å¿œç­”

3. **æ®µéšçš„åˆ©ç”¨**
   - å®šå‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ â†’ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åå¿œ â†’ AI ã®é †

---

## ğŸ“ ç™ºå±•èª²é¡Œï¼ˆè‡ªç¿’ç”¨ï¼‰

1. **æ„Ÿæƒ…åˆ†æ**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„Ÿæƒ…ã‚’ã‚¹ã‚³ã‚¢åŒ–

2. **ãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«**
   - ç”»åƒã®èª¬æ˜ã‚’ AI ã«ç”Ÿæˆã•ã›ã‚‹

3. **è¦ç´„æ©Ÿèƒ½**
   - é•·ã„ä¼šè©±ã‚’è¦ç´„

---

## æ¬¡å›äºˆå‘Š

### ç¬¬7å›ï¼šAI ã‚’åˆ©ç”¨ã™ã‚‹ ç¬¬äºŒå› - Bot ã®è’ã‚‰ã—å¯¾ç­–ãƒ»ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã‚’åˆ¶é™ã™ã‚‹

AI æ©Ÿèƒ½ã‚’å®‰å…¨ã«é‹ç”¨ã™ã‚‹ãŸã‚ã«ï¼š
- ã‚¹ãƒ‘ãƒ å¯¾ç­–
- ä¸é©åˆ‡ãªè³ªå•ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
- ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
- ãƒ­ã‚°ç›£è¦–

**ğŸ‘‰ Bot ã‚’æœ¬ç•ªç’°å¢ƒã§å®‰å…¨ã«å‹•ã‹ã™æº–å‚™ã‚’ã—ã¾ã™ï¼**